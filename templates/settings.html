{% extends "base.html" %}
{% import "macros.html" as macros %}
{# settings.html #}
{# Version: 1.3.0 #}
{# Note: Added theme, name, and title settings. #}

{% block content %}

    <h1>Settings</h1>

    {% if is_master %}
        <h2>Voting Thresholds</h2>
        <form action="{{ url_for('admin_settings') }}" method="POST" id="votingThresholdsForm">
            {{ thresholds_form.csrf_token(id='thresholds_csrf_token') }}
            <div class="row">
                <div class="col-md-6">
                    <h3>Positive Thresholds</h3>
                      {{ macros.render_field(thresholds_form.pos_threshold_1, id='pos_threshold_1', label_text='Threshold 1 (%)', class='form-control', type='number', required=True, value=thresholds_form.pos_threshold_1.data) }}
                      {{ macros.render_field(thresholds_form.pos_points_1, id='pos_points_1', label_text='Points 1', class='form-control', type='number', required=True, value=thresholds_form.pos_points_1.data) }}
                      {{ macros.render_field(thresholds_form.pos_threshold_2, id='pos_threshold_2', label_text='Threshold 2 (%)', class='form-control', type='number', required=True, value=thresholds_form.pos_threshold_2.data) }}
                      {{ macros.render_field(thresholds_form.pos_points_2, id='pos_points_2', label_text='Points 2', class='form-control', type='number', required=True, value=thresholds_form.pos_points_2.data) }}
                      {{ macros.render_field(thresholds_form.pos_threshold_3, id='pos_threshold_3', label_text='Threshold 3 (%)', class='form-control', type='number', required=True, value=thresholds_form.pos_threshold_3.data) }}
                      {{ macros.render_field(thresholds_form.pos_points_3, id='pos_points_3', label_text='Points 3', class='form-control', type='number', required=True, value=thresholds_form.pos_points_3.data) }}
                </div>
                <div class="col-md-6">
                    <h3>Negative Thresholds</h3>
                      {{ macros.render_field(thresholds_form.neg_threshold_1, id='neg_threshold_1', label_text='Threshold 1 (%)', class='form-control', type='number', required=True, value=thresholds_form.neg_threshold_1.data) }}
                      {{ macros.render_field(thresholds_form.neg_points_1, id='neg_points_1', label_text='Points 1', class='form-control', type='number', required=True, value=thresholds_form.neg_points_1.data) }}
                      {{ macros.render_field(thresholds_form.neg_threshold_2, id='neg_threshold_2', label_text='Threshold 2 (%)', class='form-control', type='number', required=True, value=thresholds_form.neg_threshold_2.data) }}
                      {{ macros.render_field(thresholds_form.neg_points_2, id='neg_points_2', label_text='Points 2', class='form-control', type='number', required=True, value=thresholds_form.neg_points_2.data) }}
                      {{ macros.render_field(thresholds_form.neg_threshold_3, id='neg_threshold_3', label_text='Threshold 3 (%)', class='form-control', type='number', required=True, value=thresholds_form.neg_threshold_3.data) }}
                      {{ macros.render_field(thresholds_form.neg_points_3, id='neg_points_3', label_text='Points 3', class='form-control', type='number', required=True, value=thresholds_form.neg_points_3.data) }}
                </div>
            </div>
            {{ macros.render_submit_button('Update Voting Thresholds', class='btn btn-primary') }}
        </form>
        
        <h2>Vote Limits</h2>
        <form action="{{ url_for('admin_settings') }}" method="POST" id="voteLimitsForm">
            {{ vote_limits_form.csrf_token(id='vote_limits_csrf_token') }}
            {{ macros.render_field(vote_limits_form.max_total_votes, id='max_total_votes', label_text='Max Total Votes', class='form-control', type='number', required=True, value=vote_limits_form.max_total_votes.data) }}
            {{ macros.render_field(vote_limits_form.max_plus_votes, id='max_plus_votes_limit', label_text='Max Positive Votes', class='form-control', type='number', required=True, value=vote_limits_form.max_plus_votes.data) }}
            {{ macros.render_field(vote_limits_form.max_minus_votes, id='max_minus_votes_limit', label_text='Max Negative Votes', class='form-control', type='number', required=True, value=vote_limits_form.max_minus_votes.data) }}
            {{ macros.render_submit_button('Update Vote Limits', class='btn btn-primary') }}
        </form>

        <h2>Role Vote Weights</h2>
        <form action="{{ url_for('admin_settings') }}" method="POST" id="roleWeightsForm">
            {{ macros.render_csrf_token(id='role_weights_csrf_token') }}
            <table class="table">
                <thead>
                    <tr>
                        <th>Role</th>
                        <th>Weight</th>
                    </tr>
                </thead>
                <tbody>
                    {% for role in roles %}
                    <tr>
                        <td>{{ role }}</td>
                        <td>
                            <input type="number" step="0.1" min="0" name="role_weight_{{ role }}" class="form-control" value="{{ role_weights.get(role, 1) }}">
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {{ macros.render_submit_button('Update Role Weights', class='btn btn-primary') }}
        </form>

        <h2>Reporting Settings</h2>
        <form action="{{ url_for('admin_settings') }}" method="POST" id="reportingSettingsForm">
            {{ macros.render_csrf_token(id='reporting_settings_csrf_token') }}
            <div class="mb-3">
                <label for="month_mode" class="form-label">Month Mode</label>
                <select name="month_mode" id="month_mode" class="form-control">
                    <option value="4_week" {% if month_mode == '4_week' %}selected{% endif %}>4 Week Months</option>
                    <option value="calendar" {% if month_mode == 'calendar' %}selected{% endif %}>Calendar Months</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="week_start_day" class="form-label">Week Starts On</label>
                <select name="week_start_day" id="week_start_day" class="form-control">
                    {% for day in ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'] %}
                        <option value="{{ day }}" {% if week_start_day == day %}selected{% endif %}>{{ day }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-3">
                <label for="auto_vote_day" class="form-label">Auto Open Voting Day</label>
                <select name="auto_vote_day" id="auto_vote_day" class="form-control">
                    <option value="" {% if not auto_vote_day %}selected{% endif %}>Disabled</option>
                    {% for day in ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'] %}
                        <option value="{{ day }}" {% if auto_vote_day == day %}selected{% endif %}>{{ day }}</option>
                    {% endfor %}
                </select>
            </div>
            {{ macros.render_submit_button('Update Reporting Settings', class='btn btn-primary') }}
        </form>

        <h2>Theme Settings</h2>
        <form action="{{ url_for('admin_settings') }}" method="POST" id="themeSettingsForm">
            {{ macros.render_csrf_token(id='theme_settings_csrf_token') }}
            <div class="mb-3">
                <label for="site_name" class="form-label">Site Name</label>
                <input type="text" name="site_name" id="site_name" class="form-control" value="{{ settings.get('site_name', 'A1 Rent-It') }}">
            </div>
            <div class="mb-3">
                <label for="site_title" class="form-label">Site Title</label>
                <input type="text" name="site_title" id="site_title" class="form-control" value="{{ settings.get('site_title', 'A1 Rent-It') }}">
            </div>
            <div class="mb-3">
                <label for="primary_color" class="form-label">Primary Color</label>
                <input type="color" name="primary_color" id="primary_color" class="form-control form-control-color" value="{{ settings.get('primary_color', '#D4AF37') }}">
            </div>
            <div class="mb-3">
                <label for="secondary_color" class="form-label">Secondary Color</label>
                <input type="color" name="secondary_color" id="secondary_color" class="form-control form-control-color" value="{{ settings.get('secondary_color', '#000000') }}">
            </div>
            <div class="mb-3">
                <label for="background_color" class="form-label">Background Color</label>
                <input type="color" name="background_color" id="background_color" class="form-control form-control-color" value="{{ settings.get('background_color', '#3A3A3A') }}">
            </div>
            <div class="mb-3">
                <label for="surface_color" class="form-label">Surface Color</label>
                <input type="color" name="surface_color" id="surface_color" class="form-control form-control-color" value="{{ settings.get('surface_color', '#222222') }}">
            </div>
            <div class="mb-3">
                <label for="surface_alt_color" class="form-label">Alternate Surface Color</label>
                <input type="color" name="surface_alt_color" id="surface_alt_color" class="form-control form-control-color" value="{{ settings.get('surface_alt_color', '#1A1A1A') }}">
            </div>
            <button type="submit" name="theme_settings" class="btn btn-primary">Update Theme</button>
        </form>

        <h2>Other Settings</h2>
        <form action="{{ url_for('admin_settings') }}" method="POST" id="settingsForm">
            {{ macros.render_csrf_token(id='settings_csrf_token') }}
            <div class="mb-3">
                <label for="settings_key" class="form-label">Setting Key</label>
                <input type="text" name="key" id="settings_key" class="form-control" required>
            </div>
            <div class="mb-3">
                <label for="settings_value" class="form-label">Value</label>
                <input type="text" name="value" id="settings_value" class="form-control" required>
            </div>
            {{ macros.render_submit_button('Update Setting', class='btn btn-primary') }}
        </form>

        <h2>Current Settings</h2>
        <table class="table">
            <thead>
                <tr>
                    <th>Key</th>
                    <th>Value</th>
                </tr>
            </thead>
            <tbody>
                {% for key, value in settings.items() %}
                    <tr>
                        <td>{{ key }}</td>
                        <td>{{ value }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>

        <h2>Data Import/Export</h2>
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Export Complete Database</h5>
                    </div>
                    <div class="card-body">
                        <p>Export all database tables and schema to a comprehensive JSON file for backup or migration purposes.</p>
                        <a href="{{ url_for('export_data') }}" class="btn btn-primary">
                            <i class="fas fa-download"></i> Export Complete Data
                        </a>
                        <small class="form-text text-muted mt-2">
                            JSON format preserves all data types, relationships, and schema information without corruption.
                        </small>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Import Database from CSV</h5>
                    </div>
                    <div class="card-body">
                        <p>Import data from a CSV file. This will update existing records with matching IDs.</p>
                        <form action="{{ url_for('import_csv') }}" method="POST" enctype="multipart/form-data">
                            {{ macros.render_csrf_token(id='import_csv_csrf_token') }}
                            <div class="mb-3">
                                <label for="csv_file" class="form-label">Select CSV File</label>
                                <input type="file" name="csv_file" id="csv_file" class="form-control" accept=".csv" required>
                            </div>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-upload"></i> Import from CSV
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <h2>Master Reset</h2>
        <form id="masterResetFormUnique" action="{{ url_for('admin_master_reset') }}" method="POST" class="mb-4">
            {{ macros.render_csrf_token(id='master_reset_csrf_token') }}
            {{ macros.render_field(master_reset_form.password, id='master_reset_password', label_text='Master Password', class='form-control', type='password', required=True, value=master_reset_form.password.data if master_reset_form.password.data else '') }}
            {{ macros.render_submit_button('Master Reset', class='btn btn-danger') }}
        </form>

        <h2>Backup Management</h2>
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Backup Settings</h5>
                    </div>
                    <div class="card-body">
                        <form action="{{ url_for('admin_settings') }}" method="POST">
                            {{ macros.render_csrf_token(id='backup_settings_csrf_token') }}
                            <div class="mb-3">
                                <div class="form-check">
                                    <input type="checkbox" name="backup_enabled" id="backup_enabled" class="form-check-input" 
                                           {% if backup_enabled == '1' %}checked{% endif %}>
                                    <label for="backup_enabled" class="form-check-label">Enable automatic nightly backups</label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="backup_retention_days" class="form-label">Backup Retention (Days)</label>
                                <input type="number" name="backup_retention_days" id="backup_retention_days" 
                                       class="form-control" min="1" max="365" value="{{ backup_retention_days }}">
                                <small class="form-text text-muted">Number of days to keep backup files (1-365)</small>
                            </div>
                            <div class="mb-3">
                                <small class="text-muted">Last backup: {{ last_backup_run }}</small>
                            </div>
                            <button type="submit" name="backup_settings" class="btn btn-primary">Update Backup Settings</button>
                        </form>
                        <hr>
                        <form action="{{ url_for('create_backup') }}" method="POST" class="d-inline">
                            {{ macros.render_csrf_token(id='manual_backup_csrf_token') }}
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> Create Manual Backup
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Available Backups</h5>
                    </div>
                    <div class="card-body">
                        {% if backup_files %}
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Size</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for backup in backup_files[:10] %}
                                        <tr>
                                            <td>
                                                <small>{{ backup.modified.strftime('%Y-%m-%d %H:%M') }}</small>
                                            </td>
                                            <td>
                                                <small>{{ "%.1f"|format(backup.size / 1024) }} KB</small>
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <a href="{{ url_for('download_backup', filename=backup.filename) }}" 
                                                       class="btn btn-outline-primary btn-sm" title="Download">
                                                        <i class="fas fa-download"></i>
                                                    </a>
                                                    <form action="{{ url_for('delete_backup', filename=backup.filename) }}" 
                                                          method="POST" class="d-inline" 
                                                          onsubmit="return confirm('Delete backup {{ backup.filename }}?')">
                                                        {{ macros.render_csrf_token(id='delete_backup_csrf_token_' + loop.index|string) }}
                                                        <button type="submit" class="btn btn-outline-danger btn-sm" title="Delete">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </form>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% if backup_files|length > 10 %}
                                <small class="text-muted">Showing 10 most recent backups of {{ backup_files|length }} total</small>
                            {% endif %}
                        {% else %}
                            <p class="text-muted">No backup files found</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

    {% else %}
        <p>Access restricted to master admin.</p>
    {% endif %}

    {% if get_flashed_messages() %}
        {% for category, message in get_flashed_messages(with_categories=true) %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

{% endblock %}