{% extends "base.html" %}
{% import "macros.html" as macros %}
{# settings.html #}
{# Version: 1.3.1 #}
{# Note: Added scoreboard timing controls to settings. #}

{% block content %}

    <h1>Settings</h1>

    {% if is_master %}
        <h2>Voting Thresholds</h2>
        <form action="{{ url_for('admin_settings') }}" method="POST" id="votingThresholdsForm">
            {{ thresholds_form.csrf_token(id='thresholds_csrf_token') }}
            <div class="row">
                <div class="col-md-6">
                    <h3>Positive Thresholds</h3>
                      {{ macros.render_field(thresholds_form.pos_threshold_1, id='pos_threshold_1', label_text='Threshold 1 (%)', class='form-control', type='number', required=True, value=thresholds_form.pos_threshold_1.data) }}
                      {{ macros.render_field(thresholds_form.pos_points_1, id='pos_points_1', label_text='Points 1', class='form-control', type='number', required=True, value=thresholds_form.pos_points_1.data) }}
                      {{ macros.render_field(thresholds_form.pos_threshold_2, id='pos_threshold_2', label_text='Threshold 2 (%)', class='form-control', type='number', required=True, value=thresholds_form.pos_threshold_2.data) }}
                      {{ macros.render_field(thresholds_form.pos_points_2, id='pos_points_2', label_text='Points 2', class='form-control', type='number', required=True, value=thresholds_form.pos_points_2.data) }}
                      {{ macros.render_field(thresholds_form.pos_threshold_3, id='pos_threshold_3', label_text='Threshold 3 (%)', class='form-control', type='number', required=True, value=thresholds_form.pos_threshold_3.data) }}
                      {{ macros.render_field(thresholds_form.pos_points_3, id='pos_points_3', label_text='Points 3', class='form-control', type='number', required=True, value=thresholds_form.pos_points_3.data) }}
                </div>
                <div class="col-md-6">
                    <h3>Negative Thresholds</h3>
                      {{ macros.render_field(thresholds_form.neg_threshold_1, id='neg_threshold_1', label_text='Threshold 1 (%)', class='form-control', type='number', required=True, value=thresholds_form.neg_threshold_1.data) }}
                      {{ macros.render_field(thresholds_form.neg_points_1, id='neg_points_1', label_text='Points 1', class='form-control', type='number', required=True, value=thresholds_form.neg_points_1.data) }}
                      {{ macros.render_field(thresholds_form.neg_threshold_2, id='neg_threshold_2', label_text='Threshold 2 (%)', class='form-control', type='number', required=True, value=thresholds_form.neg_threshold_2.data) }}
                      {{ macros.render_field(thresholds_form.neg_points_2, id='neg_points_2', label_text='Points 2', class='form-control', type='number', required=True, value=thresholds_form.neg_points_2.data) }}
                      {{ macros.render_field(thresholds_form.neg_threshold_3, id='neg_threshold_3', label_text='Threshold 3 (%)', class='form-control', type='number', required=True, value=thresholds_form.neg_threshold_3.data) }}
                      {{ macros.render_field(thresholds_form.neg_points_3, id='neg_points_3', label_text='Points 3', class='form-control', type='number', required=True, value=thresholds_form.neg_points_3.data) }}
                </div>
            </div>
            {{ macros.render_submit_button('Update Voting Thresholds', class='btn btn-primary') }}
        </form>
        
        <h2>Vote Limits</h2>
        <form action="{{ url_for('admin_settings') }}" method="POST" id="voteLimitsForm">
            {{ vote_limits_form.csrf_token(id='vote_limits_csrf_token') }}
            {{ macros.render_field(vote_limits_form.max_total_votes, id='max_total_votes', label_text='Max Total Votes', class='form-control', type='number', required=True, value=vote_limits_form.max_total_votes.data) }}
            {{ macros.render_field(vote_limits_form.max_plus_votes, id='max_plus_votes_limit', label_text='Max Positive Votes', class='form-control', type='number', required=True, value=vote_limits_form.max_plus_votes.data) }}
            {{ macros.render_field(vote_limits_form.max_minus_votes, id='max_minus_votes_limit', label_text='Max Negative Votes', class='form-control', type='number', required=True, value=vote_limits_form.max_minus_votes.data) }}
            {{ macros.render_submit_button('Update Vote Limits', class='btn btn-primary') }}
        </form>

        <h2>Scoreboard Settings</h2>
        <form action="{{ url_for('admin_settings') }}" method="POST" id="scoreboardSettingsForm">
            {{ macros.render_csrf_token(id='scoreboard_settings_csrf_token') }}
            {{ macros.render_field(scoreboard_form.money_threshold, id='money_threshold_setting', label_text='In The Money Threshold', class='form-control', type='number', required=True, value=scoreboard_form.money_threshold.data) }}
            {{ macros.render_field(scoreboard_form.top_color, id='top_color_setting', label_text='Top Color', class='form-control form-control-color', type='color', value=scoreboard_form.top_color.data) }}
            {{ macros.render_field(scoreboard_form.mid_color, id='mid_color_setting', label_text='Middle Color', class='form-control form-control-color', type='color', value=scoreboard_form.mid_color.data) }}
            {{ macros.render_field(scoreboard_form.bottom_color, id='bottom_color_setting', label_text='Bottom Color', class='form-control form-control-color', type='color', value=scoreboard_form.bottom_color.data) }}
            {{ macros.render_field(scoreboard_form.reel_color, id='reel_color_setting', label_text='Reel Color', class='form-control form-control-color', type='color', value=scoreboard_form.reel_color.data) }}
            {{ macros.render_field(scoreboard_form.spin_duration, id='spin_duration_setting', label_text='Spin Duration (s)', class='form-control', type='number', required=True, value=scoreboard_form.spin_duration.data) }}
            {{ macros.render_field(scoreboard_form.spin_iterations, id='spin_iterations_setting', label_text='Spin Iterations (0=infinite)', class='form-control', type='number', required=True, value=scoreboard_form.spin_iterations.data) }}
            {{ macros.render_field(scoreboard_form.spin_pause, id='spin_pause_setting', label_text='Spin Pause (s)', class='form-control', type='number', required=True, value=scoreboard_form.spin_pause.data) }}
            {{ macros.render_field(scoreboard_form.spin_delay, id='spin_delay_setting', label_text='Spin Start Delay (s)', class='form-control', type='number', required=True, value=scoreboard_form.spin_delay.data) }}
            {{ macros.render_field(scoreboard_form.refresh_interval, id='refresh_interval_setting', label_text='Refresh Interval (s)', class='form-control', type='number', required=True, value=scoreboard_form.refresh_interval.data) }}
            {{ macros.render_submit_button('Update Scoreboard Settings', class='btn btn-primary') }}
        </form>

        <h2>Role Vote Weights</h2>
        <form action="{{ url_for('admin_settings') }}" method="POST" id="roleWeightsForm">
            {{ macros.render_csrf_token(id='role_weights_csrf_token') }}
            <table class="table">
                <thead>
                    <tr>
                        <th>Role</th>
                        <th>Weight</th>
                    </tr>
                </thead>
                <tbody>
                    {% for role in roles %}
                    <tr>
                        <td>{{ role }}</td>
                        <td>
                            <input type="number" step="0.1" min="0" name="role_weight_{{ role }}" class="form-control" value="{{ role_weights.get(role, 1) }}">
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {{ macros.render_submit_button('Update Role Weights', class='btn btn-primary') }}
        </form>

        <h2>Reporting Settings</h2>
        <form action="{{ url_for('admin_settings') }}" method="POST" id="reportingSettingsForm">
            {{ macros.render_csrf_token(id='reporting_settings_csrf_token') }}
            <div class="mb-3">
                <label for="month_mode" class="form-label">Month Mode</label>
                <select name="month_mode" id="month_mode" class="form-control">
                    <option value="4_week" {% if month_mode == '4_week' %}selected{% endif %}>4 Week Months</option>
                    <option value="calendar" {% if month_mode == 'calendar' %}selected{% endif %}>Calendar Months</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="week_start_day" class="form-label">Week Starts On</label>
                <select name="week_start_day" id="week_start_day" class="form-control">
                    {% for day in ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'] %}
                        <option value="{{ day }}" {% if week_start_day == day %}selected{% endif %}>{{ day }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-3">
                <label for="auto_vote_day" class="form-label">Auto Open Voting Day</label>
                <select name="auto_vote_day" id="auto_vote_day" class="form-control">
                    <option value="" {% if not auto_vote_day %}selected{% endif %}>Disabled</option>
                    {% for day in ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'] %}
                        <option value="{{ day }}" {% if auto_vote_day == day %}selected{% endif %}>{{ day }}</option>
                    {% endfor %}
                </select>
            </div>
            {{ macros.render_submit_button('Update Reporting Settings', class='btn btn-primary') }}
        </form>

        <h2>Theme Settings</h2>
        <form action="{{ url_for('admin_settings') }}" method="POST" id="themeSettingsForm">
            {{ macros.render_csrf_token(id='theme_settings_csrf_token') }}
            <div class="mb-3">
                <label for="site_name" class="form-label">Site Name</label>
                <input type="text" name="site_name" id="site_name" class="form-control" value="{{ settings.get('site_name', 'A1 Rent-It') }}">
            </div>
            <div class="mb-3">
                <label for="site_title" class="form-label">Site Title</label>
                <input type="text" name="site_title" id="site_title" class="form-control" value="{{ settings.get('site_title', 'A1 Rent-It') }}">
            </div>
            <div class="mb-3">
                <label for="banner_text" class="form-label">Banner Text</label>
                <input type="text" name="banner_text" id="banner_text" class="form-control" value="{{ settings.get('banner_text', "JACKPOT TIME! GIVE 'EM THE MONEY! SLOTS SPINNING - WINNERS GRINNING!") }}">
            </div>
            <div class="mb-3">
                <label for="primary_color" class="form-label">Primary Color</label>
                <input type="color" name="primary_color" id="primary_color" class="form-control form-control-color" value="{{ settings.get('primary_color', '#D4AF37') }}">
            </div>
            <div class="mb-3">
                <label for="secondary_color" class="form-label">Secondary Color</label>
                <input type="color" name="secondary_color" id="secondary_color" class="form-control form-control-color" value="{{ settings.get('secondary_color', '#000000') }}">
            </div>
            <div class="mb-3">
                <label for="background_color" class="form-label">Background Color</label>
                <input type="color" name="background_color" id="background_color" class="form-control form-control-color" value="{{ settings.get('background_color', '#3A3A3A') }}">
            </div>
            <div class="mb-3">
                <label for="surface_color" class="form-label">Surface Color</label>
                <input type="color" name="surface_color" id="surface_color" class="form-control form-control-color" value="{{ settings.get('surface_color', '#222222') }}">
            </div>
            <div class="mb-3">
                <label for="surface_alt_color" class="form-label">Alternate Surface Color</label>
                <input type="color" name="surface_alt_color" id="surface_alt_color" class="form-control form-control-color" value="{{ settings.get('surface_alt_color', '#1A1A1A') }}">
            </div>
            <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" id="strobe_mode" name="strobe_mode" value="on" {% if settings.get('strobe_mode', 'on') == 'on' %}checked{% endif %}>
                <label class="form-check-label" for="strobe_mode">Enable Strobe Effect on Main Page</label>
            </div>
            <button type="submit" name="theme_settings" class="btn btn-primary">Update Theme</button>
        </form>

        <h2>Server Port</h2>
        <form action="{{ url_for('admin_settings') }}" method="POST" id="portForm">
            {{ macros.render_csrf_token(id='port_csrf_token') }}
            {{ macros.render_field(port_form.port, id='port_setting', label_text='Port', class='form-control', type='number', required=True, value=port_form.port.data) }}
            {{ macros.render_submit_button('Update Port', class='btn btn-primary') }}
        </form>

        <h2>Service Control</h2>
        <form action="{{ url_for('admin_restart_service') }}" method="POST" class="mb-2">
            {{ macros.render_csrf_token(id='restart_service_csrf_token') }}
            {{ macros.render_submit_button('Restart Service', class='btn btn-warning') }}
        </form>
        <form action="{{ url_for('admin_reboot_pi') }}" method="POST">
            {{ macros.render_csrf_token(id='reboot_pi_csrf_token') }}
            {{ macros.render_submit_button('Reboot Pi', class='btn btn-danger') }}
        </form>

        <h2>Mini-Game Settings</h2>
        <form action="{{ url_for('admin_settings') }}" method="POST" id="miniGameSettingsForm">
            {{ macros.render_csrf_token(id='mini_game_settings_csrf_token') }}
            
            <div class="row">
                <div class="col-md-6">
                    <h4>Award Chances (%)</h4>
                    <div class="mb-3">
                        <label for="award_chance_points" class="form-label">Award Chance on Points Adjustment</label>
                        <input type="number" name="award_chance_points" id="award_chance_points" class="form-control" 
                               min="0" max="100" value="{{ mini_game_config.award_chance_points|default(10) }}">
                        <div class="form-text">Percentage chance to award a mini-game when points are adjusted</div>
                    </div>
                    <div class="mb-3">
                        <label for="award_chance_vote" class="form-label">Award Chance on Vote</label>
                        <input type="number" name="award_chance_vote" id="award_chance_vote" class="form-control" 
                               min="0" max="100" value="{{ mini_game_config.award_chance_vote|default(15) }}">
                        <div class="form-text">Percentage chance to award a mini-game when voting</div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <h4>Prize Settings</h4>
                    <div class="mb-3">
                        <label for="points_prize_amount" class="form-label">Points Prize Amount</label>
                        <input type="number" name="points_prize_amount" id="points_prize_amount" class="form-control" 
                               min="1" value="{{ mini_game_config.prizes.points.amount|default(5) }}">
                    </div>
                    <div class="mb-3">
                        <label for="points_prize_chance" class="form-label">Points Prize Chance (%)</label>
                        <input type="number" name="points_prize_chance" id="points_prize_chance" class="form-control" 
                               min="0" max="100" value="{{ mini_game_config.prizes.points.chance|default(20) }}">
                    </div>
                    
                    <div class="mb-3">
                        <label for="gift_card_value" class="form-label">Gift Card Value ($)</label>
                        <input type="number" name="gift_card_value" id="gift_card_value" class="form-control" 
                               min="1" value="{{ mini_game_config.prizes.prize1.value|default(25) }}">
                    </div>
                    <div class="mb-3">
                        <label for="gift_card_chance" class="form-label">Gift Card Chance (%)</label>
                        <input type="number" name="gift_card_chance" id="gift_card_chance" class="form-control" 
                               min="0" max="100" value="{{ mini_game_config.prizes.prize1.chance|default(10) }}">
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-12">
                    <h4>Other Prizes</h4>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="prize2_desc" class="form-label">Prize 2 Description</label>
                                <input type="text" name="prize2_desc" id="prize2_desc" class="form-control" 
                                       value="{{ mini_game_config.prizes.prize2.desc|default('Extra Break') }}">
                            </div>
                            <div class="mb-3">
                                <label for="prize2_chance" class="form-label">Prize 2 Chance (%)</label>
                                <input type="number" name="prize2_chance" id="prize2_chance" class="form-control" 
                                       min="0" max="100" value="{{ mini_game_config.prizes.prize2.chance|default(30) }}">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="prize3_desc" class="form-label">Prize 3 Description</label>
                                <input type="text" name="prize3_desc" id="prize3_desc" class="form-control" 
                                       value="{{ mini_game_config.prizes.prize3.desc|default('Company Swag') }}">
                            </div>
                            <div class="mb-3">
                                <label for="prize3_value" class="form-label">Prize 3 Value ($)</label>
                                <input type="number" name="prize3_value" id="prize3_value" class="form-control" 
                                       min="0" value="{{ mini_game_config.prizes.prize3.value|default(10) }}">
                            </div>
                            <div class="mb-3">
                                <label for="prize3_chance" class="form-label">Prize 3 Chance (%)</label>
                                <input type="number" name="prize3_chance" id="prize3_chance" class="form-control" 
                                       min="0" max="100" value="{{ mini_game_config.prizes.prize3.chance|default(5) }}">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <button type="submit" name="mini_game_settings" class="btn btn-primary">Update Mini-Game Settings</button>
        </form>

        <h2>System Settings</h2>
        <form action="{{ url_for('admin_settings') }}" method="POST" id="systemSettingsForm">
            {{ macros.render_csrf_token(id='system_settings_csrf_token') }}
            
            <div class="mb-3">
                <label for="program_end_date" class="form-label">Program End Date</label>
                <input type="date" name="program_end_date" id="program_end_date" class="form-control" 
                       value="{{ settings.get('program_end_date', '') }}">
                <div class="form-text">Leave blank for no end date</div>
            </div>
            
            <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" id="sound_on" name="sound_on" value="1" 
                       {% if settings.get('sound_on', '1') == '1' %}checked{% endif %}>
                <label class="form-check-label" for="sound_on">Enable Sound Effects</label>
            </div>
            
            <h4>Admin Section Permissions</h4>
            <div class="mb-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="allow_rules" name="allow_section_rules" value="1" 
                           {% if settings.get('allow_section_rules', '0') == '1' %}checked{% endif %}>
                    <label class="form-check-label" for="allow_rules">Allow Rules Management</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="allow_manage_roles" name="allow_section_manage_roles" value="1" 
                           {% if settings.get('allow_section_manage_roles', '0') == '1' %}checked{% endif %}>
                    <label class="form-check-label" for="allow_manage_roles">Allow Role Management</label>
                </div>
            </div>
            
            <button type="submit" name="system_settings" class="btn btn-primary">Update System Settings</button>
        </form>

        <h2>Advanced Settings</h2>
        <p class="text-muted">For advanced configuration, modify settings directly by key-value pair.</p>
        <form action="{{ url_for('admin_settings') }}" method="POST" id="advancedSettingsForm">
            {{ macros.render_csrf_token(id='advanced_settings_csrf_token') }}
            <div class="mb-3">
                <label for="settings_key" class="form-label">Setting Key</label>
                <select name="key" id="settings_key" class="form-control" onchange="populateSettingValue()">
                    <option value="">Select a setting...</option>
                    <option value="voting_thresholds">Voting Thresholds (JSON)</option>
                    <option value="program_end_date">Program End Date</option>
                    <option value="last_decay_run">Last Decay Run</option>
                    <option value="max_total_votes">Max Total Votes</option>
                    <option value="max_plus_votes">Max Plus Votes</option>
                    <option value="max_minus_votes">Max Minus Votes</option>
                    <option value="site_name">Site Name</option>
                    <option value="site_title">Site Title</option>
                    <option value="banner_text">Banner Text</option>
                    <option value="primary_color">Primary Color</option>
                    <option value="secondary_color">Secondary Color</option>
                    <option value="background_color">Background Color</option>
                    <option value="surface_color">Surface Color</option>
                    <option value="surface_alt_color">Surface Alt Color</option>
                    <option value="strobe_mode">Strobe Mode</option>
                    <option value="sound_on">Sound On</option>
                    <option value="port">Port</option>
                    <option value="mini_game_settings">Mini Game Settings (JSON)</option>
                    <option value="allow_section_rules">Allow Section Rules</option>
                    <option value="allow_section_manage_roles">Allow Section Manage Roles</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="settings_value" class="form-label">Value</label>
                <textarea name="value" id="settings_value" class="form-control" rows="3" placeholder="Setting value will appear here..."></textarea>
                <div class="form-text">Current value: <span id="current_value_display">Select a setting to see current value</span></div>
            </div>
            {{ macros.render_submit_button('Update Advanced Setting', class='btn btn-warning') }}
        </form>

        <h2>Current Settings</h2>
        <table class="table">
            <thead>
                <tr>
                    <th>Key</th>
                    <th>Value</th>
                </tr>
            </thead>
            <tbody>
                {% for key, value in settings.items() %}
                    <tr>
                        <td>{{ key }}</td>
                        <td>{{ value }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>

        <h2>Master Reset</h2>
        <form id="masterResetFormUnique" action="{{ url_for('admin_master_reset') }}" method="POST" class="mb-4">
            {{ macros.render_csrf_token(id='master_reset_csrf_token') }}
            {{ macros.render_field(master_reset_form.password, id='master_reset_password', label_text='Master Password', class='form-control', type='password', required=True, value=master_reset_form.password.data if master_reset_form.password.data else '') }}
            {{ macros.render_submit_button('Master Reset', class='btn btn-danger') }}
        </form>
    {% else %}
        <p>Access restricted to master admin.</p>
    {% endif %}

    {% if get_flashed_messages() %}
        {% for category, message in get_flashed_messages(with_categories=true) %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

<script>
// Settings data for JavaScript
const settingsData = {{ settings | tojson }};

// Function to populate setting value when dropdown changes
function populateSettingValue() {
    const selectEl = document.getElementById('settings_key');
    const valueEl = document.getElementById('settings_value');
    const displayEl = document.getElementById('current_value_display');
    
    const selectedKey = selectEl.value;
    
    if (selectedKey && settingsData[selectedKey] !== undefined) {
        const currentValue = settingsData[selectedKey];
        valueEl.value = currentValue;
        
        // Show formatted current value
        if (selectedKey.includes('_settings') && currentValue.startsWith('{')) {
            try {
                const parsed = JSON.parse(currentValue);
                displayEl.textContent = JSON.stringify(parsed, null, 2);
            } catch (e) {
                displayEl.textContent = currentValue;
            }
        } else {
            displayEl.textContent = currentValue || '(empty)';
        }
    } else {
        valueEl.value = '';
        displayEl.textContent = 'Select a setting to see current value';
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Add change event to the dropdown if it exists
    const settingsKey = document.getElementById('settings_key');
    if (settingsKey) {
        settingsKey.addEventListener('change', populateSettingValue);
    }
});
</script>

{% endblock %}