{% extends "base.html" %}
{% import "macros.html" as macros %}
{% block content %}
<div class="vegas-wrapper">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message|safe }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    {% if not employee %}
        <h2>Employee Access</h2>
        <form action="{{ url_for('employee_portal') }}" method="POST" class="mb-4">
            {{ macros.render_csrf_token() }}
            {{ macros.render_field(login_form.employee_id, id='employee_id', label_text='Employee ID', class='form-control', type='number', required=True, value='') }}
            {{ macros.render_field(login_form.pin, id='employee_pin', label_text='PIN', class='form-control', type='password', required=True, value='') }}
            {{ macros.render_submit_button('Access', class='btn btn-primary') }}
        </form>
    {% else %}
        <h2>Welcome, {{ employee.name }}</h2>
        <p>Your Points: {{ employee.score }}</p>

        <h3>Unused Mini-Games</h3>
        <ul>
            {% for g in unused_games %}
                <li>{{ g.game_type }} awarded {{ g.awarded_date }}
                    <form action="{{ url_for('play_game', game_id=g.id) }}" method="POST" style="display:inline;">
                        {{ macros.render_csrf_token() }}
                        {{ macros.render_submit_button('Play', class='btn btn-sm btn-success') }}
                    </form>
                </li>
            {% else %}
                <li>No unused games</li>
            {% endfor %}
        </ul>

        <h3>Played Mini-Games</h3>
        <ul>
            {% for g in used_games %}
                <li>{{ g.game_type }} - {{ g.outcome if g.outcome else 'No Prize' }}</li>
            {% else %}
                <li>No played games</li>
            {% endfor %}
        </ul>

        <h3>Change PIN</h3>
        <form action="{{ url_for('employee_change_pin') }}" method="POST" class="mb-3">
            {{ macros.render_csrf_token() }}
            {{ macros.render_field(change_pin_form.current_pin, id='current_pin', label_text='Current PIN', class='form-control', type='password', required=True, value='') }}
            {{ macros.render_field(change_pin_form.new_pin, id='new_pin', label_text='New PIN', class='form-control', type='password', required=True, value='') }}
            {{ macros.render_submit_button('Change PIN', class='btn btn-warning') }}
        </form>
        <form action="{{ url_for('employee_logout') }}" method="POST">
            {{ macros.render_csrf_token() }}
            {{ macros.render_submit_button('Logout', class='btn btn-secondary') }}
        </form>
    {% endif %}
</div>
{% endblock %}
