{% extends "base.html" %}
{% import "macros.html" as macros %}
{% block content %}
<div class="vegas-casino-portal">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'success' if 'won' in message.lower() else category }} alert-dismissible fade show casino-alert" role="alert">
                    <span class="alert-icon">
                        {% if 'won' in message.lower() or 'jackpot' in message.lower() %}üèÜ
                        {% elif 'error' in category %}‚ö†Ô∏è
                        {% else %}‚ÑπÔ∏è{% endif %}
                    </span>
                    {{ message|safe }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    {% if not employee %}
        <!-- Casino Login Screen -->
        <div class="casino-login-screen">
            <div class="login-marquee">
                <h1 class="casino-title">üé∞ BROADWAY VEGAS PORTAL üé∞</h1>
                <p class="casino-subtitle">Enter Your Credentials to Play</p>
            </div>
            
            <div class="slot-machine login-slot">
                <form action="{{ url_for('employee_portal') }}" method="POST" class="casino-login-form">
                    {{ macros.render_csrf_token() }}
                    
                    <div class="input-group-vegas mb-3">
                        <span class="input-addon">üÉè</span>
                        {{ macros.render_field(login_form.employee_id, id='employee_id', label_text='Employee ID', class='form-control casino-input', type='text', required=True, value='', placeholder='E001, E002, etc.') }}
                    </div>
                    
                    <div class="input-group-vegas mb-4">
                        <span class="input-addon">üîê</span>
                        {{ macros.render_field(login_form.pin, id='employee_pin', label_text='PIN', class='form-control casino-input', type='password', required=True, value='', placeholder='Enter PIN') }}
                    </div>
                    
                    {{ macros.render_submit_button('üé≤ ENTER CASINO üé≤', class='btn btn-vegas btn-lg w-100 pulse-glow') }}
                </form>
            </div>
        </div>
    {% else %}
        <h2>Welcome, {{ employee.name }}</h2>
        <p>Your Points: {{ employee.score }}</p>

        <h3>Unused Mini-Games</h3>
        <ul>
            {% for g in unused_games %}
                <li>{{ g.game_type }} awarded {{ g.awarded_date }}
                    <form action="{{ url_for('play_game', game_id=g.id) }}" method="POST" style="display:inline;">
                        {{ macros.render_csrf_token() }}
                        {{ macros.render_submit_button('Play', class='btn btn-sm btn-success') }}
                    </form>
                </li>
            {% else %}
                <li>No unused games</li>
            {% endfor %}
        </ul>

        <h3>Played Mini-Games</h3>
        <ul>
            {% for g in used_games %}
                <li>{{ g.game_type }} - {{ g.outcome if g.outcome else 'No Prize' }}</li>
            {% else %}
                <li>No played games</li>
            {% endfor %}
        </ul>

        <h3>Change PIN</h3>
        <form action="{{ url_for('employee_change_pin') }}" method="POST" class="mb-3">
            {{ macros.render_csrf_token() }}
            {{ macros.render_field(change_pin_form.current_pin, id='current_pin', label_text='Current PIN', class='form-control', type='password', required=True, value='') }}
            {{ macros.render_field(change_pin_form.new_pin, id='new_pin', label_text='New PIN', class='form-control', type='password', required=True, value='') }}
            {{ macros.render_submit_button('Change PIN', class='btn btn-warning') }}
        </form>
        <form action="{{ url_for('employee_logout') }}" method="POST">
            {{ macros.render_csrf_token() }}
            {{ macros.render_submit_button('Logout', class='btn btn-secondary') }}
        </form>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const employeeIdInput = document.getElementById('employee_id');
    if (employeeIdInput) {
        employeeIdInput.addEventListener('input', function(e) {
            let value = e.target.value.toUpperCase();
            
            // Remove any non-digit/non-E characters
            value = value.replace(/[^E0-9]/g, '');
            
            // Ensure it starts with E
            if (value.length > 0 && !value.startsWith('E')) {
                value = 'E' + value.replace(/E/g, '');
            }
            
            // Limit to E + 3 digits max
            if (value.length > 4) {
                value = value.substring(0, 4);
            }
            
            // Format as E + 3 digit number
            if (value.length > 1) {
                const digits = value.substring(1);
                if (digits.length > 0) {
                    value = 'E' + digits.padStart(3, '0').substring(0, 3);
                }
            }
            
            e.target.value = value;
        });
        
        // Auto-format on blur
        employeeIdInput.addEventListener('blur', function(e) {
            let value = e.target.value.toUpperCase();
            if (value.length === 1 && value === 'E') {
                e.target.value = '';
            } else if (value.length > 1 && value.startsWith('E')) {
                const digits = value.substring(1);
                if (digits.length > 0) {
                    e.target.value = 'E' + digits.padStart(3, '0').substring(0, 3);
                }
            }
        });
    }
});
</script>
{% endblock %}
