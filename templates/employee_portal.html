{% extends "base.html" %}
{% import "macros.html" as macros %}
{% block content %}
<div class="vegas-casino-portal">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'success' if 'won' in message.lower() else category }} alert-dismissible fade show casino-alert" role="alert">
                    <span class="alert-icon">
                        {% if 'won' in message.lower() or 'jackpot' in message.lower() %}üèÜ
                        {% elif 'error' in category %}‚ö†Ô∏è
                        {% else %}‚ÑπÔ∏è{% endif %}
                    </span>
                    {{ message|safe }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    {% if not employee %}
        <!-- Casino Login Screen -->
        <div class="casino-login-screen">
            <div class="login-marquee">
                <h1 class="casino-title">üé∞ BROADWAY VEGAS PORTAL üé∞</h1>
                <p class="casino-subtitle">Enter Your Credentials to Play</p>
            </div>
            
            <div class="slot-machine login-slot">
                <form action="{{ url_for('employee_portal') }}" method="POST" class="casino-login-form">
                    {{ macros.render_csrf_token() }}
                    
                    <div class="input-group-vegas mb-3">
                        <span class="input-addon">üÉè</span>
                        {{ macros.render_field(login_form.employee_id, id='employee_id', label_text='Employee ID', class='form-control casino-input', type='text', required=True, value='', placeholder='E001, E002, etc.') }}
                    </div>
                    
                    <div class="input-group-vegas mb-4">
                        <span class="input-addon">üîê</span>
                        {{ macros.render_field(login_form.pin, id='employee_pin', label_text='PIN', class='form-control casino-input', type='password', required=True, value='', placeholder='Enter PIN') }}
                    </div>
                    
                    {{ macros.render_submit_button('üé≤ ENTER CASINO üé≤', class='btn btn-vegas btn-lg w-100 pulse-glow') }}
                </form>
            </div>
        </div>
    {% else %}
        <h2>Welcome, {{ employee.name }}</h2>
        <p>Your Points: {{ employee.score }}</p>

        <h3>Unused Mini-Games</h3>
        <ul>
            {% for g in unused_games %}
                <li>{{ g.game_type }} awarded {{ g.awarded_date }}
                    <button onclick="playMiniGame({{ g.id }}, '{{ g.game_type }}')" class="btn btn-sm btn-success">Play</button>
                </li>
            {% else %}
                <li>No unused games</li>
            {% endfor %}
        </ul>

        <h3>Played Mini-Games</h3>
        <ul>
            {% for g in used_games %}
                <li>
                    {{ g.game_type.title() }} - 
                    {% if g.outcome %}
                        {% set outcome_data = g.outcome | from_json %}
                        {% if outcome_data.win %}
                            {% if outcome_data.prize_type == 'points' %}
                                <span class="text-success">üéâ Won {{ outcome_data.prize_amount }} points!</span>
                            {% else %}
                                <span class="text-success">üèÜ Won: {{ outcome_data.prize_description or 'Special Prize' }}!</span>
                            {% endif %}
                        {% else %}
                            <span class="text-muted">No prize</span>
                        {% endif %}
                    {% else %}
                        <span class="text-muted">No outcome recorded</span>
                    {% endif %}
                    <small class="text-muted">({{ g.played_date }})</small>
                </li>
            {% else %}
                <li>No played games</li>
            {% endfor %}
        </ul>

        <h3>Change PIN</h3>
        <form action="{{ url_for('employee_change_pin') }}" method="POST" class="mb-3">
            {{ macros.render_csrf_token() }}
            {{ macros.render_field(change_pin_form.current_pin, id='current_pin', label_text='Current PIN', class='form-control', type='password', required=True, value='') }}
            {{ macros.render_field(change_pin_form.new_pin, id='new_pin', label_text='New PIN', class='form-control', type='password', required=True, value='') }}
            {{ macros.render_submit_button('Change PIN', class='btn btn-warning') }}
        </form>
        <form action="{{ url_for('employee_logout') }}" method="POST">
            {{ macros.render_csrf_token() }}
            {{ macros.render_submit_button('Logout', class='btn btn-secondary') }}
        </form>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const employeeIdInput = document.getElementById('employee_id');
    if (employeeIdInput) {
        employeeIdInput.addEventListener('input', function(e) {
            let value = e.target.value.toUpperCase();
            
            // Remove any non-digit/non-E characters
            value = value.replace(/[^E0-9]/g, '');
            
            // Ensure it starts with E
            if (value.length > 0 && !value.startsWith('E')) {
                value = 'E' + value.replace(/E/g, '');
            }
            
            // Limit to E + 3 digits max
            if (value.length > 4) {
                value = value.substring(0, 4);
            }
            
            // Format as E + 3 digit number
            if (value.length > 1) {
                const digits = value.substring(1);
                if (digits.length > 0) {
                    value = 'E' + digits.padStart(3, '0').substring(0, 3);
                }
            }
            
            e.target.value = value;
        });
        
        // Auto-format on blur
        employeeIdInput.addEventListener('blur', function(e) {
            let value = e.target.value.toUpperCase();
            if (value.length === 1 && value === 'E') {
                e.target.value = '';
            } else if (value.length > 1 && value.startsWith('E')) {
                const digits = value.substring(1);
                if (digits.length > 0) {
                    e.target.value = 'E' + digits.padStart(3, '0').substring(0, 3);
                }
            }
        });
    }
});

// Auto-logout functionality for employee portal
let inactivityTimer;
const INACTIVITY_TIMEOUT = 60 * 1000; // 60 seconds

function resetInactivityTimer() {
    clearTimeout(inactivityTimer);
    inactivityTimer = setTimeout(() => {
        alert('Session expired due to inactivity. You will be logged out.');
        fetch('/employee/logout', { 
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCSRFToken()
            }
        }).then(() => {
            window.location.href = '/employee';
        }).catch(() => {
            // Fallback if fetch fails
            window.location.href = '/employee';
        });
    }, INACTIVITY_TIMEOUT);
}

// Track user activity
function trackActivity() {
    resetInactivityTimer();
}

// Add event listeners for various user activities
document.addEventListener('mousedown', trackActivity);
document.addEventListener('mousemove', trackActivity);
document.addEventListener('keypress', trackActivity);
document.addEventListener('scroll', trackActivity);
document.addEventListener('touchstart', trackActivity);
document.addEventListener('click', trackActivity);

// Initialize the timer when page loads
resetInactivityTimer();

// Helper function to get CSRF token
function getCSRFToken() {
    // Try to get CSRF token from meta tag first, then from any form
    let token = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
    if (!token) {
        token = document.querySelector('input[name="csrf_token"]')?.value;
    }
    return token || '';
}

// Mini-game functions
async function playMiniGame(gameId, gameType) {
    try {
        // Create form data with CSRF token
        const formData = new FormData();
        const csrfToken = getCSRFToken();
        if (csrfToken) {
            formData.append('csrf_token', csrfToken);
        }
        
        const response = await fetch(`/play_game/${gameId}`, {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        // Check if the result is valid
        if (!result) {
            throw new Error('No response data received');
        }
        
        if (result.success === false) {
            throw new Error(result.message || 'Game play failed');
        }
        
        showGameModal(result, gameType);
        
        // Refresh the page to update game lists after a short delay
        setTimeout(() => {
            window.location.reload();
        }, 3000);
        
    } catch (error) {
        console.error('Error playing game:', error);
        alert(`Error playing game: ${error.message}. Please try again.`);
    }
}

function showGameModal(result, gameType) {
    // Create modal if it doesn't exist
    let modal = document.getElementById('gameModal');
    if (!modal) {
        modal = createGameModal();
    }
    
    const modalTitle = modal.querySelector('.modal-title');
    const modalBody = modal.querySelector('.modal-body');
    
    modalTitle.textContent = `${gameType.toUpperCase()} Game Result`;
    
    // Validate result structure
    if (!result || !result.result || !result.result.outcome) {
        modalBody.innerHTML = `
            <div class="text-center">
                <h4>Error: Invalid game result</h4>
                <p>The game response was not in the expected format.</p>
            </div>
        `;
        const bootstrapModal = new bootstrap.Modal(modal);
        bootstrapModal.show();
        return;
    }
    
    let content = `
        <div class="text-center">
            <h4>${result.message || 'Game Complete!'}</h4>
            <div class="game-result my-3">
    `;
    
    // Show game-specific result
    const outcome = result.result.outcome;
    
    if (outcome.reels && Array.isArray(outcome.reels)) {
        // Slot machine
        content += `
            <div class="slot-reels">
                <span class="reel-symbol">${outcome.reels[0] || '?'}</span>
                <span class="reel-symbol">${outcome.reels[1] || '?'}</span>
                <span class="reel-symbol">${outcome.reels[2] || '?'}</span>
            </div>
        `;
    } else if (outcome.grid && Array.isArray(outcome.grid)) {
        // Scratch-off
        content += `<div class="scratch-grid">`;
        outcome.grid.forEach(row => {
            content += `<div class="scratch-row">`;
            row.forEach(symbol => {
                content += `<span class="scratch-symbol">${symbol}</span>`;
            });
            content += `</div>`;
        });
        content += `</div>`;
    } else if (outcome.number !== undefined) {
        // Roulette
        content += `
            <div class="roulette-result">
                <div class="winning-number ${outcome.color || 'black'}">
                    ${outcome.number}
                </div>
                <div>Color: ${outcome.color || 'unknown'}</div>
                <div>Your bet: ${outcome.bet || 'unknown'}</div>
            </div>
        `;
    } else if (outcome.winning_segment && gameType.toLowerCase() === 'wheel') {
        // Wheel of Fortune
        content += `
            <div class="wheel-container">
                <div class="wheel-pointer"></div>
                <div class="wheel" id="wheelElement">
                    ${generateWheelSegments(outcome.segments || [])}
                    <div class="wheel-center">SPIN</div>
                </div>
            </div>
            <div class="wheel-result">
                <div class="wheel-winning-segment" style="background-color: ${outcome.winning_segment.color || '#ffd700'};">
                    üéØ ${outcome.winning_segment.name}
                </div>
            </div>
        `;
        
        // Trigger wheel spin animation after modal shows
        setTimeout(() => {
            animateWheelSpin(outcome.angle || 0);
        }, 500);
    } else {
        // Generic or unknown game type
        content += `
            <div class="generic-result">
                <p>Game played successfully!</p>
                <pre>${JSON.stringify(outcome, null, 2)}</pre>
            </div>
        `;
    }
    
    content += `
            </div>
            ${result.result.win ? (result.result.prize_type === 'points' ? `<div class="prize-info text-success"><strong>Prize: ${result.result.prize_amount || 0} points</strong></div>` : `<div class="prize-info text-success"><strong>Prize: ${result.result.prize_description || 'Special Prize'}</strong></div>`) : ''}
            ${result.jackpot ? `<div class="jackpot-flash">üéâ JACKPOT! üéâ</div>` : ''}
        </div>
    `;
    
    modalBody.innerHTML = content;
    
    // Show modal
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
}

function createGameModal() {
    const modalHTML = `
        <div class="modal fade" id="gameModal" tabindex="-1" aria-labelledby="gameModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="gameModalLabel">Game Result</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Game result content will be inserted here -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    return document.getElementById('gameModal');
}

// Generate wheel segments HTML
function generateWheelSegments(segments) {
    if (!segments || segments.length === 0) {
        // Default segments if none provided
        segments = [
            {name: '5 Points', color: '#4CAF50'},
            {name: '10 Points', color: '#2196F3'},
            {name: 'Try Again', color: '#f44336'},
            {name: '15 Points', color: '#ff9800'},
            {name: 'Bonus!', color: '#9c27b0'},
            {name: '20 Points', color: '#00bcd4'}
        ];
    }
    
    const segmentAngle = 360 / segments.length;
    let html = '';
    
    segments.forEach((segment, index) => {
        const rotation = segmentAngle * index;
        const clipPath = `polygon(50% 50%, 
            ${50 + 50 * Math.cos((rotation - segmentAngle/2) * Math.PI / 180)}% ${50 + 50 * Math.sin((rotation - segmentAngle/2) * Math.PI / 180)}%, 
            ${50 + 50 * Math.cos((rotation + segmentAngle/2) * Math.PI / 180)}% ${50 + 50 * Math.sin((rotation + segmentAngle/2) * Math.PI / 180)}%)`;
        
        html += `
            <div class="wheel-segment" style="
                background: ${segment.color || '#ccc'};
                clip-path: ${clipPath};
                transform: rotate(${rotation}deg);
            ">
                <div class="wheel-segment-text" style="transform: rotate(${segmentAngle/2}deg);">
                    ${segment.name}
                </div>
            </div>
        `;
    });
    
    return html;
}

// Animate wheel spin
function animateWheelSpin(targetAngle) {
    const wheelElement = document.getElementById('wheelElement');
    if (!wheelElement) return;
    
    // Add multiple full rotations for dramatic effect
    const spins = 5;
    const finalAngle = targetAngle + (360 * spins);
    
    // Apply the spinning animation
    wheelElement.style.transform = `rotate(${finalAngle}deg)`;
    
    // Play wheel spinning animation
    wheelElement.classList.add('wheel-spinning');
    
    // Remove spinning class after animation completes
    setTimeout(() => {
        wheelElement.classList.remove('wheel-spinning');
        
        // Add winner highlight effect
        const winningSegment = document.querySelector('.wheel-winning-segment');
        if (winningSegment) {
            winningSegment.classList.add('winner-pulse');
        }
    }, 3000);
}
</script>

<style>
.slot-reels {
    font-size: 3rem;
    margin: 20px 0;
}

.reel-symbol {
    display: inline-block;
    margin: 0 10px;
    padding: 10px;
    border: 2px solid #ffd700;
    border-radius: 8px;
    background: linear-gradient(135deg, #333 0%, #222 100%);
}

.scratch-grid {
    margin: 20px 0;
}

.scratch-row {
    display: flex;
    justify-content: center;
    margin: 5px 0;
}

.scratch-symbol {
    display: inline-block;
    font-size: 2rem;
    margin: 0 5px;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: #f8f9fa;
}

.roulette-result {
    margin: 20px 0;
}

.winning-number {
    font-size: 3rem;
    font-weight: bold;
    padding: 20px;
    border-radius: 50%;
    width: 100px;
    height: 100px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    border: 3px solid #ffd700;
}

.winning-number.red {
    background: #dc3545;
    color: white;
}

.winning-number.black {
    background: #000;
    color: white;
}

.winning-number.green {
    background: #28a745;
    color: white;
}

.prize-info {
    font-size: 1.2rem;
    margin-top: 15px;
}

.jackpot-flash {
    font-size: 2rem;
    color: #ffd700;
    animation: flash 1s infinite;
}

@keyframes flash {
    0%, 50%, 100% { opacity: 1; }
    25%, 75% { opacity: 0.5; }
}

/* Wheel of Fortune Styles */
.wheel-container {
    position: relative;
    width: 300px;
    height: 300px;
    margin: 20px auto;
}

.wheel {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    position: relative;
    overflow: hidden;
    box-shadow: 0 0 20px rgba(0,0,0,0.3);
    transition: transform 3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

.wheel-segment {
    position: absolute;
    width: 50%;
    height: 50%;
    transform-origin: 100% 100%;
}

.wheel-segment:before {
    content: '';
    position: absolute;
    width: 100%;
    height: 100%;
    clip-path: polygon(0 0, 100% 0, 0 100%);
}

.wheel-pointer {
    position: absolute;
    top: -10px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 15px solid transparent;
    border-right: 15px solid transparent;
    border-bottom: 30px solid #ffd700;
    z-index: 10;
    drop-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.wheel-center {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 40px;
    height: 40px;
    background: #ffd700;
    border-radius: 50%;
    border: 3px solid #fff;
    z-index: 5;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: #333;
}

.wheel-result {
    margin: 20px 0;
    text-align: center;
}

.wheel-winning-segment {
    font-size: 1.5rem;
    font-weight: bold;
    padding: 15px;
    border-radius: 8px;
    margin: 10px 0;
    border: 2px solid #ffd700;
}

/* Slot machine animation improvements */
@keyframes slot-spin {
    0% { transform: translateY(0); }
    25% { transform: translateY(-30px); }
    50% { transform: translateY(-60px); }
    75% { transform: translateY(-30px); }
    100% { transform: translateY(0); }
}

.slot-spinning {
    animation: slot-spin 0.3s infinite;
}

/* Wheel segment styles */
.wheel-segment {
    position: absolute;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
}

.wheel-segment-text {
    position: absolute;
    top: 20%;
    left: 50%;
    transform-origin: 0 0;
    font-weight: bold;
    font-size: 12px;
    color: white;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
    white-space: nowrap;
    pointer-events: none;
}

/* Wheel spinning animation */
.wheel-spinning {
    animation: wheel-spin-bounce 3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

@keyframes wheel-spin-bounce {
    0% { transform: rotate(0deg); }
    80% { transform: rotate(720deg); }
    90% { transform: rotate(710deg); }
    95% { transform: rotate(720deg); }
    100% { transform: rotate(720deg); }
}

/* Winner pulse animation */
.winner-pulse {
    animation: winner-pulse 1s infinite alternate;
}

@keyframes winner-pulse {
    0% { 
        transform: scale(1);
        box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    }
    100% { 
        transform: scale(1.05);
        box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
    }
}

/* Scratch card animation improvements */
.scratch-reveal {
    animation: scratch-reveal 0.8s ease-out;
}

@keyframes scratch-reveal {
    0% { opacity: 0; transform: scale(0.8) rotateY(90deg); }
    50% { transform: scale(1.1) rotateY(45deg); }
    100% { opacity: 1; transform: scale(1) rotateY(0deg); }
}
</style>
{% endblock %}
