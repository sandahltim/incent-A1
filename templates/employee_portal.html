{% extends "base.html" %}
{% import "macros.html" as macros %}
{% block content %}
<div class="vegas-casino-portal">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'success' if 'won' in message.lower() else category }} alert-dismissible fade show casino-alert" role="alert">
                    <span class="alert-icon">
                        {% if 'won' in message.lower() or 'jackpot' in message.lower() %}üèÜ
                        {% elif 'error' in category %}‚ö†Ô∏è
                        {% else %}‚ÑπÔ∏è{% endif %}
                    </span>
                    {{ message|safe }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    {% if not employee %}
        <!-- Casino Login Screen -->
        <div class="casino-login-screen">
            <div class="login-marquee">
                <h1 class="casino-title">üé∞ BROADWAY VEGAS PORTAL üé∞</h1>
                <p class="casino-subtitle">Enter Your Credentials to Play</p>
            </div>
            
            <div class="slot-machine login-slot">
                <form action="{{ url_for('employee_portal') }}" method="POST" class="casino-login-form">
                    {{ macros.render_csrf_token() }}
                    
                    <div class="input-group-vegas mb-3">
                        <span class="input-addon">üÉè</span>
                        {{ macros.render_field(login_form.employee_id, id='employee_id', label_text='Employee ID', class='form-control casino-input', type='text', required=True, value='', placeholder='E001, E002, etc.') }}
                    </div>
                    
                    <div class="input-group-vegas mb-4">
                        <span class="input-addon">üîê</span>
                        {{ macros.render_field(login_form.pin, id='employee_pin', label_text='PIN', class='form-control casino-input', type='password', required=True, value='', placeholder='Enter PIN') }}
                    </div>
                    
                    {{ macros.render_submit_button('üé≤ ENTER CASINO üé≤', class='btn btn-vegas btn-lg w-100 pulse-glow') }}
                </form>
            </div>
        </div>
    {% else %}
        <h2>Welcome, {{ employee.name }}</h2>
        <p>Your Points: {{ employee.score }}</p>

        <h3>Unused Mini-Games</h3>
        <ul>
            {% for g in unused_games %}
                <li>{{ g.game_type }} awarded {{ g.awarded_date }}
                    <button onclick="playMiniGame({{ g.id }}, '{{ g.game_type }}')" class="btn btn-sm btn-success">Play</button>
                </li>
            {% else %}
                <li>No unused games</li>
            {% endfor %}
        </ul>

        <h3>Played Mini-Games</h3>
        <ul>
            {% for g in used_games %}
                <li>
                    {{ g.game_type.title() }} - 
                    {% if g.outcome %}
                        {% set outcome_data = g.outcome | from_json %}
                        {% if outcome_data.win %}
                            <span class="text-success">üéâ Won {{ outcome_data.prize_amount }} points!</span>
                        {% else %}
                            <span class="text-muted">No prize</span>
                        {% endif %}
                    {% else %}
                        <span class="text-muted">No outcome recorded</span>
                    {% endif %}
                    <small class="text-muted">({{ g.played_date }})</small>
                </li>
            {% else %}
                <li>No played games</li>
            {% endfor %}
        </ul>

        <h3>Change PIN</h3>
        <form action="{{ url_for('employee_change_pin') }}" method="POST" class="mb-3">
            {{ macros.render_csrf_token() }}
            {{ macros.render_field(change_pin_form.current_pin, id='current_pin', label_text='Current PIN', class='form-control', type='password', required=True, value='') }}
            {{ macros.render_field(change_pin_form.new_pin, id='new_pin', label_text='New PIN', class='form-control', type='password', required=True, value='') }}
            {{ macros.render_submit_button('Change PIN', class='btn btn-warning') }}
        </form>
        <form action="{{ url_for('employee_logout') }}" method="POST">
            {{ macros.render_csrf_token() }}
            {{ macros.render_submit_button('Logout', class='btn btn-secondary') }}
        </form>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const employeeIdInput = document.getElementById('employee_id');
    if (employeeIdInput) {
        employeeIdInput.addEventListener('input', function(e) {
            let value = e.target.value.toUpperCase();
            
            // Remove any non-digit/non-E characters
            value = value.replace(/[^E0-9]/g, '');
            
            // Ensure it starts with E
            if (value.length > 0 && !value.startsWith('E')) {
                value = 'E' + value.replace(/E/g, '');
            }
            
            // Limit to E + 3 digits max
            if (value.length > 4) {
                value = value.substring(0, 4);
            }
            
            // Format as E + 3 digit number
            if (value.length > 1) {
                const digits = value.substring(1);
                if (digits.length > 0) {
                    value = 'E' + digits.padStart(3, '0').substring(0, 3);
                }
            }
            
            e.target.value = value;
        });
        
        // Auto-format on blur
        employeeIdInput.addEventListener('blur', function(e) {
            let value = e.target.value.toUpperCase();
            if (value.length === 1 && value === 'E') {
                e.target.value = '';
            } else if (value.length > 1 && value.startsWith('E')) {
                const digits = value.substring(1);
                if (digits.length > 0) {
                    e.target.value = 'E' + digits.padStart(3, '0').substring(0, 3);
                }
            }
        });
    }
});

// Auto-logout functionality for employee portal
let inactivityTimer;
const INACTIVITY_TIMEOUT = 60 * 1000; // 60 seconds

function resetInactivityTimer() {
    clearTimeout(inactivityTimer);
    inactivityTimer = setTimeout(() => {
        alert('Session expired due to inactivity. You will be logged out.');
        fetch('/employee/logout', { 
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value || ''
            }
        }).then(() => {
            window.location.href = '/employee';
        }).catch(() => {
            // Fallback if fetch fails
            window.location.href = '/employee';
        });
    }, INACTIVITY_TIMEOUT);
}

// Track user activity
function trackActivity() {
    resetInactivityTimer();
}

// Add event listeners for various user activities
document.addEventListener('mousedown', trackActivity);
document.addEventListener('mousemove', trackActivity);
document.addEventListener('keypress', trackActivity);
document.addEventListener('scroll', trackActivity);
document.addEventListener('touchstart', trackActivity);
document.addEventListener('click', trackActivity);

// Initialize the timer when page loads
resetInactivityTimer();

// Mini-game functions
async function playMiniGame(gameId, gameType) {
    try {
        const response = await fetch(`/play_game/${gameId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value || ''
            }
        });
        
        const result = await response.json();
        showGameModal(result, gameType);
        
        // Refresh the page to update game lists after a short delay
        setTimeout(() => {
            window.location.reload();
        }, 3000);
        
    } catch (error) {
        console.error('Error playing game:', error);
        alert('Error playing game. Please try again.');
    }
}

function showGameModal(result, gameType) {
    // Create modal if it doesn't exist
    let modal = document.getElementById('gameModal');
    if (!modal) {
        modal = createGameModal();
    }
    
    const modalTitle = modal.querySelector('.modal-title');
    const modalBody = modal.querySelector('.modal-body');
    
    modalTitle.textContent = `${gameType.toUpperCase()} Game Result`;
    
    let content = `
        <div class="text-center">
            <h4>${result.message}</h4>
            <div class="game-result my-3">
    `;
    
    // Show game-specific result
    if (result.result.outcome.reels) {
        // Slot machine
        content += `
            <div class="slot-reels">
                <span class="reel-symbol">${result.result.outcome.reels[0]}</span>
                <span class="reel-symbol">${result.result.outcome.reels[1]}</span>
                <span class="reel-symbol">${result.result.outcome.reels[2]}</span>
            </div>
        `;
    } else if (result.result.outcome.grid) {
        // Scratch-off
        content += `<div class="scratch-grid">`;
        result.result.outcome.grid.forEach(row => {
            content += `<div class="scratch-row">`;
            row.forEach(symbol => {
                content += `<span class="scratch-symbol">${symbol}</span>`;
            });
            content += `</div>`;
        });
        content += `</div>`;
    } else if (result.result.outcome.number !== undefined) {
        // Roulette
        content += `
            <div class="roulette-result">
                <div class="winning-number ${result.result.outcome.color}">
                    ${result.result.outcome.number}
                </div>
                <div>Color: ${result.result.outcome.color}</div>
                <div>Your bet: ${result.result.outcome.bet}</div>
            </div>
        `;
    }
    
    content += `
            </div>
            ${result.result.win ? `<div class="prize-info text-success"><strong>Prize: ${result.result.prize_amount} points</strong></div>` : ''}
            ${result.jackpot ? `<div class="jackpot-flash">üéâ JACKPOT! üéâ</div>` : ''}
        </div>
    `;
    
    modalBody.innerHTML = content;
    
    // Show modal
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
}

function createGameModal() {
    const modalHTML = `
        <div class="modal fade" id="gameModal" tabindex="-1" aria-labelledby="gameModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="gameModalLabel">Game Result</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Game result content will be inserted here -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    return document.getElementById('gameModal');
}
</script>

<style>
.slot-reels {
    font-size: 3rem;
    margin: 20px 0;
}

.reel-symbol {
    display: inline-block;
    margin: 0 10px;
    padding: 10px;
    border: 2px solid #ffd700;
    border-radius: 8px;
    background: linear-gradient(135deg, #333 0%, #222 100%);
}

.scratch-grid {
    margin: 20px 0;
}

.scratch-row {
    display: flex;
    justify-content: center;
    margin: 5px 0;
}

.scratch-symbol {
    display: inline-block;
    font-size: 2rem;
    margin: 0 5px;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: #f8f9fa;
}

.roulette-result {
    margin: 20px 0;
}

.winning-number {
    font-size: 3rem;
    font-weight: bold;
    padding: 20px;
    border-radius: 50%;
    width: 100px;
    height: 100px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    border: 3px solid #ffd700;
}

.winning-number.red {
    background: #dc3545;
    color: white;
}

.winning-number.black {
    background: #000;
    color: white;
}

.winning-number.green {
    background: #28a745;
    color: white;
}

.prize-info {
    font-size: 1.2rem;
    margin-top: 15px;
}

.jackpot-flash {
    font-size: 2rem;
    color: #ffd700;
    animation: flash 1s infinite;
}

@keyframes flash {
    0%, 50%, 100% { opacity: 1; }
    25%, 75% { opacity: 0.5; }
}
</style>
{% endblock %}
