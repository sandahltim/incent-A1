{% extends "base.html" %}
{% import "macros.html" as macros %}
{% block content %}
<h1>Score History</h1>
<form method="GET" action="/history">
    {{ macros.render_select_field(field=FormField('month_year'), label_text='Select Month', options=[('', 'All Months')] + [(month, month) for month in months], selected_value=selected_month) }}
    {% if selected_month %}
        {{ macros.render_select_field(field=FormField('day'), label_text='Select Day', options=[('', 'All Days')] + [(day, day) for day in days], selected_value=selected_day) }}
    {% endif %}
    {{ macros.render_submit_button('Filter') }}
</form>
<table class="table">
    <thead>
        <tr>
            <th>Employee</th>
            <th>Changed By</th>
            <th>Points</th>
            <th>Reason</th>
            <th>Notes</th>
            <th>Date</th>
        </tr>
    </thead>
    <tbody>
        {% for entry in history %}
            <tr>
                <td>{{ entry.name }}</td>
                <td>{{ entry.changed_by }}</td>
                <td>{{ entry.points }}</td>
                <td>{{ entry.reason }}</td>
                <td>{{ entry.notes|default('') }}</td>
                <td>{{ entry.date }}</td>
            </tr>
        {% else %}
            <tr><td colspan="6">No history available</td></tr>
        {% endfor %}
    </tbody>
</table>
<a class="btn btn-secondary" href="/">Back to Incentive Program</a>

<h2>Score Trends</h2>
{% set unique_employees = history | map(attribute='employee_id') | unique | list %}
{% for emp_id in unique_employees %}
    {% set emp_name = (history | selectattr('employee_id', 'eq', emp_id) | first).name %}
    <h3>{{ emp_name }}</h3>
    <img src="/history_chart?employee_id={{ emp_id }}&month={{ selected_month|default('') }}" alt="Score trend for {{ emp_name }}">
{% endfor %}
{% endblock %}