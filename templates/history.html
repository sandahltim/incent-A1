{# history.html #}
{# Version: 1.2.7 #}
{# Note: Replaced month/day filtering with date range and employee selection. Updated chart image source to respect selected range and employee. #}

{% extends "base.html" %}
{% import "macros.html" as macros %}
{% block content %}
<h1>Score History</h1>
<form method="GET" action="{{ url_for('history') }}">
    {{ macros.render_field({'name': 'start_date', 'errors': []}, id='start_date', label_text='Start Date', type='date', value=start_date|default('')) }}
    {{ macros.render_field({'name': 'end_date', 'errors': []}, id='end_date', label_text='End Date', type='date', value=end_date|default('')) }}
    {{ macros.render_select_field({'name': 'employee_id', 'errors': []}, id='employee_id', label_text='Select Employee', options=employees, selected_value=selected_employee) }}
    {{ macros.render_submit_button('Filter') }}
</form>
<table class="table">
    <thead>
        <tr>
            <th>Employee</th>
            <th>Changed By</th>
            <th>Points</th>
            <th>Reason</th>
            <th>Notes</th>
            <th>Date</th>
        </tr>
    </thead>
    <tbody>
        {% for entry in history %}
            <tr>
                <td>{{ entry.name }}</td>
                <td>{{ entry.changed_by }}</td>
                <td>{{ entry.points }}</td>
                <td>{{ entry.reason }}</td>
                <td>{{ entry.notes|default('') }}</td>
                <td>{{ entry.date }}</td>
            </tr>
        {% else %}
            <tr><td colspan="6">No history available</td></tr>
        {% endfor %}
    </tbody>
</table>
<a class="btn btn-secondary" href="{{ url_for('show_incentive') }}">Back to Incentive Program</a>

<h2>Score Trends</h2>
{% set unique_employees = history | map(attribute='employee_id') | unique | list %}
{% for emp_id in unique_employees %}
    {% set emp_name = (history | selectattr('employee_id', 'eq', emp_id) | first).name %}
    <h3>{{ emp_name }}</h3>
    <img src="{{ url_for('history_chart', employee_id=emp_id, start_date=start_date, end_date=end_date) }}" alt="Score trend for {{ emp_name }}">
{% endfor %}
{% endblock %}