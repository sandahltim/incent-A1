{% extends "base.html" %}
{% block content %}
<h1>Admin Management</h1>

<h2>Adjust Points</h2>
<form id="adjustPointsForm">
    <input type="hidden" name="csrf_token" id="csrf_token_adjust" value="{{ csrf_token() }}">
    <div class="mb-3">
        <label for="adjust_employee_id" class="form-label">Employee:</label>
        <select class="form-control" id="adjust_employee_id" name="employee_id" required>
            {% for emp in employees %}
            {% set role_display = roles|selectattr('role_name', 'eq', emp.role)|map(attribute='role_name')|first|default(emp.role) %}
            <option value="{{ emp.employee_id }}">
                {{ emp.employee_id }} - {{ emp.name }} ({{ emp.initials }}) - {{ emp.score }}
                {% if emp.active == 0 %}(Retired){% endif %}
            </option>
            {% endfor %}
        </select>
    </div>
    <div class="mb-3">
        <label for="adjust_points" class="form-label">Points (positive or negative):</label>
        <input type="number" class="form-control" id="adjust_points" name="points" required>
    </div>
    <div class="mb-3">
        <label for="reason" class="form-label">Reason:</label>
        <input type="text" class="form-control" id="reason" name="reason" required>
        <small style="color: #FFD700;">Select a rule or enter a custom reason:</small>
        <ul>
            {% for rule in rules %}
            <li>
                <a href="#" class="rule-link"
                   data-points="{{ rule.points }}"
                   data-reason="{{ rule.description }}">
                    {{ rule.description }} ({{ rule.points }})
                </a>
            </li>
            {% endfor %}
        </ul>
    </div>
    <div class="mb-3">
        <label for="notes" class="form-label">Notes (optional):</label>
        <textarea class="form-control" id="notes" name="notes"></textarea>
    </div>
    <button type="submit" class="btn btn-primary" id="submit_adjust_points">Adjust Points</button>
</form>

<h2>Points Rules</h2>
<form id="addRuleForm">
    <input type="hidden" name="csrf_token" id="csrf_token_add_rule" value="{{ csrf_token() }}">
    <div class="mb-3">
        <label for="description" class="form-label">Description:</label>
        <input type="text" class="form-control" id="description" name="description" required>
    </div>
    <div class="mb-3">
        <label for="rule_points" class="form-label">Points:</label>
        <input type="number" class="form-control" id="rule_points" name="points" required>
    </div>
    <div class="mb-3">
        <label for="details" class="form-label">Details:</label>
        <textarea class="form-control" id="details" name="details"></textarea>
    </div>
    <button type="submit" class="btn btn-primary" id="submit_add_rule">Add Rule</button>
</form>

<h3>Edit or Remove Rules</h3>
<ul>
    {% for rule in rules %}
    <li>
        <form class="editRuleForm" style="display: inline;">
            <input type="hidden" name="csrf_token" id="csrf_token_edit_rule_{{ loop.index }}" value="{{ csrf_token() }}">
            <input type="hidden" name="old_description" value="{{ rule.description }}">
            <input type="text" name="new_description" value="{{ rule.description }}" required>
            <input type="number" name="points" value="{{ rule.points }}" required>
            <textarea name="details">{{ rule.details }}</textarea>
            <button type="submit" class="btn btn-sm btn-success" id="submit_edit_rule_{{ loop.index }}">Edit</button>
        </form>
        <form class="removeRuleForm" style="display: inline;">
            <input type="hidden" name="csrf_token" id="csrf_token_remove_rule_{{ loop.index }}" value="{{ csrf_token() }}">
            <input type="hidden" name="description" value="{{ rule.description }}">
            <button type="submit" class="btn btn-sm btn-danger" id="submit_remove_rule_{{ loop.index }}">Remove</button>
        </form>
    </li>
    {% endfor %}
</ul>

<h2>Incentive Pot</h2>
<p>Debug - Employee Data:</p>
<ul>
    {% for emp in employees %}
    {% set role_display = roles|selectattr('role_name', 'eq', emp.role)|map(attribute='role_name')|first|default(emp.role) %}
    <li>
        {{ emp.employee_id }}: Score={{ emp.score }}, Role={{ role_display }}, Active={{ emp.active|default('MISSING') }},
        Point Value={{ pot_info.get(emp.role.lower() + '_point_value', 0) }},
        Share={{ emp.score * pot_info.get(emp.role.lower() + '_point_value', 0) }}
    </li>
    {% endfor %}
</ul>
{% set shares = [] %}
{% for emp in employees %}
    {% if emp.active == 1 and emp.score > 50 %}
        {% set share = emp.score * pot_info.get(emp.role.lower() + '_point_value', 0) %}
        {% set _ = shares.append(share) %}
    {% endif %}
{% endfor %}
<p>Shares List: {{ shares }}</p>
<p>Total Bonus Payout: ${{ "%.2f"|format(shares | sum) }}</p>

<h2>Reset Scores</h2>
<form id="resetScoresForm" method="POST" action="{{ url_for('admin_reset') }}">
    <input type="hidden" name="csrf_token" id="csrf_token_reset_scores" value="{{ csrf_token() }}">
    <button type="submit" class="btn btn-danger" id="submit_reset_scores">
        Reset All Scores to 50
    </button>
</form>

{% if voting_active %}
<h2>Voting Controls</h2>
<form id="pauseVotingForm" method="POST" action="{{ url_for('pause_voting') }}" style="display: inline;">
    <input type="hidden" name="csrf_token" id="csrf_token_pause" value="{{ csrf_token() }}">
    <button type="submit" class="btn btn-warning" id="submit_pause_voting">Pause Voting</button>
</form>
<form id="closeVotingForm" method="POST" action="{{ url_for('close_voting') }}" style="display: inline;">
    <input type="hidden" name="csrf_token" id="csrf_token_close" value="{{ csrf_token() }}">
    <input type="password" name="password" placeholder="Admin Password" required
           class="form-control" style="display: inline-block; width: auto;">
    <button type="submit" class="btn btn-danger" id="submit_close_voting">End Weekly Voting</button>
</form>
{% endif %}

{% if is_master %}
<h2>Add Employee</h2>
<form id="addEmployeeForm">
    <input type="hidden" name="csrf_token" id="csrf_token_add_employee" value="{{ csrf_token() }}">
    <div class="mb-3">
        <label for="name" class="form-label">Name:</label>
        <input type="text" class="form-control" id="name" name="name" required>
    </div>
    <div class="mb-3">
        <label for="initials" class="form-label">Initials:</label>
        <input type="text" class="form-control" id="initials" name="initials" required>
    </div>
    <div class="mb-3">
        <label for="role" class="form-label">Role:</label>
        <select class="form-control" id="role" name="role">
            {% for role in roles %}
            <option value="{{ role.role_name }}">{{ role.role_name }}</option>
            {% endfor %}
        </select>
    </div>
    <button type="submit" class="btn btn-primary" id="submit_add_employee">Add Employee</button>
</form>

<h2>Manage Employees</h2>
<form id="editEmployeeForm">
    <input type="hidden" name="csrf_token" id="csrf_token_edit_employee" value="{{ csrf_token() }}">
    <div class="mb-3">
        <label for="edit_employee_id" class="form-label">Employee:</label>
        <select class="form-control" id="edit_employee_id" name="employee_id" required>
            {% for emp in employees %}
            <option value="{{ emp.employee_id }}">
                {{ emp.employee_id }} - {{ emp.name }} ({{ emp.initials }})
                {% if emp.active == 0 %}(Retired){% endif %}
            </option>
            {% endfor %}
        </select>
    </div>
    <div class="mb-3">
        <label for="edit_name" class="form-label">New Name:</label>
        <input type="text" class="form-control" id="edit_name" name="name" required>
    </div>
    <div class="mb-3">
        <label for="edit_role" class="form-label">New Role:</label>
        <select class="form-control" id="edit_role" name="role">
            {% for role in roles %}
            <option value="{{ role.role_name }}">{{ role.role_name }}</option>
            {% endfor %}
        </select>
    </div>
    <button type="submit" class="btn btn-primary" id="submit_edit_employee">Edit Employee</button>
    <button type="button" id="retireBtn" class="btn btn-warning">Retire</button>
    <button type="button" id="reactivateBtn" class="btn btn-success">Reactivate</button>
    <button type="button" id="deleteBtn" class="btn btn-danger">Delete Forever</button>
</form>

<h2>Update Incentive Pot</h2>
<form id="updatePotForm">
    <input type="hidden" name="csrf_token" id="csrf_token_update_pot" value="{{ csrf_token() }}">
    <div class="mb-3">
        <label for="sales_dollars" class="form-label">Sales Dollars:</label>
        <input type="number" step="0.01" class="form-control" id="sales_dollars"
               name="sales_dollars" value="{{ pot_info.get('sales_dollars', 0) }}" required>
    </div>
    <div class="mb-3">
        <label for="bonus_percent" class="form-label">Bonus % of Sales Amount:</label>
        <input type="number" step="0.1" class="form-control" id="bonus_percent"
               name="bonus_percent" value="{{ pot_info.get('bonus_percent', 0) }}" required>
    </div>
    <button type="submit" class="btn btn-primary" id="submit_update_pot">Update Pot</button>
</form>

<h2>Prior Year Sales</h2>
<form id="priorYearSalesForm">
    <input type="hidden" name="csrf_token" id="csrf_token_prior_year" value="{{ csrf_token() }}">
    <div class="mb-3">
        <label for="prior_year_sales" class="form-label">
            Prior Year Sales Dollars (Current: ${{ "%.2f"|format(pot_info.get('prior_year_sales', 0)) }}):
        </label>
        <input type="number" step="0.01" class="form-control" id="prior_year_sales"
               name="prior_year_sales" value="{{ pot_info.get('prior_year_sales', 0) }}" required>
    </div>
    <button type="submit" class="btn btn-primary" id="submit_prior_year">Update Prior Year Sales</button>
</form>

<h2>Set Daily Point Decay</h2>
<form id="pointDecayForm">
    <input type="hidden" name="csrf_token" id="csrf_token_point_decay" value="{{ csrf_token() }}">
    <div class="mb-3">
        <label for="decay_role_name" class="form-label">Role:</label>
        <select class="form-control" id="decay_role_name" name="role_name" required>
            {% for role in roles %}
            <option value="{{ role.role_name }}">
                {{ role.role_name }} (Current: {{ decay[role.role_name].points|default(1) }} points,
                {{ decay[role.role_name].days|default([])|join(', ') }})
            </option>
            {% endfor %}
        </select>
    </div>
    <div class="mb-3">
        <label for="decay_points" class="form-label">Points to Deduct Daily:</label>
        <input type="number" class="form-control" id="decay_points" name="points"
               min="0" value="1" required>
    </div>
    <div class="mb-3">
        <label class="form-label">Days to Trigger:</label><br>
        <input type="checkbox" name="days[]" value="Monday"> Monday<br>
        <input type="checkbox" name="days[]" value="Tuesday"> Tuesday<br>
        <input type="checkbox" name="days[]" value="Wednesday"> Wednesday<br>
        <input type="checkbox" name="days[]" value="Thursday"> Thursday<br>
        <input type="checkbox" name="days[]" value="Friday"> Friday<br>
        <input type="checkbox" name="days[]" value="Saturday"> Saturday<br>
        <input type="checkbox" name="days[]" value="Sunday"> Sunday<br>
    </div>
    <button type="submit" class="btn btn-primary" id="submit_point_decay">Set Point Decay</button>
</form>

<h2>Manage Admins</h2>
<form id="updateAdminForm">
    <input type="hidden" name="csrf_token" id="csrf_token_update_admin" value="{{ csrf_token() }}">
    <div class="mb-3">
        <label for="old_username" class="form-label">Current Username:</label>
        <select class="form-control" id="old_username" name="old_username" required>
            {% for admin in admins %}
            <option value="{{ admin.username }}">{{ admin.username }} ({{ admin.admin_id }})</option>
            {% endfor %}
        </select>
    </div>
    <div class="mb-3">
        <label for="new_username" class="form-label">New Username:</label>
        <input type="text" class="form-control" id="new_username" name="new_username" required>
    </div>
    <div class="mb-3">
        <label for="new_password" class="form-label">New Password:</label>
        <input type="password" class="form-control" id="new_password" name="new_password" required>
    </div>
    <button type="submit" class="btn btn-primary" id="submit_update_admin">Update Admin</button>
</form>

<h2>Manage Job Roles</h2>
<form id="addRoleForm">
    <input type="hidden" name="csrf_token" id="csrf_token_add_role" value="{{ csrf_token() }}">
    <div class="mb-3">
        <label for="new_role_name" class="form-label">Role Name:</label>
        <input type="text" class="form-control" id="new_role_name" name="role_name" required>
    </div>
    <div class="mb-3">
        <label for="percentage" class="form-label">Percentage:</label>
        <input type="number" step="0.1" class="form-control" id="percentage" name="percentage" required>
    </div>
    <button type="submit" class="btn btn-primary" id="submit_add_role">Add Role</button>
</form>

<h3>Edit or Remove Roles (Must Total â‰¤ 100%)</h3>
<ul>
    {% for role in roles %}
    <li>
        <form class="editRoleForm" style="display: inline;">
            <input type="hidden" name="csrf_token" id="csrf_token_edit_role_{{ loop.index }}" value="{{ csrf_token() }}">
            <input type="hidden" name="old_role_name" value="{{ role.role_name }}">
            <input type="text" name="new_role_name" value="{{ role.role_name }}" required>
            <input type="number" step="0.1" name="percentage" value="{{ role.percentage }}" required>
            <button type="submit" class="btn btn-sm btn-success" id="submit_edit_role_{{ loop.index }}">Edit</button>
        </form>
        <form class="removeRoleForm" style="display: inline;">
            <input type="hidden" name="csrf_token" id="csrf_token_remove_role_{{ loop.index }}" value="{{ csrf_token() }}">
            <input type="hidden" name="role_name" value="{{ role.role_name }}">
            <button type="submit" class="btn btn-sm btn-danger" id="submit_remove_role_{{ loop.index }}">Remove</button>
        </form>
    </li>
    {% endfor %}
</ul>

<h2>Master Reset</h2>
<form id="masterResetForm">
    <input type="hidden" name="csrf_token" id="csrf_token_master_reset" value="{{ csrf_token() }}">
    <div class="mb-3">
        <label for="masterPassword" class="form-label">Master Password:</label>
        <input type="password" class="form-control" id="masterPassword" name="password" required>
    </div>
    <button type="submit" class="btn btn-danger" id="submit_master_reset">Reset All Voting and History</button>
</form>

<h2>Voting Results</h2>
<div id="adminVotingResults">
    {% if voting_results %}
    {% set sessions = voting_results | groupby('session_id') %}
    {% for session_id, session_results in sessions %}
    <h3>Session {{ session_id }}</h3>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Voter Initials</th>
                <th>Recipient Name</th>
                <th>Vote</th>
                <th>Date</th>
                <th>Points</th>
            </tr>
        </thead>
        <tbody>
            {% for result in session_results %}
            <tr class="{% if (result.points|default(0)) > 0 %}text-success{% elif (result.points|default(0)) < 0 %}text-danger{% endif %}">
                <td>{{ result.voter_initials }}</td>
                <td>{{ result.recipient_name }}</td>
                <td>{{ result.vote_value }}</td>
                <td>{{ result.vote_date }}</td>
                <td>{{ result.points|default(0) }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endfor %}
    {% else %}
    <p>No voting results available.</p>
    {% endif %}
</div>
{% endif %}

<h2>Feedback</h2>
{% if unread_feedback > 0 %}
<span class="badge bg-danger">Unread Feedback: {{ unread_feedback }}</span>
{% endif %}
<table class="table">
    <thead>
        <tr>
            <th>ID</th>
            <th>Submitter</th>
            <th>Comment</th>
            <th>Timestamp</th>
            <th>Read</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        {% for fb in feedback %}
        <tr>
            <td>{{ fb.id }}</td>
            <td>{{ fb.submitter }}</td>
            <td>{{ fb.comment }}</td>
            <td>{{ fb.timestamp }}</td>
            <td>{{ 'Yes' if fb.read else 'No' }}</td>
            <td>
                {% if not fb.read %}
                <form class="markReadForm" action="{{ url_for('mark_feedback_read') }}" method="POST">
                    <input type="hidden" name="csrf_token" id="csrf_token_mark_read_{{ fb.id }}" value="{{ csrf_token() }}">
                    <input type="hidden" name="feedback_id" value="{{ fb.id }}">
                    <button type="submit" class="btn btn-sm btn-success" id="submit_mark_read_{{ fb.id }}">Mark Read</button>
                </form>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<h2>Export Payout Data</h2>
<a href="{{ url_for('export_payout') }}" class="btn btn-info">Export All</a>
<a href="{{ url_for('export_payout') }}?month={{ current_month }}" class="btn btn-info">Export Current Month</a>

<h2>Logout</h2>
<form id="logoutForm" method="POST" action="{{ url_for('admin_logout') }}">
    <input type="hidden" name="csrf_token" id="csrf_token_logout" value="{{ csrf_token() }}">
    <button type="submit" class="btn btn-warning" id="submit_logout">Logout</button>
</form>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Adjust Points Form
    document.getElementById('adjustPointsForm').addEventListener('submit', (e) => {
        e.preventDefault();
        if (!e.target.employee_id.value || !e.target.points.value || !e.target.reason.value) {
            alert('All required fields must be filled.');
            return;
        }
        fetch('/admin/adjust_points', {
            method: 'POST',
            body: new FormData(e.target),
        })
        .then(res => res.json())
        .then(data => {
            alert(data.message);
            if (data.success) window.location.reload();
        })
        .catch(err => console.error('Error adjusting points:', err));
    });

    // Rule links
    document.querySelectorAll('.rule-link').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('adjust_points').value = link.getAttribute('data-points');
            document.getElementById('reason').value = link.getAttribute('data-reason');
        });
    });

    // Add Rule Form
    document.getElementById('addRuleForm').addEventListener('submit', (e) => {
        e.preventDefault();
        if (!e.target.description.value || !e.target.points.value) {
            alert('Description and points are required.');
            return;
        }
        fetch('/admin/add_rule', {
            method: 'POST',
            body: new FormData(e.target),
        })
        .then(res => res.json())
        .then(data => {
            alert(data.message);
            if (data.success) window.location.reload();
        })
        .catch(err => console.error('Error adding rule:', err));
    });

    // Edit Rule Forms
    document.querySelectorAll('.editRuleForm').forEach(form => {
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            if (!form.new_description.value || !form.points.value) {
                alert('Description and points are required.');
                return;
            }
            fetch('/admin/edit_rule', {
                method: 'POST',
                body: new FormData(form),
            })
            .then(res => res.json())
            .then(data => {
                alert(data.message);
                if (data.success) window.location.reload();
            })
            .catch(err => console.error('Error editing rule:', err));
        });
    });

    // Remove Rule Forms
    document.querySelectorAll('.removeRuleForm').forEach(form => {
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            if (confirm('Are you sure you want to remove this rule?')) {
                fetch('/admin/remove_rule', {
                    method: 'POST',
                    body: new FormData(form),
                })
                .then(res => res.json())
                .then(data => {
                    alert(data.message);
                    if (data.success) window.location.reload();
                })
                .catch(err => console.error('Error removing rule:', err));
            }
        });
    });

    // Reset Scores
    document.getElementById('resetScoresForm').addEventListener('submit', (e) => {
        e.preventDefault();
        if (confirm('Reset all scores to 50 and log to history?')) {
            fetch('/admin/reset', {
                method: 'POST',
                body: new FormData(e.target),
            })
            .then(res => res.json())
            .then(data => {
                alert(data.message);
                if (data.success) window.location.href = '/';
            })
            .catch(err => console.error('Error resetting scores:', err));
        }
    });

    {% if is_master %}
    // Prior Year Sales
    document.getElementById('priorYearSalesForm').addEventListener('submit', (e) => {
        e.preventDefault();
        if (!e.target.prior_year_sales.value) {
            alert('Prior year sales is required.');
            return;
        }
        fetch('/admin/update_prior_year_sales', {
            method: 'POST',
            body: new FormData(e.target),
        })
        .then(res => res.json())
        .then(data => {
            alert(data.message);
            if (data.success) window.location.reload();
        })
        .catch(err => console.error('Error updating prior year sales:', err));
    });

    // Point Decay
    document.getElementById('pointDecayForm').addEventListener('submit', (e) => {
        e.preventDefault();
        if (!e.target.role_name.value || !e.target.points.value) {
            alert('Role and points are required.');
            return;
        }
        fetch('/admin/set_point_decay', {
            method: 'POST',
            body: new FormData(e.target),
        })
        .then(res => res.json())
        .then(data => {
            alert(data.message);
            if (data.success) window.location.reload();
        })
        .catch(err => console.error('Error setting point decay:', err));
    });

    // Add Employee
    document.getElementById('addEmployeeForm').addEventListener('submit', (e) => {
        e.preventDefault();
        if (!e.target.name.value || !e.target.initials.value || !e.target.role.value) {
            alert('All fields are required.');
            return;
        }
        fetch('/admin/add', {
            method: 'POST',
            body: new FormData(e.target),
        })
        .then(res => res.json())
        .then(data => {
            alert(data.message);
            if (data.success) window.location.reload();
        })
        .catch(err => console.error('Error adding employee:', err));
    });

    // Edit Employee
    document.getElementById('editEmployeeForm').addEventListener('submit', (e) => {
        e.preventDefault();
        if (!e.target.employee_id.value || !e.target.name.value || !e.target.role.value) {
            alert('All fields are required.');
            return;
        }
        fetch('/admin/edit_employee', {
            method: 'POST',
            body: new FormData(e.target),
        })
        .then(res => res.json())
        .then(data => {
            alert(data.message);
            if (data.success) window.location.reload();
        })
        .catch(err => console.error('Error editing employee:', err));
    });

    // Retire Employee
    document.getElementById('retireBtn').addEventListener('click', () => {
        const id = document.getElementById('edit_employee_id').value;
        if (!id) { alert('Please select an employee.'); return; }
        if (confirm('Retire this employee?')) {
            fetch('/admin/retire_employee', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `employee_id=${encodeURIComponent(id)}`
            })
            .then(res => res.json())
            .then(data => {
                alert(data.message);
                if (data.success) window.location.reload();
            })
            .catch(err => console.error('Error retiring:', err));
        }
    });

    // Reactivate Employee
    document.getElementById('reactivateBtn').addEventListener('click', () => {
        const id = document.getElementById('edit_employee_id').value;
        if (!id) { alert('Please select an employee.'); return; }
        if (confirm('Reactivate this employee?')) {
            fetch('/admin/reactivate_employee', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `employee_id=${encodeURIComponent(id)}`
            })
            .then(res => res.json())
            .then(data => {
                alert(data.message);
                if (data.success) window.location.reload();
            })
            .catch(err => console.error('Error reactivating:', err));
        }
    });

    // Delete Employee
    document.getElementById('deleteBtn').addEventListener('click', () => {
        const id = document.getElementById('edit_employee_id').value;
        if (!id) { alert('Please select an employee.'); return; }
        if (confirm('Permanently delete this employee?')) {
            fetch('/admin/delete_employee', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `employee_id=${encodeURIComponent(id)}`
            })
            .then(res => res.json())
            .then(data => {
                alert(data.message);
                if (data.success) window.location.reload();
            })
            .catch(err => console.error('Error deleting:', err));
        }
    });

    // Update Admin
    document.getElementById('updateAdminForm').addEventListener('submit', (e) => {
        e.preventDefault();
        if (!e.target.old_username.value || !e.target.new_username.value || !e.target.new_password.value) {
            alert('All fields are required.');
            return;
        }
        fetch('/admin/update_admin', {
            method: 'POST',
            body: new FormData(e.target),
        })
        .then(res => res.json())
        .then(data => {
            alert(data.message);
            if (data.success) window.location.reload();
        })
        .catch(err => console.error('Error updating admin:', err));
    });

    // Add Role
    document.getElementById('addRoleForm').addEventListener('submit', (e) => {
        e.preventDefault();
        if (!e.target.role_name.value || !e.target.percentage.value) {
            alert('Role name and percentage are required.');
            return;
        }
        fetch('/admin/add_role', {
            method: 'POST',
            body: new FormData(e.target),
        })
        .then(res => res.json())
        .then(data => {
            alert(data.message);
            if (data.success) window.location.reload();
        })
        .catch(err => console.error('Error adding role:', err));
    });

    // Edit Role
    document.querySelectorAll('.editRoleForm').forEach(form => {
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            if (!form.new_role_name.value || !form.percentage.value) {
                alert('Role name and percentage are required.');
                return;
            }
            fetch('/admin/edit_role', {
                method: 'POST',
                body: new FormData(form),
            })
            .then(res => res.json())
            .then(data => {
                alert(data.message);
                if (data.success) window.location.reload();
            })
            .catch(err => console.error('Error editing role:', err));
        });
    });

    // Remove Role
    document.querySelectorAll('.removeRoleForm').forEach(form => {
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            if (confirm('Remove this role? Employees will be reassigned to "driver".')) {
                fetch('/admin/remove_role', {
                    method: 'POST',
                    body: new FormData(form),
                })
                .then(res => res.json())
                .then(data => {
                    alert(data.message);
                    if (data.success) window.location.reload();
                })
                .catch(err => console.error('Error removing role:', err));
            }
        });
    });

    // Master Reset
    document.getElementById('masterResetForm').addEventListener('submit', (e) => {
        e.preventDefault();
        if (!e.target.password.value) {
            alert('Master password is required.');
            return;
        }
        if (confirm('Reset all voting data and history?')) {
            fetch('/admin/master_reset', {
                method: 'POST',
                body: new FormData(e.target),
            })
            .then(res => res.json())
            .then(data => {
                alert(data.message);
                if (data.success) window.location.reload();
            })
            .catch(err => console.error('Error in master reset:', err));
        }
    });
    {% endif %}

    // Mark Feedback Read
    document.querySelectorAll('.markReadForm').forEach(form => {
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            fetch(form.action, {
                method: 'POST',
                body: new FormData(form),
            })
            .then(res => res.json())
            .then(data => {
                alert(data.message);
                if (data.success) window.location.reload();
            })
            .catch(err => console.error('Error marking read:', err));
        });
    });

    // Logout
    document.getElementById('logoutForm').addEventListener('submit', (e) => {
        e.preventDefault();
        fetch('/admin/logout', {
            method: 'POST',
            body: new FormData(e.target),
        })
        .then(() => window.location = '/')
        .catch(err => console.error('Error logging out:', err));
    });

    // Pause Voting
    document.getElementById('pauseVotingForm')?.addEventListener('submit', (e) => {
        e.preventDefault();
        if (confirm('Pause the current voting session?')) {
            fetch('/pause_voting', {
                method: 'POST',
                body: new FormData(e.target),
            })
            .then(res => res.json())
            .then(data => {
                alert(data.message);
                if (data.success) window.location.reload();
            })
            .catch(err => console.error('Error pausing voting:', err));
        }
    });

    // Close Voting
    document.getElementById('closeVotingForm')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const pwd = document.querySelector('#closeVotingForm input[name="password"]').value;
        if (!pwd) {
            alert('Admin password is required.');
            return;
        }
        if (confirm('Close the current voting session and process votes?')) {
            fetch('/close_voting', {
                method: 'POST',
                body: new FormData(e.target),
            })
            .then(res => res.json())
            .then(data => {
                alert(data.message);
                if (data.success) window.location.reload();
            })
            .catch(err => console.error('Error closing voting:', err));
        }
    });
});
</script>

{% endblock %}
