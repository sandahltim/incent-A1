{% extends "base.html" %}
{% import "macros.html" as macros %}
{# admin_manage.html #}
{# Version: 2.0.0 - Major UI/UX Redesign #}
{# Enhanced collapsible sections, minigame management, role-based visibility #}

{% block content %}
<div class="vegas-wrapper">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message|safe }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Admin Header -->
    <div class="admin-header">
        <div class="admin-title">
            <h1>üé∞ Admin Dashboard</h1>
            <div class="admin-info">
                <span class="admin-role">{{ 'Master Admin' if session.is_master else 'Admin' }}</span>
                <span class="admin-user">{{ session.admin_id }}</span>
            </div>
        </div>
        
        <div class="admin-actions">
            <button class="btn btn-outline-light btn-sm" onclick="toggleAllSections()">
                <i class="fas fa-expand-arrows-alt"></i> Toggle All
            </button>
            <a href="{{ url_for('admin_logout') }}" class="btn btn-outline-danger btn-sm">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </div>
    </div>

    <div class="container-fluid admin-dashboard">
        <!-- Quick Stats Overview -->
        <div class="stats-overview mb-4">
            <div class="stat-card">
                <div class="stat-number">{{ employees|length }}</div>
                <div class="stat-label">Total Employees</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ mini_games|length }}</div>
                <div class="stat-label">Minigames Played</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${{ "%.0f"|format(pot_info.sales_dollars) }}</div>
                <div class="stat-label">Sales Revenue</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ feedback|length }}</div>
                <div class="stat-label">Feedback Items</div>
            </div>
        </div>

        <!-- Main Admin Sections -->
        <div class="admin-sections">
            
            <!-- üí∞ Financial & Payouts Section -->
            <div class="admin-section" data-section="payouts">
                <div class="section-header" onclick="toggleSection('payouts')">
                    <div class="section-title">
                        <i class="fas fa-dollar-sign"></i>
                        <h3>Financial Management & Payouts</h3>
                    </div>
                    <div class="section-controls">
                        <span class="section-status">{{ employees|selectattr('active', 'equalto', 1)|list|length }} Active Employees</span>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                </div>
                <div class="section-content" id="payouts-content">
                    <!-- Employee Payouts Table -->
                    <div class="content-block">
                        <h4>üíµ Current Employee Payouts</h4>
                        <div class="table-responsive">
                            <table class="table table-striped admin-table">
                                <thead>
                                    <tr>
                                        <th>Employee</th>
                                        <th>Role</th>
                                        <th>Score</th>
                                        <th>Point Value</th>
                                        <th>Estimated Payout</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for emp in employees %}
                                    <tr class="{{ 'table-success' if emp.active else 'table-secondary' }}">
                                        <td>
                                            <strong>{{ emp.name }}</strong><br>
                                            <small class="text-muted">{{ emp.initials }}</small>
                                        </td>
                                        <td><span class="badge bg-primary">{{ emp.role }}</span></td>
                                        <td><span class="score-badge">{{ emp.score }}</span></td>
                                        <td>${{ "%.2f"|format(pot_info.get(emp.role.lower().replace(' ', '_') + '_point_value', 0)) }}</td>
                                        <td><strong>${{ "%.2f"|format(emp.score * pot_info.get(emp.role.lower().replace(' ', '_') + '_point_value', 0)) }}</strong></td>
                                        <td>
                                            <span class="badge {{ 'bg-success' if emp.active else 'bg-secondary' }}">
                                                {{ 'Active' if emp.active else 'Inactive' }}
                                            </span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Pot Management -->
                    <div class="content-block">
                        <h4>üèÜ Incentive Pot Management</h4>
                        <div class="row">
                            <div class="col-md-6">
                                <form id="updatePotForm" action="{{ url_for('admin_update_pot_endpoint') }}" method="POST">
                                    {{ macros.render_csrf_token(id='update_pot_csrf_token') }}
                                    <div class="mb-3">
                                        <label class="form-label">Sales Dollars</label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input type="number" class="form-control" name="sales_dollars" 
                                                   value="{{ update_pot_form.sales_dollars.data or pot_info.sales_dollars }}" required>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Bonus Percent</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" name="bonus_percent" 
                                                   value="{{ update_pot_form.bonus_percent.data or pot_info.bonus_percent }}" 
                                                   step="0.1" required>
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-save"></i> Update Pot
                                    </button>
                                </form>
                            </div>
                            <div class="col-md-6">
                                <div class="pot-summary">
                                    <div class="pot-stat">
                                        <span class="pot-label">Total Pot:</span>
                                        <span class="pot-value">${{ "%.2f"|format(pot_info.sales_dollars * pot_info.bonus_percent / 100) }}</span>
                                    </div>
                                    <div class="pot-stat">
                                        <span class="pot-label">Per Point Value:</span>
                                        <span class="pot-value">${{ "%.2f"|format((pot_info.sales_dollars * pot_info.bonus_percent / 100) / (employees|sum(attribute='score') or 1)) }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Export Options -->
                    <div class="content-block">
                        <h4>üìä Data Export & Reports</h4>
                        <div class="export-buttons">
                            <a href="{{ url_for('admin_export_data', format='all') }}" class="btn btn-outline-primary">
                                <i class="fas fa-download"></i> Export All Data
                            </a>
                            <a href="{{ url_for('admin_export_data', format='month') }}" class="btn btn-outline-info">
                                <i class="fas fa-calendar-alt"></i> Export This Month
                            </a>
                            <a href="{{ url_for('admin_export_data', format='payouts') }}" class="btn btn-outline-success">
                                <i class="fas fa-money-check-alt"></i> Export Payouts
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- üë• Employee Management Section -->
            <div class="admin-section" data-section="employees">
                <div class="section-header" onclick="toggleSection('employees')">
                    <div class="section-title">
                        <i class="fas fa-users"></i>
                        <h3>Employee Management</h3>
                    </div>
                    <div class="section-controls">
                        <button class="btn btn-sm btn-success" onclick="showAddEmployeeModal()">
                            <i class="fas fa-user-plus"></i> Add Employee
                        </button>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                </div>
                <div class="section-content" id="employees-content">
                    <div class="content-block">
                        <h4>üë§ Employee Directory</h4>
                        <div class="employee-grid">
                            {% for emp in employees %}
                            <div class="employee-card {{ 'inactive' if not emp.active }}">
                                <div class="employee-header">
                                    <h5>{{ emp.name }}</h5>
                                    <span class="badge bg-{{ 'success' if emp.active else 'secondary' }}">
                                        {{ 'Active' if emp.active else 'Inactive' }}
                                    </span>
                                </div>
                                <div class="employee-details">
                                    <div class="detail-row">
                                        <span>Initials:</span> <strong>{{ emp.initials }}</strong>
                                    </div>
                                    <div class="detail-row">
                                        <span>Role:</span> <strong>{{ emp.role }}</strong>
                                    </div>
                                    <div class="detail-row">
                                        <span>Score:</span> <strong>{{ emp.score }}</strong>
                                    </div>
                                </div>
                                <div class="employee-actions">
                                    <button class="btn btn-sm btn-primary" onclick="editEmployee('{{ emp.employee_id }}')">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="btn btn-sm btn-warning" onclick="adjustPoints('{{ emp.employee_id }}')">
                                        <i class="fas fa-plus-minus"></i> Points
                                    </button>
                                    {% if emp.active %}
                                    <button class="btn btn-sm btn-secondary" onclick="toggleEmployeeStatus('{{ emp.employee_id }}', false)">
                                        <i class="fas fa-user-slash"></i> Deactivate
                                    </button>
                                    {% else %}
                                    <button class="btn btn-sm btn-success" onclick="toggleEmployeeStatus('{{ emp.employee_id }}', true)">
                                        <i class="fas fa-user-check"></i> Activate
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Point Rules Management -->
                    <div class="content-block">
                        <h4>üìè Point Rules Management</h4>
                        <div class="rules-management">
                            <div class="add-rule-form">
                                <form action="{{ url_for('admin_add_rule') }}" method="POST" class="rule-form">
                                    {{ macros.render_csrf_token() }}
                                    <div class="row g-2">
                                        <div class="col-md-4">
                                            <input type="text" class="form-control" name="description" 
                                                   placeholder="Rule description" required>
                                        </div>
                                        <div class="col-md-2">
                                            <input type="number" class="form-control" name="points" 
                                                   placeholder="Points" required>
                                        </div>
                                        <div class="col-md-4">
                                            <input type="text" class="form-control" name="details" 
                                                   placeholder="Additional details">
                                        </div>
                                        <div class="col-md-2">
                                            <button type="submit" class="btn btn-success w-100">
                                                <i class="fas fa-plus"></i> Add
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            
                            <div class="rules-list">
                                {% for rule in rules %}
                                <div class="rule-item">
                                    <div class="rule-content">
                                        <strong>{{ rule.description }}</strong>
                                        <span class="rule-points">{{ rule.points }} pts</span>
                                        {% if rule.details %}
                                        <div class="rule-details">{{ rule.details }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="rule-actions">
                                        <button class="btn btn-sm btn-outline-primary" onclick="editRule({{ rule.rule_id }})">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteRule({{ rule.rule_id }})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- üé∞ Minigames Management Section -->
            <div class="admin-section" data-section="minigames">
                <div class="section-header" onclick="toggleSection('minigames')">
                    <div class="section-title">
                        <i class="fas fa-dice"></i>
                        <h3>Vegas Casino Minigames</h3>
                    </div>
                    <div class="section-controls">
                        <button class="btn btn-sm btn-warning" onclick="showAwardGameModal()">
                            <i class="fas fa-gift"></i> Award Game
                        </button>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                </div>
                <div class="section-content" id="minigames-content">
                    <!-- Award Games Interface -->
                    <div class="content-block">
                        <h4>üéÅ Award Minigame Tokens</h4>
                        <div class="award-game-form">
                            <form id="awardGameForm">
                                {{ macros.render_csrf_token(id='award_game_csrf_token') }}
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Employee</label>
                                        <select class="form-select" id="award_game_employee" required>
                                            {% for emp in employees if emp.active %}
                                            <option value="{{ emp.employee_id }}">{{ emp.name }} ({{ emp.initials }})</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Game Type</label>
                                        <select class="form-select" id="award_game_type" required>
                                            <option value="slot">üé∞ Slot Machine</option>
                                            <option value="scratch">üé´ Scratch Card</option>
                                            <option value="wheel">üé° Wheel of Fortune</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">Quantity</label>
                                        <input type="number" class="form-control" id="award_game_quantity" value="1" min="1" max="5">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">&nbsp;</label>
                                        <button type="button" class="btn btn-warning w-100" onclick="awardGame()">
                                            <i class="fas fa-gift"></i> Award Games
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Game Statistics -->
                    <div class="content-block">
                        <h4>üìä Game Statistics & Analytics</h4>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="stat-box">
                                    <div class="stat-number">{{ mini_games|selectattr('status', 'equalto', 'unused')|list|length }}</div>
                                    <div class="stat-label">Unused Tokens</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-box">
                                    <div class="stat-number">{{ mini_games|selectattr('status', 'equalto', 'played')|list|length }}</div>
                                    <div class="stat-label">Games Played</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-box">
                                    <div class="stat-number">
                                        {% set wins = [] %}
                                        {% for game in mini_games if game.outcome %}
                                            {% set outcome = game.outcome|from_json %}
                                            {% if outcome and outcome.win %}
                                                {% set _ = wins.append(game) %}
                                            {% endif %}
                                        {% endfor %}
                                        {{ wins|length }}
                                    </div>
                                    <div class="stat-label">Total Wins</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-box">
                                    <div class="stat-number">
                                        {% set total_points = 0 %}
                                        {% for game in mini_games if game.outcome %}
                                            {% set outcome = game.outcome|from_json %}
                                            {% if outcome and outcome.win and outcome.prize_amount %}
                                                {% set total_points = total_points + outcome.prize_amount %}
                                            {% endif %}
                                        {% endfor %}
                                        {{ total_points }}
                                    </div>
                                    <div class="stat-label">Points Awarded</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Detailed Game Results -->
                    <div class="content-block">
                        <h4>üéÆ Detailed Game Results</h4>
                        <div class="game-results-filters mb-3">
                            <div class="row">
                                <div class="col-md-3">
                                    <select class="form-select" id="filter-employee">
                                        <option value="">All Employees</option>
                                        {% for emp in employees %}
                                        <option value="{{ emp.name }}">{{ emp.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select" id="filter-game-type">
                                        <option value="">All Game Types</option>
                                        <option value="slot">Slot Machine</option>
                                        <option value="scratch">Scratch Card</option>
                                        <option value="wheel">Wheel of Fortune</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select" id="filter-status">
                                        <option value="">All Status</option>
                                        <option value="unused">Unused</option>
                                        <option value="played">Played</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-outline-primary w-100" onclick="filterGameResults()">
                                        <i class="fas fa-filter"></i> Filter
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-striped admin-table" id="gameResultsTable">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Employee</th>
                                        <th>Game Type</th>
                                        <th>Status</th>
                                        <th>Awarded</th>
                                        <th>Played</th>
                                        <th>Result</th>
                                        <th>Prize</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for game in mini_games %}
                                    <tr class="game-row" data-employee="{{ game.name }}" data-type="{{ game.game_type }}" data-status="{{ game.status }}">
                                        <td>{{ game.id }}</td>
                                        <td>
                                            <strong>{{ game.employee_name or 'Unknown' }}</strong><br>
                                            <small class="text-muted">{{ game.employee_initials or 'N/A' }}</small>
                                        </td>
                                        <td>
                                            {% if game.game_type == 'slot' %}üé∞ Slot
                                            {% elif game.game_type == 'scratch' %}üé´ Scratch
                                            {% elif game.game_type == 'wheel' %}üé° Wheel
                                            {% else %}{{ game.game_type.title() }}
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-{{ 'warning' if game.status == 'unused' else 'success' }}">
                                                {{ game.status.title() }}
                                            </span>
                                        </td>
                                        <td><small>{{ game.awarded_date }}</small></td>
                                        <td><small>{{ game.played_date or 'Not played' }}</small></td>
                                        <td>
                                            {% if game.outcome %}
                                                {% set outcome = game.outcome|from_json %}
                                                {% if outcome and outcome.win %}
                                                    <span class="badge bg-success">Win</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">Loss</span>
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if game.outcome %}
                                                {% set outcome = game.outcome|from_json %}
                                                {% if outcome and outcome.win %}
                                                    {% if outcome.prize_type == 'points' %}
                                                        <span class="prize-points">{{ outcome.prize_amount }} pts</span>
                                                    {% else %}
                                                        <span class="prize-special">{{ outcome.prize_description or 'Special Prize' }}</span>
                                                    {% endif %}
                                                {% else %}
                                                    <span class="text-muted">No prize</span>
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if game.status == 'unused' %}
                                            <button class="btn btn-sm btn-outline-danger" onclick="revokeGame({{ game.id }})">
                                                <i class="fas fa-times"></i> Revoke
                                            </button>
                                            {% else %}
                                            <button class="btn btn-sm btn-outline-info" onclick="viewGameDetails({{ game.id }})">
                                                <i class="fas fa-eye"></i> Details
                                            </button>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- üó≥Ô∏è Voting Management Section -->
            <div class="admin-section" data-section="voting">
                <div class="section-header" onclick="toggleSection('voting')">
                    <div class="section-title">
                        <i class="fas fa-vote-yea"></i>
                        <h3>Voting System Management</h3>
                    </div>
                    <div class="section-controls">
                        <span class="section-status">{{ 'Active Session' if voting_active else 'No Active Session' }}</span>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                </div>
                <div class="section-content" id="voting-content">
                    <div class="content-block">
                        <h4>üó≥Ô∏è Session Controls</h4>
                        <div class="voting-controls">
                            {% if voting_active %}
                            <div class="alert alert-success">
                                <i class="fas fa-vote-yea"></i> Voting session is currently active
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <h5>Current Session Settings</h5>
                                    <p><strong>Max Plus Votes:</strong> {{ voting_settings.max_plus_votes or 2 }}</p>
                                    <p><strong>Max Minus Votes:</strong> {{ voting_settings.max_minus_votes or 3 }}</p>
                                    <p><strong>Max Total Votes:</strong> {{ voting_settings.max_total_votes or 3 }}</p>
                                </div>
                                <div class="col-md-6">
                                    <button class="btn btn-danger" onclick="endVotingSession()">
                                        <i class="fas fa-stop"></i> End Voting Session
                                    </button>
                                </div>
                            </div>
                            {% else %}
                            <div class="alert alert-warning">
                                <i class="fas fa-pause"></i> No active voting session
                            </div>
                            <div class="voting-setup">
                                <h5>Start New Voting Session</h5>
                                <form id="startVotingForm">
                                    {{ macros.render_csrf_token() }}
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label class="form-label">Max Plus Votes</label>
                                            <input type="number" class="form-control" name="max_plus_votes" value="2" min="1" max="10">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Max Minus Votes</label>
                                            <input type="number" class="form-control" name="max_minus_votes" value="3" min="1" max="10">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Max Total Votes</label>
                                            <input type="number" class="form-control" name="max_total_votes" value="3" min="1" max="10">
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <button type="button" class="btn btn-success" onclick="startVotingSession()">
                                            <i class="fas fa-play"></i> Start Voting Session
                                        </button>
                                    </div>
                                </form>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="content-block">
                        <h4>üìä Voting Statistics</h4>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="stat-box">
                                    <div class="stat-number">{{ votes_today or 0 }}</div>
                                    <div class="stat-label">Votes Today</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-box">
                                    <div class="stat-number">{{ unique_voters_today or 0 }}</div>
                                    <div class="stat-label">Unique Voters</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-box">
                                    <div class="stat-number">{{ plus_votes_today or 0 }}</div>
                                    <div class="stat-label">Plus Votes</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-box">
                                    <div class="stat-number">{{ minus_votes_today or 0 }}</div>
                                    <div class="stat-label">Minus Votes</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="content-block">
                        <h4>üîí Session History</h4>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Duration</th>
                                        <th>Total Votes</th>
                                        <th>Participants</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for session in voting_history %}
                                    <tr>
                                        <td>{{ session.date }}</td>
                                        <td>{{ session.duration }}</td>
                                        <td>{{ session.total_votes }}</td>
                                        <td>{{ session.participants }}</td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if session.status == 'completed' else 'secondary' }}">
                                                {{ session.status.title() }}
                                            </span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- üí¨ Feedback Management Section -->
            <div class="admin-section" data-section="feedback">
                <div class="section-header" onclick="toggleSection('feedback')">
                    <div class="section-title">
                        <i class="fas fa-comments"></i>
                        <h3>Employee Feedback</h3>
                    </div>
                    <div class="section-controls">
                        <span class="section-status">{{ feedback|selectattr('read', 'equalto', 0)|list|length }} Unread</span>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                </div>
                <div class="section-content" id="feedback-content">
                    <div class="content-block">
                        <h4>üí¨ Recent Feedback</h4>
                        {{ macros.render_feedback_table(feedback, 'feedback', 'admin_mark_feedback_read') }}
                    </div>
                </div>
            </div>

            <!-- ‚öôÔ∏è System Settings Section (Master Admin Only) -->
            {% if session.is_master %}
            <div class="admin-section" data-section="settings">
                <div class="section-header" onclick="toggleSection('settings')">
                    <div class="section-title">
                        <i class="fas fa-cogs"></i>
                        <h3>System Settings</h3>
                        <span class="master-only">Master Admin Only</span>
                    </div>
                    <div class="section-controls">
                        <a href="{{ url_for('settings') }}" class="btn btn-sm btn-warning">
                            <i class="fas fa-external-link-alt"></i> Settings Panel
                        </a>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                </div>
                <div class="section-content" id="settings-content">
                    <div class="content-block">
                        <h4>‚öôÔ∏è System Configuration</h4>
                        <p>Advanced system settings are available in the dedicated settings panel.</p>
                        <a href="{{ url_for('settings') }}" class="btn btn-primary">
                            <i class="fas fa-cogs"></i> Open Settings Panel
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Enhanced CSS Styles -->
<style>
.admin-header {
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    color: white;
    padding: 20px;
    border-radius: 15px;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.admin-title h1 {
    margin: 0;
    font-size: 2rem;
}

.admin-info {
    display: flex;
    gap: 10px;
    margin-top: 5px;
}

.admin-role {
    background: #D4AF37;
    color: #000;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: bold;
}

.admin-user {
    background: rgba(255,255,255,0.2);
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
}

.stats-overview {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

.stat-card {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    padding: 20px;
    border-radius: 12px;
    text-align: center;
    border-left: 4px solid #D4AF37;
}

.stat-number {
    font-size: 2rem;
    font-weight: bold;
    color: #2d2d2d;
}

.stat-label {
    color: #6c757d;
    font-size: 0.9rem;
    margin-top: 5px;
}

.admin-section {
    background: white;
    border-radius: 15px;
    margin-bottom: 20px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    overflow: hidden;
}

.section-header {
    background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
    color: white;
    padding: 20px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.3s ease;
}

.section-header:hover {
    background: linear-gradient(135deg, #3d3d3d 0%, #2a2a2a 100%);
}

.section-title {
    display: flex;
    align-items: center;
    gap: 15px;
}

.section-title i {
    font-size: 1.5rem;
    color: #D4AF37;
}

.section-title h3 {
    margin: 0;
    font-size: 1.3rem;
}

.master-only {
    background: #ff6b6b;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: bold;
    margin-left: 10px;
}

.section-controls {
    display: flex;
    align-items: center;
    gap: 15px;
}

.section-status {
    background: rgba(255,255,255,0.2);
    padding: 4px 12px;
    border-radius: 15px;
    font-size: 0.8rem;
}

.toggle-icon {
    transition: transform 0.3s ease;
    font-size: 1.2rem;
}

.section-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
}

.section-content.expanded {
    max-height: none;
    overflow: visible;
}

.content-block {
    padding: 25px;
    border-bottom: 1px solid #e9ecef;
}

.content-block:last-child {
    border-bottom: none;
}

.content-block h4 {
    color: #2d2d2d;
    margin-bottom: 20px;
    font-size: 1.2rem;
}

.employee-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
}

.employee-card {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 20px;
    border-left: 4px solid #28a745;
    transition: all 0.3s ease;
}

.employee-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.employee-card.inactive {
    border-left-color: #6c757d;
    opacity: 0.7;
}

.employee-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.employee-details .detail-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
}

.employee-actions {
    margin-top: 15px;
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.score-badge {
    background: #D4AF37;
    color: white;
    padding: 4px 12px;
    border-radius: 15px;
    font-weight: bold;
}

.rules-management {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 12px;
}

.rule-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background: white;
    border-radius: 8px;
    margin-bottom: 10px;
    border-left: 4px solid #D4AF37;
}

.rule-points {
    background: #e9ecef;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.8rem;
    font-weight: bold;
}

.award-game-form {
    background: #fff3cd;
    padding: 20px;
    border-radius: 12px;
    border-left: 4px solid #ffc107;
}

.stat-box {
    background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
    padding: 20px;
    border-radius: 12px;
    text-align: center;
    border: 1px solid #e9ecef;
}

.stat-box .stat-number {
    font-size: 1.8rem;
    font-weight: bold;
    color: #D4AF37;
}

.game-results-filters {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
}

.prize-points {
    background: #d4edda;
    color: #155724;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.8rem;
    font-weight: bold;
}

.prize-special {
    background: #fff3cd;
    color: #856404;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.8rem;
    font-weight: bold;
}

.admin-table {
    background: white;
}

.admin-table th {
    background: #2d2d2d;
    color: white;
    border: none;
    padding: 15px 10px;
}

.admin-table td {
    padding: 12px 10px;
    vertical-align: middle;
}

.export-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.pot-summary {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 12px;
}

.pot-stat {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
}

.pot-value {
    font-weight: bold;
    color: #D4AF37;
}

/* Responsive Design */
@media (max-width: 768px) {
    .admin-header {
        flex-direction: column;
        gap: 15px;
    }
    
    .stats-overview {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .employee-grid {
        grid-template-columns: 1fr;
    }
    
    .employee-actions {
        justify-content: center;
    }
    
    .export-buttons {
        justify-content: center;
    }
}
</style>

<!-- Enhanced JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize all sections as collapsed except the first one
    const sections = document.querySelectorAll('.admin-section');
    sections.forEach((section, index) => {
        if (index === 0) {
            section.querySelector('.section-content').classList.add('expanded');
            section.querySelector('.section-content').style.maxHeight = 'none';
        }
    });
});

function toggleSection(sectionName) {
    const section = document.querySelector(`[data-section="${sectionName}"]`);
    const content = section.querySelector('.section-content');
    const icon = section.querySelector('.toggle-icon');
    
    if (content.classList.contains('expanded')) {
        content.classList.remove('expanded');
        content.style.maxHeight = '0';
        icon.style.transform = 'rotate(0deg)';
    } else {
        // Close other sections first
        document.querySelectorAll('.section-content.expanded').forEach(otherContent => {
            otherContent.classList.remove('expanded');
            otherContent.style.maxHeight = '0';
        });
        document.querySelectorAll('.toggle-icon').forEach(otherIcon => {
            otherIcon.style.transform = 'rotate(0deg)';
        });
        
        // Open this section
        content.classList.add('expanded');
        content.style.maxHeight = 'none';
        icon.style.transform = 'rotate(180deg)';
    }
}

function toggleAllSections() {
    const sections = document.querySelectorAll('.section-content');
    const allExpanded = Array.from(sections).every(section => section.classList.contains('expanded'));
    
    sections.forEach(section => {
        const icon = section.parentElement.querySelector('.toggle-icon');
        if (allExpanded) {
            section.classList.remove('expanded');
            section.style.maxHeight = '0';
            icon.style.transform = 'rotate(0deg)';
        } else {
            section.classList.add('expanded');
            section.style.maxHeight = 'none';
            icon.style.transform = 'rotate(180deg)';
        }
    });
}

// Enhanced award game function
async function awardGame() {
    const employeeId = document.getElementById('award_game_employee').value;
    const gameType = document.getElementById('award_game_type').value;
    const quantity = document.getElementById('award_game_quantity').value;
    
    if (!employeeId || !gameType) {
        alert('Please select both employee and game type.');
        return;
    }
    
    try {
        const formData = new FormData();
        formData.append('employee_id', employeeId);
        formData.append('game_type', gameType);
        formData.append('quantity', quantity);
        formData.append('csrf_token', document.querySelector('input[name="csrf_token"]').value);
        
        const response = await fetch('/admin/award_game', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(`Success! Awarded ${quantity} ${gameType} game(s) to employee.`);
            setTimeout(() => location.reload(), 1000);
        } else {
            alert(`Error: ${result.message}`);
        }
        
    } catch (error) {
        console.error('Error awarding game:', error);
        alert('An error occurred while awarding the game.');
    }
}

// Filter game results
function filterGameResults() {
    const employeeFilter = document.getElementById('filter-employee').value;
    const typeFilter = document.getElementById('filter-game-type').value;
    const statusFilter = document.getElementById('filter-status').value;
    
    const rows = document.querySelectorAll('.game-row');
    
    rows.forEach(row => {
        const employee = row.dataset.employee;
        const type = row.dataset.type;
        const status = row.dataset.status;
        
        const matchEmployee = !employeeFilter || employee.includes(employeeFilter);
        const matchType = !typeFilter || type === typeFilter;
        const matchStatus = !statusFilter || status === statusFilter;
        
        if (matchEmployee && matchType && matchStatus) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// Employee management functions
function editEmployee(employeeId) {
    // Load employee data and show modal
    fetch(`/admin/get_employee/${employeeId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('edit_employee_id').value = employeeId;
                document.getElementById('edit_name').value = data.employee.name;
                document.getElementById('edit_initials').value = data.employee.initials;
                document.getElementById('edit_role').value = data.employee.role;
                
                const modal = new bootstrap.Modal(document.getElementById('editEmployeeModal'));
                modal.show();
            } else {
                alert('Failed to load employee data');
            }
        })
        .catch(error => {
            console.error('Error loading employee:', error);
            alert('Error loading employee data');
        });
}

function adjustPoints(employeeId) {
    document.getElementById('adjust_employee_id').value = employeeId;
    const modal = new bootstrap.Modal(document.getElementById('adjustPointsModal'));
    modal.show();
}

function toggleEmployeeStatus(employeeId, activate) {
    const endpoint = activate ? '/admin/reactivate_employee' : '/admin/retire_employee';
    const action = activate ? 'reactivate' : 'deactivate';
    
    if (confirm(`Are you sure you want to ${action} this employee?`)) {
        fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `employee_id=${employeeId}&csrf_token=${document.querySelector('input[name="csrf_token"]').value}`
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            if (data.success) {
                window.location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred');
        });
    }
}

function showAddEmployeeModal() {
    const modal = new bootstrap.Modal(document.getElementById('addEmployeeModal'));
    modal.show();
}

// Game management functions
function revokeGame(gameId) {
    if (confirm('Are you sure you want to revoke this unused game token?')) {
        fetch('/admin/revoke_game', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `game_id=${gameId}&csrf_token=${document.querySelector('input[name="csrf_token"]').value}`
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            if (data.success) {
                window.location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred');
        });
    }
}

function viewGameDetails(gameId) {
    fetch(`/admin/game_details/${gameId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const game = data.game;
                document.getElementById('game_details_content').innerHTML = `
                    <p><strong>Game ID:</strong> ${game.id}</p>
                    <p><strong>Employee:</strong> ${game.employee_name || 'Unknown'}</p>
                    <p><strong>Game Type:</strong> ${game.game_type}</p>
                    <p><strong>Status:</strong> ${game.status}</p>
                    <p><strong>Awarded:</strong> ${game.awarded_date}</p>
                    ${game.played_date ? `<p><strong>Played:</strong> ${game.played_date}</p>` : ''}
                    ${game.outcome ? `<p><strong>Outcome:</strong> ${JSON.stringify(game.outcome)}</p>` : ''}
                `;
                
                const modal = new bootstrap.Modal(document.getElementById('gameDetailsModal'));
                modal.show();
            } else {
                alert('Failed to load game details');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading game details');
        });
}

// Rule management functions
function editRule(ruleId) {
    fetch(`/admin/get_rule/${ruleId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('edit_rule_id').value = ruleId;
                document.getElementById('edit_rule_description').value = data.rule.description;
                document.getElementById('edit_rule_points').value = data.rule.points;
                document.getElementById('edit_rule_details').value = data.rule.details || '';
                
                const modal = new bootstrap.Modal(document.getElementById('editRuleModal'));
                modal.show();
            } else {
                alert('Failed to load rule data');
            }
        })
        .catch(error => {
            console.error('Error loading rule:', error);
            alert('Error loading rule data');
        });
}

function deleteRule(ruleId) {
    if (confirm('Are you sure you want to delete this rule?')) {
        fetch('/admin/remove_rule', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `rule_id=${ruleId}&csrf_token=${document.querySelector('input[name="csrf_token"]').value}`
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            if (data.success) {
                window.location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred');
        });
    }
}

// Voting session functions
function startVotingSession() {
    const form = document.getElementById('startVotingForm');
    const formData = new FormData(form);
    
    fetch('/admin/start_voting_session', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message);
        if (data.success) {
            window.location.reload();
        }
    })
    .catch(error => console.error('Error:', error));
}

function endVotingSession() {
    if (confirm('Are you sure you want to end the current voting session?')) {
        fetch('/admin/end_voting_session', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `csrf_token=${document.querySelector('input[name="csrf_token"]').value}`
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            if (data.success) {
                window.location.reload();
            }
        })
        .catch(error => console.error('Error:', error));
    }
}
</script>

<!-- Modal Dialogs -->

<!-- Add Employee Modal -->
<div class="modal fade" id="addEmployeeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Employee</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="/admin/add" method="POST">
                <div class="modal-body">
                    {{ macros.render_csrf_token() }}
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Initials</label>
                        <input type="text" class="form-control" name="initials" maxlength="3" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Role</label>
                        <select class="form-select" name="role" required>
                            {% for role in roles %}
                            <option value="{{ role.role }}">{{ role.role }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Add Employee</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Employee Modal -->
<div class="modal fade" id="editEmployeeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Employee</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="/admin/edit_employee" method="POST">
                <div class="modal-body">
                    {{ macros.render_csrf_token() }}
                    <input type="hidden" id="edit_employee_id" name="employee_id">
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-control" id="edit_name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Initials</label>
                        <input type="text" class="form-control" id="edit_initials" name="initials" maxlength="3" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Role</label>
                        <select class="form-select" id="edit_role" name="role" required>
                            {% for role in roles %}
                            <option value="{{ role.role }}">{{ role.role }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Adjust Points Modal -->
<div class="modal fade" id="adjustPointsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Adjust Points</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="/admin/adjust_points" method="POST">
                <div class="modal-body">
                    {{ macros.render_csrf_token() }}
                    <input type="hidden" id="adjust_employee_id" name="employee_id">
                    <div class="mb-3">
                        <label class="form-label">Points Adjustment</label>
                        <input type="number" class="form-control" name="points" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Reason</label>
                        <input type="text" class="form-control" name="reason" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">Adjust Points</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Rule Modal -->
<div class="modal fade" id="editRuleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Rule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="/admin/edit_rule" method="POST">
                <div class="modal-body">
                    {{ macros.render_csrf_token() }}
                    <input type="hidden" id="edit_rule_id" name="rule_id">
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-control" id="edit_rule_description" name="description" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Points</label>
                        <input type="number" class="form-control" id="edit_rule_points" name="points" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Details</label>
                        <input type="text" class="form-control" id="edit_rule_details" name="details">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Game Details Modal -->
<div class="modal fade" id="gameDetailsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Game Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="game_details_content">
                    <!-- Game details will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}