{% extends "base.html" %}
{% import "macros.html" as macros %}
{# admin_manage.html #}
{# Version: 1.2.26 #}
{# Note: Fixed inline code display by ensuring proper Jinja2 syntax and escaping in macros.render_*. Added robust default values for all fields to ensure auto-filling (e.g., Description defaults to 'Enter description', Points to 0). Retained fixes from version 1.2.25 (server-side pre-population, macro consistency). Ensured compatibility with app.py (1.2.50), forms.py (1.2.4), config.py (1.2.5), macros.html (1.2.8), incentive.html (1.2.21), quick_adjust.html (1.2.10), script.js (1.2.34), style.css (1.2.14), base.html (1.2.21), start_voting.html (1.2.4), settings.html (1.2.5), admin_login.html (1.2.5). No changes to core functionality. #}

{% block content %}
<div class="container">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message|safe }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <h1>Admin Dashboard</h1>

    <h2>Voting Controls</h2>
    {% if not voting_active %}
        <form id="startVotingFormUnique" action="{{ url_for('start_voting') }}" method="POST">
            {{ macros.render_csrf_token(id='start_voting_csrf_token') }}
            {{ macros.render_submit_button('Start Voting', id='startVotingBtn', class='btn btn-primary') }}
        </form>
    {% else %}
        <form id="pauseVotingFormUnique" action="{{ url_for('pause_voting') }}" method="POST">
            {{ macros.render_csrf_token(id='pause_voting_csrf_token') }}
            {{ macros.render_submit_button('Pause Voting', class='btn btn-warning') }}
        </form>
        <form id="closeVotingFormUnique" action="{{ url_for('close_voting') }}" method="POST">
            {{ macros.render_csrf_token(id='close_voting_csrf_token') }}
            {{ macros.render_field(close_voting_form.password, id='close_voting_password', label_text='Admin Password', type='password', required=True, value=close_voting_form.password.data if close_voting_form.password.data else '') }}
            {{ macros.render_submit_button('Close Voting', class='btn btn-danger') }}
        </form>
    {% endif %}

    <h2>Add Rule</h2>
    <form id="addRuleFormUnique" action="{{ url_for('admin_add_rule') }}" method="POST">
        {{ macros.render_csrf_token(id='add_rule_csrf_token') }}
        {{ macros.render_field(add_rule_form.description, id='add_rule_description', label_text='Description', required=True, value=add_rule_form.description.data if add_rule_form.description.data else 'Enter description') }}
        {{ macros.render_field(add_rule_form.points, id='add_rule_points', label_text='Points', type='number', required=True, value=add_rule_form.points.data if add_rule_form.points.data else 0) }}
        {{ macros.render_submit_button('Add Rule', class='btn btn-primary') }}
    </form>

    <h2>Rules</h2>
    {{ macros.render_rule_list(rules, 'rule', 'admin_edit_rule', 'admin_remove_rule') }}

    <h2>Add Employee</h2>
    <form id="addEmployeeFormUnique" action="{{ url_for('admin_add') }}" method="POST">
        {{ macros.render_csrf_token(id='add_employee_csrf_token') }}
        {{ macros.render_field(add_employee_form.name, id='add_employee_name', label_text='Name', required=True, value=add_employee_form.name.data if add_employee_form.name.data else 'Enter name') }}
        {{ macros.render_field(add_employee_form.initials, id='add_employee_initials', label_text='Initials', required=True, value=add_employee_form.initials.data if add_employee_form.initials.data else 'Enter initials') }}
        {{ macros.render_select_field(add_employee_form.role, id='add_employee_role', label_text='Role', options=role_options, selected_value=add_employee_form.role.data if add_employee_form.role.data else 'Driver') }}
        {{ macros.render_submit_button('Add Employee', class='btn btn-primary') }}
    </form>

    <h2>Edit Employee</h2>
    <form id="editEmployeeFormUnique" action="{{ url_for('admin_edit_employee') }}" method="POST">
        {{ macros.render_csrf_token(id='edit_employee_csrf_token') }}
        {{ macros.render_select_field(edit_employee_form.employee_id, id='edit_employee_id', label_text='Employee', options=employee_options, selected_value=edit_employee_form.employee_id.data if edit_employee_form.employee_id.data else employee_options[0][0] if employee_options else '') }}
        {{ macros.render_field(edit_employee_form.name, id='edit_employee_name', label_text='Name', required=True, value=edit_employee_form.name.data if edit_employee_form.name.data else 'Enter name') }}
        {{ macros.render_select_field(edit_employee_form.role, id='edit_employee_role', label_text='Role', options=role_options, selected_value=edit_employee_form.role.data if edit_employee_form.role.data else 'Driver') }}
        {{ macros.render_submit_button('Update Employee', class='btn btn-primary') }}
        <button type="button" id="retireBtn" class="btn btn-warning">Retire</button>
        <button type="button" id="reactivateBtn" class="btn btn-success">Reactivate</button>
        <button type="button" id="deleteBtn" class="btn btn-danger">Delete</button>
    </form>

    <h2>Feedback</h2>
    {{ macros.render_feedback_table(feedback, 'feedback', 'admin_mark_feedback_read') }}

    <h2>Update Pot</h2>
    <form id="updatePotFormUnique" action="{{ url_for('admin_update_pot_endpoint') }}" method="POST">
        {{ macros.render_csrf_token(id='update_pot_csrf_token') }}
        {{ macros.render_field(update_pot_form.sales_dollars, id='update_pot_sales_dollars', label_text='Sales Dollars ($)', type='number', required=True, value=update_pot_form.sales_dollars.data if update_pot_form.sales_dollars.data else 100000) }}
        {{ macros.render_field(update_pot_form.bonus_percent, id='update_pot_bonus_percent', label_text='Bonus Percent (%)', type='number', required=True, value=update_pot_form.bonus_percent.data if update_pot_form.bonus_percent.data else 10) }}
        {{ macros.render_submit_button('Update Pot', class='btn btn-primary') }}
    </form>

    <h2>Update Prior Year Sales</h2>
    <form id="updatePriorYearSalesFormUnique" action="{{ url_for('admin_update_prior_year_sales') }}" method="POST">
        {{ macros.render_csrf_token(id='update_prior_year_sales_csrf_token') }}
        {{ macros.render_field(update_prior_year_sales_form.prior_year_sales, id='update_prior_year_sales_prior_year_sales', label_text='Prior Year Sales ($)', type='number', required=True, value=update_prior_year_sales_form.prior_year_sales.data if update_prior_year_sales_form.prior_year_sales.data else 50000) }}
        {{ macros.render_submit_button('Update Prior Year Sales', class='btn btn-primary') }}
    </form>

    <h2>Reset Scores</h2>
    <form id="resetScoresFormUnique" action="{{ url_for('admin_reset') }}" method="POST">
        {{ macros.render_csrf_token(id='reset_scores_csrf_token') }}
        {{ macros.render_submit_button('Reset All Scores', class='btn btn-danger') }}
    </form>

    {% if is_master %}
        <h2>Master Admin Controls</h2>
        <form id="updateAdminFormUnique" action="{{ url_for('admin_update_admin') }}" method="POST">
            {{ macros.render_csrf_token(id='update_admin_csrf_token') }}
            {{ macros.render_select_field(update_admin_form.old_username, id='update_admin_old_username', label_text='Old Username', options=admin_options, selected_value=update_admin_form.old_username.data if update_admin_form.old_username.data else admin_options[0][0] if admin_options else '') }}
            {{ macros.render_field(update_admin_form.new_username, id='update_admin_new_username', label_text='New Username', required=True, value=update_admin_form.new_username.data if update_admin_form.new_username.data else 'Enter username') }}
            {{ macros.render_field(update_admin_form.new_password, id='update_admin_new_password', label_text='New Password', type='password', required=True, value=update_admin_form.new_password.data if update_admin_form.new_password.data else 'Enter password') }}
            {{ macros.render_submit_button('Update Admin', class='btn btn-primary') }}
        </form>

        <form id="masterResetFormUnique" action="{{ url_for('admin_master_reset') }}" method="POST">
            {{ macros.render_csrf_token(id='master_reset_csrf_token') }}
            {{ macros.render_field(master_reset_form.password, id='master_reset_password', label_text='Master Password', type='password', required=True, value=master_reset_form.password.data if master_reset_form.password.data else 'Enter password') }}
            {{ macros.render_submit_button('Master Reset', class='btn btn-danger') }}
        </form>
    {% endif %}
</div>
{% endblock %}