{% extends "base.html" %}
{% import "macros.html" as macros %}
{# admin_manage.html #}
{# Version: 2.0.0 - Major UI/UX Redesign #}
{# Enhanced collapsible sections, minigame management, role-based visibility #}

{% block content %}
<div class="vegas-wrapper">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message|safe }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Admin Header -->
    <div class="admin-header">
        <div class="admin-title">
            <h1>üé∞ Admin Dashboard</h1>
            <div class="admin-info">
                <span class="admin-role">{{ 'Master Admin' if is_master else 'Admin' }}</span>
                <span class="admin-user">{{ session.admin_id }}</span>
            </div>
        </div>
        
        <div class="admin-actions">
            <a href="{{ url_for('admin_analytics') }}" class="btn btn-outline-success btn-sm">
                <i class="fas fa-chart-line"></i> Analytics
            </a>
            <button class="btn btn-outline-light btn-sm" onclick="toggleAllSections()">
                <i class="fas fa-expand-arrows-alt"></i> Toggle All
            </button>
            <a href="{{ url_for('admin_logout') }}" class="btn btn-outline-danger btn-sm">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </div>
    </div>

    <div class="container-fluid admin-dashboard">
        <!-- Quick Stats Overview -->
        <div class="stats-overview mb-4">
            <div class="stat-card">
                <div class="stat-number">{{ employees|length }}</div>
                <div class="stat-label">Total Employees</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ mini_games|length }}</div>
                <div class="stat-label">Minigames Played</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${{ "%.0f"|format(pot_info.sales_dollars) }}</div>
                <div class="stat-label">Sales Revenue</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ feedback|length }}</div>
                <div class="stat-label">Feedback Items</div>
            </div>
        </div>

        <!-- Main Admin Sections -->
        <div class="admin-sections">
            
            <!-- üí∞ Financial & Payouts Section -->
            <div class="admin-section" data-section="payouts">
                <div class="section-header" onclick="toggleSection('payouts')">
                    <div class="section-title">
                        <i class="fas fa-dollar-sign"></i>
                        <h3>Financial Management & Payouts</h3>
                    </div>
                    <div class="section-controls">
                        <span class="section-status">{{ employees|selectattr('active', 'equalto', 1)|list|length }} Active Employees</span>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                </div>
                <div class="section-content" id="payouts-content">
                    <!-- Employee Payouts Table -->
                    <div class="content-block">
                        <h4>üíµ Current Employee Payouts</h4>
                        <div class="table-responsive">
                            <table class="table table-striped admin-table">
                                <thead>
                                    <tr>
                                        <th>Employee</th>
                                        <th>Role</th>
                                        <th>Score</th>
                                        <th>Point Value</th>
                                        <th>Estimated Payout</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for emp in employees %}
                                    <tr class="{{ 'table-success' if emp.active else 'table-secondary' }}">
                                        <td>
                                            <strong>{{ emp.name }}</strong><br>
                                            <small class="text-muted">{{ emp.initials }}</small>
                                        </td>
                                        <td><span class="badge bg-primary">{{ emp.role }}</span></td>
                                        <td><span class="score-badge">{{ emp.score }}</span></td>
                                        <td>${{ "%.2f"|format(pot_info.get(emp.role.lower().replace(' ', '_') + '_point_value', 0)) }}</td>
                                        <td><strong>${{ "%.2f"|format(emp.score * pot_info.get(emp.role.lower().replace(' ', '_') + '_point_value', 0) if emp.active and emp.score >= 50 else 0) }}</strong></td>
                                        <td>
                                            <span class="badge {{ 'bg-success' if emp.active else 'bg-secondary' }}">
                                                {{ 'Active' if emp.active else 'Inactive' }}
                                            </span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Pot Management -->
                    <div class="content-block">
                        <h4>üèÜ Incentive Pot Management</h4>
                        <div class="row">
                            <div class="col-md-6">
                                <form id="updatePotForm">
                                    {{ macros.render_csrf_token(id='update_pot_csrf_token') }}
                                    <div class="mb-3">
                                        <label class="form-label">Sales Dollars</label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input type="number" class="form-control" name="sales_dollars" 
                                                   value="{{ update_pot_form.sales_dollars.data or pot_info.sales_dollars }}" required>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Bonus Percent</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" name="bonus_percent" 
                                                   value="{{ update_pot_form.bonus_percent.data or pot_info.bonus_percent }}" 
                                                   step="0.1" required>
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-success" onclick="updatePot()">
                                        <i class="fas fa-save"></i> Update Pot
                                    </button>
                                </form>
                            </div>
                            <div class="col-md-6">
                                <div class="pot-summary">
                                    <div class="pot-stat">
                                        <span class="pot-label">Total Pot:</span>
                                        <span class="pot-value">${{ "%.2f"|format(pot_info.sales_dollars * pot_info.bonus_percent / 100) }}</span>
                                    </div>
                                    <div class="pot-stat">
                                        <span class="pot-label">Per Point Value:</span>
                                        <span class="pot-value">${{ "%.2f"|format((pot_info.sales_dollars * pot_info.bonus_percent / 100) / (employees|sum(attribute='score') or 1)) }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Database Import/Export Options -->
                    <div class="content-block">
                        <h4>üìä Database Import/Export</h4>
                        
                        <!-- Tabbed Interface for Import/Export -->
                        <ul class="nav nav-pills nav-fill mb-3" id="importExportTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="export-tab" data-bs-toggle="pill" data-bs-target="#export-panel" type="button" role="tab">
                                    <i class="fas fa-upload"></i> Export Data
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="import-tab" data-bs-toggle="pill" data-bs-target="#import-panel" type="button" role="tab">
                                    <i class="fas fa-download"></i> Import Data
                                </button>
                            </li>
                        </ul>

                        <div class="tab-content" id="importExportContent">
                            <!-- Export Panel -->
                            <div class="tab-pane fade show active" id="export-panel" role="tabpanel">
                                <div class="row g-3">
                                    <!-- Quick CSV Exports -->
                                    <div class="col-lg-8">
                                        <div class="card border-0 bg-light">
                                            <div class="card-body p-3">
                                                <h6 class="card-title mb-3">
                                                    <i class="fas fa-table text-primary"></i> Quick CSV Exports
                                                </h6>
                                                <div class="d-grid gap-2 d-sm-flex flex-wrap">
                                                    <button class="btn btn-outline-primary btn-sm" onclick="exportCSV('employees')">
                                                        <i class="fas fa-users"></i> Employees
                                                    </button>
                                                    <button class="btn btn-outline-info btn-sm" onclick="exportCSV('score_history')">
                                                        <i class="fas fa-history"></i> Scores
                                                    </button>
                                                    <button class="btn btn-outline-warning btn-sm" onclick="exportCSV('votes')">
                                                        <i class="fas fa-vote-yea"></i> Votes
                                                    </button>
                                                    <button class="btn btn-outline-success btn-sm" onclick="exportCSV('incentive_rules')">
                                                        <i class="fas fa-list"></i> Rules
                                                    </button>
                                                    <button class="btn btn-outline-secondary btn-sm" onclick="exportCSV('roles')">
                                                        <i class="fas fa-user-tag"></i> Roles
                                                    </button>
                                                    <button class="btn btn-outline-danger btn-sm" onclick="exportCSV('mini_games')">
                                                        <i class="fas fa-gamepad"></i> Games
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Legacy Reports -->
                                    <div class="col-lg-4">
                                        <div class="card border-0 bg-light">
                                            <div class="card-body p-3">
                                                <h6 class="card-title mb-3">
                                                    <i class="fas fa-chart-line text-success"></i> Legacy Reports
                                                </h6>
                                                <div class="d-grid gap-1">
                                                    <button class="btn btn-outline-primary btn-sm" onclick="exportData('all')">
                                                        <i class="fas fa-download"></i> All Data
                                                    </button>
                                                    <button class="btn btn-outline-info btn-sm" onclick="exportData('month')">
                                                        <i class="fas fa-calendar-alt"></i> This Month
                                                    </button>
                                                    <button class="btn btn-outline-success btn-sm" onclick="exportData('payouts')">
                                                        <i class="fas fa-money-check-alt"></i> Payouts
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Import Panel -->
                            <div class="tab-pane fade" id="import-panel" role="tabpanel">
                                <div class="row g-3">
                                    <!-- Database Dump Import -->
                                    <div class="col-lg-4">
                                        <div class="card h-100">
                                            <div class="card-header bg-warning bg-opacity-10 py-2">
                                                <h6 class="mb-0">
                                                    <i class="fas fa-database text-warning"></i> Database Dump
                                                </h6>
                                            </div>
                                            <div class="card-body p-3">
                                                <form id="databaseDumpImportForm" enctype="multipart/form-data">
                                                    {{ macros.render_csrf_token(id='dump_import_csrf_token') }}
                                                    <div class="mb-2">
                                                        <input type="file" id="dump_file" name="dump_file" class="form-control form-control-sm" accept=".csv,.txt" required>
                                                        <div class="form-text">Multi-table dump file</div>
                                                    </div>
                                                    <div class="mb-3">
                                                        <select id="dump_import_mode" name="dump_import_mode" class="form-select form-select-sm">
                                                            <option value="merge">Merge Data</option>
                                                            <option value="replace">Replace All (Master)</option>
                                                        </select>
                                                    </div>
                                                    <button type="submit" class="btn btn-warning btn-sm w-100">
                                                        <i class="fas fa-database"></i> Import Dump
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- CSV Import -->
                                    <div class="col-lg-4">
                                        <div class="card h-100">
                                            <div class="card-header bg-primary bg-opacity-10 py-2">
                                                <h6 class="mb-0">
                                                    <i class="fas fa-file-csv text-primary"></i> CSV Import
                                                </h6>
                                            </div>
                                            <div class="card-body p-3">
                                                <form id="csvImportForm" enctype="multipart/form-data">
                                                    {{ macros.render_csrf_token(id='csv_import_csrf_token') }}
                                                    <div class="mb-2">
                                                        <input type="file" id="csv_file" name="csv_file" class="form-control form-control-sm" accept=".csv" required>
                                                        <div class="form-text">Single table CSV</div>
                                                    </div>
                                                    <div class="mb-2">
                                                        <select id="table_name" name="table_name" class="form-select form-select-sm" required>
                                                            <option value="">Select table...</option>
                                                            <option value="employees">Employees</option>
                                                            <option value="incentive_rules">Rules</option>
                                                            <option value="roles">Roles</option>
                                                        </select>
                                                    </div>
                                                    <div class="mb-3">
                                                        <select id="import_mode" name="import_mode" class="form-select form-select-sm">
                                                            <option value="append">Append Data</option>
                                                            <option value="replace">Replace Table (Master)</option>
                                                        </select>
                                                    </div>
                                                    <button type="submit" class="btn btn-primary btn-sm w-100">
                                                        <i class="fas fa-upload"></i> Import CSV
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- JSON Import -->
                                    <div class="col-lg-4">
                                        <div class="card h-100">
                                            <div class="card-header bg-info bg-opacity-10 py-2">
                                                <h6 class="mb-0">
                                                    <i class="fas fa-file-code text-info"></i> JSON Import
                                                </h6>
                                            </div>
                                            <div class="card-body p-3">
                                                <form id="jsonImportForm" enctype="multipart/form-data" action="{{ url_for('admin_import_json') }}" method="POST">
                                                    {{ macros.render_csrf_token(id='json_import_csrf_token') }}
                                                    <div class="mb-2">
                                                        <input type="file" id="json_file" name="json_file" class="form-control form-control-sm" accept=".json" required>
                                                        <div class="form-text">Structured JSON data</div>
                                                    </div>
                                                    <div class="mb-3">
                                                        <select id="json_table_name" name="table_name" class="form-select form-select-sm" required>
                                                            <option value="">Select table...</option>
                                                            <option value="employees">Employees</option>
                                                            <option value="scores_log">Score History</option>
                                                            <option value="mini_games">Mini Games</option>
                                                            <option value="incentive_rules">Rules</option>
                                                            <option value="roles">Roles</option>
                                                            <option value="votes">Votes</option>
                                                            <option value="feedback">Feedback</option>
                                                        </select>
                                                    </div>
                                                    <div id="json_import_result" class="mb-2" style="display: none;">
                                                        <!-- Success/Error messages will appear here -->
                                                    </div>
                                                    <button type="submit" class="btn btn-info btn-sm w-100">
                                                        <i class="fas fa-file-import"></i> Import JSON
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Import Format Reference -->
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <div class="accordion" id="formatReference">
                                            <div class="accordion-item border-0">
                                                <h2 class="accordion-header">
                                                    <button class="accordion-button collapsed bg-light" type="button" data-bs-toggle="collapse" data-bs-target="#formatHelp">
                                                        <i class="fas fa-question-circle text-muted me-2"></i>
                                                        Import Format Reference
                                                    </button>
                                                </h2>
                                                <div id="formatHelp" class="accordion-collapse collapse" data-bs-parent="#formatReference">
                                                    <div class="accordion-body p-3">
                                                        <div class="row g-3">
                                                            <div class="col-md-4">
                                                                <div class="bg-warning bg-opacity-10 p-2 rounded">
                                                                    <h6 class="text-warning mb-2">
                                                                        <i class="fas fa-database"></i> Database Dump
                                                                    </h6>
                                                                    <p class="small mb-1">Multi-table format:</p>
                                                                    <code class="small">
                                                                        # TABLE: employees<br>
                                                                        employee_id,name,initials...<br>
                                                                        E001,John Doe,jd...<br><br>
                                                                        # TABLE: votes<br>
                                                                        vote_id,voter_initials...
                                                                    </code>
                                                                    <div class="alert alert-warning alert-sm mt-2 mb-0 py-1">
                                                                        <small><strong>‚ö†Ô∏è</strong> Replace mode clears all data!</small>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="col-md-4">
                                                                <div class="bg-primary bg-opacity-10 p-2 rounded">
                                                                    <h6 class="text-primary mb-2">
                                                                        <i class="fas fa-file-csv"></i> CSV Format
                                                                    </h6>
                                                                    <p class="small mb-1">Required columns:</p>
                                                                    <ul class="small mb-0 ps-3">
                                                                        <li><strong>Employees:</strong> employee_id, name, initials</li>
                                                                        <li><strong>Rules:</strong> description, points</li>
                                                                        <li><strong>Roles:</strong> role_name</li>
                                                                    </ul>
                                                                </div>
                                                            </div>
                                                            <div class="col-md-4">
                                                                <div class="bg-info bg-opacity-10 p-2 rounded">
                                                                    <h6 class="text-info mb-2">
                                                                        <i class="fas fa-file-code"></i> JSON Format
                                                                    </h6>
                                                                    <p class="small mb-1">Array of objects:</p>
                                                                    <code class="small">
                                                                        [<br>
                                                                        &nbsp;{<br>
                                                                        &nbsp;&nbsp;"employee_id": "E001",<br>
                                                                        &nbsp;&nbsp;"name": "John Doe"<br>
                                                                        &nbsp;}<br>
                                                                        ]
                                                                    </code>
                                                                    <div class="alert alert-info alert-sm mt-2 mb-0 py-1">
                                                                        <small><strong>üí°</strong> Field names must match DB columns</small>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Payout Export for Accounting -->
                    <div class="content-block">
                        <h4>üìã Payout Export for Accounting</h4>
                        <form id="payoutExportForm" class="export-form">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label for="export_start_date" class="form-label">Start Date</label>
                                    <input type="date" id="export_start_date" name="start_date" class="form-control" 
                                           value="{{ default_start_date }}" required>
                                </div>
                                <div class="col-md-4">
                                    <label for="export_end_date" class="form-label">End Date</label>
                                    <input type="date" id="export_end_date" name="end_date" class="form-control" 
                                           value="{{ default_end_date }}" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">&nbsp;</label>
                                    <button type="button" class="btn btn-success w-100" onclick="exportPayoutCSV()">
                                        <i class="fas fa-file-csv"></i> Export Payout CSV
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Reset Controls -->
                    <div class="content-block">
                        <h4>üîÑ Reset Controls</h4>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <form id="resetScoresForm">
                                    {{ macros.render_csrf_token() }}
                                    <button type="button" class="btn btn-warning w-100" onclick="resetScores()">
                                        <i class="fas fa-undo"></i> Reset All Scores to 50
                                    </button>
                                </form>
                            </div>
                            {% if is_master %}
                            <div class="col-md-4">
                                <form id="masterResetForm">
                                    {{ macros.render_csrf_token() }}
                                    <button type="button" class="btn btn-danger w-100" onclick="masterReset()">
                                        <i class="fas fa-exclamation-triangle"></i> Reset to Install State
                                    </button>
                                </form>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- üë• Employee Management Section -->
            <div class="admin-section" data-section="employees">
                <div class="section-header" onclick="toggleSection('employees')">
                    <div class="section-title">
                        <i class="fas fa-users"></i>
                        <h3>Employee Management</h3>
                    </div>
                    <div class="section-controls">
                        <button class="btn btn-sm btn-success" onclick="showAddEmployeeModal()">
                            <i class="fas fa-user-plus"></i> Add Employee
                        </button>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                </div>
                <div class="section-content" id="employees-content">
                    <div class="content-block">
                        <h4>üë§ Employee Directory</h4>
                        <div class="employee-grid">
                            {% for emp in employees %}
                            <div class="employee-card {{ 'inactive' if not emp.active }}">
                                <div class="employee-header">
                                    <h5>{{ emp.name }}</h5>
                                    <span class="badge bg-{{ 'success' if emp.active else 'secondary' }}">
                                        {{ 'Active' if emp.active else 'Inactive' }}
                                    </span>
                                </div>
                                <div class="employee-details">
                                    <div class="detail-row">
                                        <span>Initials:</span> <strong>{{ emp.initials }}</strong>
                                    </div>
                                    <div class="detail-row">
                                        <span>Role:</span> <strong>{{ emp.role }}</strong>
                                    </div>
                                    <div class="detail-row">
                                        <span>Score:</span> <strong>{{ emp.score }}</strong>
                                    </div>
                                </div>
                                <div class="employee-actions">
                                    <button class="btn btn-sm btn-primary" onclick="editEmployee('{{ emp.employee_id }}')">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="btn btn-sm btn-warning" onclick="adjustPoints('{{ emp.employee_id }}')">
                                        <i class="fas fa-plus-minus"></i> Points
                                    </button>
                                    {% if emp.active %}
                                    <button class="btn btn-sm btn-secondary" onclick="toggleEmployeeStatus('{{ emp.employee_id }}', false)">
                                        <i class="fas fa-user-slash"></i> Deactivate
                                    </button>
                                    {% else %}
                                    <button class="btn btn-sm btn-success" onclick="toggleEmployeeStatus('{{ emp.employee_id }}', true)">
                                        <i class="fas fa-user-check"></i> Activate
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Point Rules Management -->
                    <div class="content-block">
                        <h4>üìè Point Rules Management</h4>
                        <div class="rules-management">
                            <div class="add-rule-form">
                                <form id="addRuleForm" class="rule-form">
                                    {{ macros.render_csrf_token() }}
                                    <div class="row g-2">
                                        <div class="col-md-4">
                                            <input type="text" class="form-control" name="description" 
                                                   placeholder="Rule description" required>
                                        </div>
                                        <div class="col-md-2">
                                            <input type="number" class="form-control" name="points" 
                                                   placeholder="Points" required>
                                        </div>
                                        <div class="col-md-4">
                                            <input type="text" class="form-control" name="details" 
                                                   placeholder="Additional details">
                                        </div>
                                        <div class="col-md-2">
                                            <button type="button" class="btn btn-success w-100" onclick="addRule()">
                                                <i class="fas fa-plus"></i> Add
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            
                            <div class="rules-list">
                                {% for rule in rules %}
                                <div class="rule-item">
                                    <div class="rule-content">
                                        <strong>{{ rule.description }}</strong>
                                        <span class="rule-points">{{ rule.points }} pts</span>
                                        {% if rule.details %}
                                        <div class="rule-details">{{ rule.details }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="rule-actions">
                                        <button class="btn btn-sm btn-outline-primary" onclick="editRule({{ rule.rule_id }})">
                                            <i class="fas fa-edit"></i> Edit
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteRule({{ rule.rule_id }})">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Point Decay Management -->
                <div class="content-block">
                    <h4>‚è∞ Point Decay Management</h4>
                    <p>Configure automatic daily point deductions for employee roles on specific days.</p>
                    
                    <form id="setPointDecayFormUnique" action="{{ url_for('admin_set_point_decay') }}" method="POST" class="mb-4" data-decay='{{ decay | tojson }}'>
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        
                        <div class="mb-3">
                            <label for="set_point_decay_role_name" class="form-label">Role</label>
                            <select class="form-select" id="set_point_decay_role_name" name="role_name" required>
                                {% if decay_role_options %}
                                    {% for value, label in decay_role_options %}
                                        <option value="{{ value }}" {% if set_point_decay_form and set_point_decay_form.role_name.data == value %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                {% endif %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="set_point_decay_points" class="form-label">Points to Deduct Daily</label>
                            <input type="number" class="form-control" id="set_point_decay_points" name="points" 
                                   value="{{ set_point_decay_form.points.data if set_point_decay_form and set_point_decay_form.points.data else 0 }}" 
                                   required min="0">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Days of the Week</label>
                            <div class="row">
                                {% for day_value, day_label in [('Monday', 'Monday'), ('Tuesday', 'Tuesday'), ('Wednesday', 'Wednesday'), ('Thursday', 'Thursday'), ('Friday', 'Friday'), ('Saturday', 'Saturday'), ('Sunday', 'Sunday')] %}
                                <div class="col-md-3 col-sm-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="days" value="{{ day_value }}" id="set_point_decay_{{ day_value }}"
                                               {% if set_point_decay_form and set_point_decay_form.days.data and day_value in set_point_decay_form.days.data %}checked{% endif %}>
                                        <label class="form-check-label" for="set_point_decay_{{ day_value }}">{{ day_label }}</label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-clock me-1"></i>Set Point Decay
                        </button>
                        
                        <div id="decayConfirmation" class="alert alert-success mt-3" style="display: none;"></div>
                    </form>
                </div>
            </div>

            <!-- üé∞ Minigames Management Section -->
            <div class="admin-section" data-section="minigames">
                <div class="section-header" onclick="toggleSection('minigames')">
                    <div class="section-title">
                        <i class="fas fa-dice"></i>
                        <h3>Vegas Casino Minigames</h3>
                    </div>
                    <div class="section-controls">
                        <button class="btn btn-sm btn-info me-1" onclick="openGameDetails()">
                            <i class="fas fa-list"></i> All Games
                        </button>
                        <button class="btn btn-sm btn-success me-1" onclick="openGameAnalytics()">
                            <i class="fas fa-chart-bar"></i> Analytics
                        </button>
                        <button class="btn btn-sm btn-secondary me-1" onclick="openGameSettings()">
                            <i class="fas fa-cog"></i> Settings
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="showAwardGameModal()">
                            <i class="fas fa-gift"></i> Award Game
                        </button>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                </div>
                <div class="section-content" id="minigames-content">
                    <!-- Award Games Interface -->
                    <div class="content-block">
                        <h4>üéÅ Award Minigame Tokens</h4>
                        <div class="award-game-form">
                            <form id="awardGameForm">
                                {{ macros.render_csrf_token(id='award_game_csrf_token') }}
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Employee</label>
                                        <select class="form-select" id="award_game_employee" required>
                                            {% for emp in employees if emp.active %}
                                            <option value="{{ emp.employee_id }}">{{ emp.name }} ({{ emp.initials }})</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Game Type</label>
                                        <select class="form-select" id="award_game_type" required>
                                            <option value="slot">üé∞ Slot Machine</option>
                                            <option value="scratch">üé´ Scratch Card</option>
                                            <option value="wheel">üé° Wheel of Fortune</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">Quantity</label>
                                        <input type="number" class="form-control" id="award_game_quantity" value="1" min="1" max="5">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">&nbsp;</label>
                                        <button type="button" class="btn btn-warning w-100" onclick="awardGame()">
                                            <i class="fas fa-gift"></i> Award Games
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Automatic Game Award Rules -->
                    <div class="content-block">
                        <h4>üéØ Automatic Game Award Rules</h4>
                        <div class="rules-management">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Automatic Rules:</strong> Set conditions for when employees automatically receive mini-game tokens based on their point achievements, performance milestones, or other criteria.
                            </div>
                            
                            <!-- Add New Rule Form -->
                            <div class="add-rule-form mb-4">
                                <form id="addAutoGameRuleForm" class="rule-form">
                                    {{ macros.render_csrf_token() }}
                                    <div class="row g-3">
                                        <div class="col-md-3">
                                            <label class="form-label">Rule Name</label>
                                            <input type="text" class="form-control" name="rule_name" 
                                                   placeholder="e.g., Weekly Point Goal" required>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">Condition Type</label>
                                            <select class="form-select" name="condition_type" required>
                                                <option value="points_threshold">Points Threshold</option>
                                                <option value="points_gained">Points Gained</option>
                                                <option value="weekly_target">Weekly Target</option>
                                                <option value="monthly_target">Monthly Target</option>
                                                <option value="streak">Win Streak</option>
                                                <option value="rank_achievement">Rank Achievement</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">Threshold Value</label>
                                            <input type="number" class="form-control" name="threshold_value" 
                                                   placeholder="100" required min="1">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">Game Type</label>
                                            <select class="form-select" name="game_type" required>
                                                <option value="slot">üé∞ Slot Machine</option>
                                                <option value="scratch">üé´ Scratch Card</option>
                                                <option value="wheel">üé° Wheel of Fortune</option>
                                                <option value="dice">üéØ Dice Game</option>
                                                <option value="random">üé≤ Random Game</option>
                                            </select>
                                        </div>
                                        <div class="col-md-1">
                                            <label class="form-label">Games</label>
                                            <input type="number" class="form-control" name="game_count" 
                                                   value="1" min="1" max="10">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">Chance %</label>
                                            <input type="number" class="form-control" name="award_chance" 
                                                   value="100" min="1" max="100">
                                        </div>
                                    </div>
                                    <div class="row g-3 mt-2">
                                        <div class="col-md-4">
                                            <label class="form-label">Reset Frequency</label>
                                            <select class="form-select" name="reset_frequency">
                                                <option value="none">No Reset (One-time)</option>
                                                <option value="daily">Daily Reset</option>
                                                <option value="weekly">Weekly Reset</option>
                                                <option value="monthly">Monthly Reset</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-check mt-4">
                                                <input class="form-check-input" type="checkbox" name="active" checked>
                                                <label class="form-check-label">Active Rule</label>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">&nbsp;</label>
                                            <button type="button" class="btn btn-success w-100" onclick="addAutoGameRule()">
                                                <i class="fas fa-plus"></i> Add Rule
                                            </button>
                                        </div>
                                    </div>
                                    <div class="row g-3 mt-2">
                                        <div class="col-md-12 text-center">
                                            <button type="button" class="btn btn-warning" onclick="executeAutoRules()">
                                                <i class="fas fa-play"></i> Execute All Active Rules Now
                                            </button>
                                            <small class="text-muted d-block mt-1">Manually trigger automatic rule checking and game awarding</small>
                                        </div>
                                    </div>
                                </form>
                            </div>

                            <!-- Existing Rules -->
                            <div class="existing-rules">
                                <h5>üìã Current Automatic Rules</h5>
                                <div id="autoGameRulesList">
                                    {% if auto_game_rules %}
                                        {% for rule in auto_game_rules %}
                                        <div class="rule-item" data-rule-id="{{ rule.id }}">
                                            <div class="rule-content">
                                                <div class="rule-header">
                                                    <h6>{{ rule.rule_name }}</h6>
                                                    <span class="badge bg-{{ 'success' if rule.active else 'secondary' }}">
                                                        {{ 'Active' if rule.active else 'Inactive' }}
                                                    </span>
                                                </div>
                                                <div class="rule-details">
                                                    <div class="rule-condition">
                                                        <strong>Condition:</strong> {{ rule.condition_type|title }} ‚â• {{ rule.threshold_value }}
                                                    </div>
                                                    <div class="rule-reward">
                                                        <strong>Reward:</strong> {{ rule.game_count }}x {{ rule.game_type|title }} 
                                                        ({{ rule.award_chance }}% chance)
                                                    </div>
                                                    <div class="rule-frequency">
                                                        <strong>Reset:</strong> {{ rule.reset_frequency|title if rule.reset_frequency != 'none' else 'One-time only' }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="rule-actions">
                                                <button class="btn btn-sm btn-primary" onclick="editAutoGameRule({{ rule.id }})">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-sm btn-{{ 'warning' if rule.active else 'success' }}" 
                                                        onclick="toggleAutoGameRule({{ rule.id }})">
                                                    <i class="fas fa-{{ 'pause' if rule.active else 'play' }}"></i>
                                                </button>
                                                <button class="btn btn-sm btn-danger" onclick="deleteAutoGameRule({{ rule.id }})">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="no-rules text-center text-muted py-4">
                                            <i class="fas fa-inbox fa-3x mb-3"></i>
                                            <p>No automatic game award rules configured yet.</p>
                                            <p><small>Add rules above to automatically award mini-games based on employee performance!</small></p>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Point-based Award Conditions -->
                            <div class="point-conditions mt-4">
                                <h5>‚ö° Dynamic Point-Based Conditions</h5>
                                <div class="alert alert-warning">
                                    <i class="fas fa-lightbulb me-2"></i>
                                    <strong>Smart Conditions:</strong> These conditions adjust game award chances based on employee performance metrics.
                                </div>
                                
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped">
                                        <thead>
                                            <tr>
                                                <th>Performance Level</th>
                                                <th>Point Range</th>
                                                <th>Game Frequency</th>
                                                <th>Bonus Chance</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td><span class="badge bg-success">Top Performer</span></td>
                                                <td>500+ points</td>
                                                <td>2-3 games/week</td>
                                                <td>+25% win rate</td>
                                                <td><button class="btn btn-sm btn-outline-primary">Edit</button></td>
                                            </tr>
                                            <tr>
                                                <td><span class="badge bg-warning">Good Performer</span></td>
                                                <td>200-499 points</td>
                                                <td>1-2 games/week</td>
                                                <td>+10% win rate</td>
                                                <td><button class="btn btn-sm btn-outline-primary">Edit</button></td>
                                            </tr>
                                            <tr>
                                                <td><span class="badge bg-info">Average Performer</span></td>
                                                <td>100-199 points</td>
                                                <td>1 game/week</td>
                                                <td>Standard rate</td>
                                                <td><button class="btn btn-sm btn-outline-primary">Edit</button></td>
                                            </tr>
                                            <tr>
                                                <td><span class="badge bg-secondary">Below Average</span></td>
                                                <td>50-99 points</td>
                                                <td>1 game/2 weeks</td>
                                                <td>-10% win rate</td>
                                                <td><button class="btn btn-sm btn-outline-primary">Edit</button></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Game Statistics -->
                    <div class="content-block">
                        <h4>üìä Game Statistics & Analytics</h4>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="stat-box">
                                    <div class="stat-number">{{ mini_games|selectattr('status', 'equalto', 'unused')|list|length }}</div>
                                    <div class="stat-label">Unused Tokens</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-box">
                                    <div class="stat-number">{{ mini_games|selectattr('status', 'equalto', 'played')|list|length }}</div>
                                    <div class="stat-label">Games Played</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-box">
                                    <div class="stat-number">
                                        {% set wins = [] %}
                                        {% for game in mini_games if game.outcome %}
                                            {% set outcome = game.outcome|from_json %}
                                            {% if outcome and outcome.win %}
                                                {% set _ = wins.append(game) %}
                                            {% endif %}
                                        {% endfor %}
                                        {{ wins|length }}
                                    </div>
                                    <div class="stat-label">Total Wins</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-box">
                                    <div class="stat-number">
                                        {% set total_points = 0 %}
                                        {% for game in mini_games if game.outcome %}
                                            {% set outcome = game.outcome|from_json %}
                                            {% if outcome and outcome.win and outcome.prize_amount %}
                                                {% set total_points = total_points + outcome.prize_amount %}
                                            {% endif %}
                                        {% endfor %}
                                        {{ total_points }}
                                    </div>
                                    <div class="stat-label">Points Awarded</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Detailed Game Results -->
                    <div class="content-block">
                        <h4>üéÆ Detailed Game Results</h4>
                        <div class="game-results-filters mb-3">
                            <div class="row">
                                <div class="col-md-3">
                                    <select class="form-select" id="filter-employee">
                                        <option value="">All Employees</option>
                                        {% for emp in employees %}
                                        <option value="{{ emp.name }}">{{ emp.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select" id="filter-game-type">
                                        <option value="">All Game Types</option>
                                        <option value="slot">Slot Machine</option>
                                        <option value="scratch">Scratch Card</option>
                                        <option value="wheel">Wheel of Fortune</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select" id="filter-status">
                                        <option value="">All Status</option>
                                        <option value="unused">Unused</option>
                                        <option value="played">Played</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-outline-primary w-100" onclick="filterGameResults()">
                                        <i class="fas fa-filter"></i> Filter
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-striped admin-table" id="gameResultsTable">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Employee</th>
                                        <th>Game Type</th>
                                        <th>Status</th>
                                        <th>Awarded</th>
                                        <th>Played</th>
                                        <th>Result</th>
                                        <th>Prize</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for game in mini_games %}
                                    <tr class="game-row" data-employee="{{ game.name }}" data-type="{{ game.game_type }}" data-status="{{ game.status }}">
                                        <td>{{ game.id }}</td>
                                        <td>
                                            <strong>{{ game.employee_name or 'Unknown' }}</strong><br>
                                            <small class="text-muted">{{ game.employee_initials or 'N/A' }}</small>
                                        </td>
                                        <td>
                                            {% if game.game_type == 'slot' %}üé∞ Slot
                                            {% elif game.game_type == 'scratch' %}üé´ Scratch
                                            {% elif game.game_type == 'wheel' %}üé° Wheel
                                            {% else %}{{ game.game_type.title() }}
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-{{ 'warning' if game.status == 'unused' else 'success' }}">
                                                {{ game.status.title() }}
                                            </span>
                                        </td>
                                        <td><small>{{ game.awarded_date }}</small></td>
                                        <td><small>{{ game.played_date or 'Not played' }}</small></td>
                                        <td>
                                            {% if game.outcome %}
                                                {% set outcome = game.outcome|from_json %}
                                                {% if outcome and outcome.win %}
                                                    <span class="badge bg-success">Win</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">Loss</span>
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if game.outcome %}
                                                {% set outcome = game.outcome|from_json %}
                                                {% if outcome and outcome.win %}
                                                    {% if outcome.prize_type == 'points' %}
                                                        <span class="prize-points">{{ outcome.prize_amount }} pts</span>
                                                    {% else %}
                                                        <span class="prize-special">{{ outcome.prize_description or 'Special Prize' }}</span>
                                                    {% endif %}
                                                {% else %}
                                                    <span class="text-muted">No prize</span>
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if game.status == 'unused' %}
                                            <button class="btn btn-sm btn-outline-danger" onclick="revokeGame({{ game.id }})">
                                                <i class="fas fa-times"></i> Revoke
                                            </button>
                                            {% else %}
                                            <button class="btn btn-sm btn-outline-info" onclick="viewGameDetails({{ game.id }})">
                                                <i class="fas fa-eye"></i> Details
                                            </button>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- üó≥Ô∏è Voting Management Section -->
            <div class="admin-section" data-section="voting">
                <div class="section-header" onclick="toggleSection('voting')">
                    <div class="section-title">
                        <i class="fas fa-vote-yea"></i>
                        <h3>Voting System Management</h3>
                    </div>
                    <div class="section-controls">
                        <span class="section-status">{{ 'Active Session' if voting_active else 'No Active Session' }}</span>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                </div>
                <div class="section-content" id="voting-content">
                    <div class="content-block">
                        <h4>üó≥Ô∏è Session Controls</h4>
                        <div class="voting-controls">
                            {% if voting_active %}
                            <div class="alert alert-success">
                                <i class="fas fa-vote-yea"></i> Voting session is currently active
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <h5>Current Session Settings</h5>
                                    <p><strong>Max Plus Votes:</strong> {{ voting_settings.max_plus_votes or 2 }}</p>
                                    <p><strong>Max Minus Votes:</strong> {{ voting_settings.max_minus_votes or 3 }}</p>
                                    <p><strong>Max Total Votes:</strong> {{ voting_settings.max_total_votes or 3 }}</p>
                                </div>
                                <div class="col-md-6">
                                    <button class="btn btn-danger" onclick="endVotingSession()">
                                        <i class="fas fa-stop"></i> End Voting Session
                                    </button>
                                </div>
                            </div>
                            {% else %}
                            <div class="alert alert-warning">
                                <i class="fas fa-pause"></i> No active voting session
                            </div>
                            <div class="voting-setup">
                                <h5>Start New Voting Session</h5>
                                <form id="startVotingForm">
                                    {{ macros.render_csrf_token() }}
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label class="form-label">Max Plus Votes</label>
                                            <input type="number" class="form-control" name="max_plus_votes" value="2" min="1" max="10">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Max Minus Votes</label>
                                            <input type="number" class="form-control" name="max_minus_votes" value="3" min="1" max="10">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Max Total Votes</label>
                                            <input type="number" class="form-control" name="max_total_votes" value="3" min="1" max="10">
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <button type="button" class="btn btn-success" onclick="startVotingSession()">
                                            <i class="fas fa-play"></i> Start Voting Session
                                        </button>
                                    </div>
                                </form>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="content-block">
                        <h4>üìä Voting Statistics</h4>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="stat-box">
                                    <div class="stat-number">{{ votes_today or 0 }}</div>
                                    <div class="stat-label">Votes Today</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-box">
                                    <div class="stat-number">{{ unique_voters_today or 0 }}</div>
                                    <div class="stat-label">Unique Voters</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-box">
                                    <div class="stat-number">{{ plus_votes_today or 0 }}</div>
                                    <div class="stat-label">Plus Votes</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-box">
                                    <div class="stat-number">{{ minus_votes_today or 0 }}</div>
                                    <div class="stat-label">Minus Votes</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="content-block">
                        <h4>üîí Session History</h4>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Duration</th>
                                        <th>Total Votes</th>
                                        <th>Participants</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for session in voting_history %}
                                    <tr>
                                        <td>{{ session.date }}</td>
                                        <td>{{ session.duration }}</td>
                                        <td>{{ session.total_votes }}</td>
                                        <td>{{ session.participants }}</td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if session.status == 'completed' else 'secondary' }}">
                                                {{ session.status.title() }}
                                            </span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {% if is_master %}
                    <div class="content-block">
                        <h4>üìä Detailed Voting Results (Master Only)</h4>
                        <div class="voting-session-selector mb-3">
                            <label for="sessionSelect" class="form-label">Select Voting Session:</label>
                            <select id="sessionSelect" class="form-control" onchange="loadSessionData(this.value)">
                                {% for sess in sessions %}
                                    <option value="{{ sess.session_id }}" {{ 'selected' if sess.session_id == selected_session_id }}>
                                        Session {{ sess.session_id }} ({{ sess.start_time }} - {{ sess.end_time or 'Ongoing' }})
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        {% if voting_results %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Employee</th>
                                        <th>Plus Votes</th>
                                        <th>Minus Votes</th>
                                        <th>Plus %</th>
                                        <th>Minus %</th>
                                        <th>Points</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in voting_results %}
                                    <tr>
                                        <td>{{ row.recipient_name }}</td>
                                        <td>{{ row.plus_votes }}</td>
                                        <td>{{ row.minus_votes }}</td>
                                        <td>{{ row.plus_percent }}%</td>
                                        <td>{{ row.minus_percent }}%</td>
                                        <td>{{ row.points }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% endif %}

                        {% if raw_votes %}
                        <h5>Raw Vote History</h5>
                        <div class="table-responsive">
                            <table class="table table-striped table-sm">
                                <thead>
                                    <tr>
                                        <th>Voter</th>
                                        <th>Recipient</th>
                                        <th>Value</th>
                                        <th>Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for v in raw_votes %}
                                    <tr>
                                        <td>{{ v.voter_initials }}</td>
                                        <td>{{ v.recipient_name }}</td>
                                        <td>{{ v.vote_value }}</td>
                                        <td>{{ v.vote_date }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- üí¨ Feedback Management Section -->
            <div class="admin-section" data-section="feedback">
                <div class="section-header" onclick="toggleSection('feedback')">
                    <div class="section-title">
                        <i class="fas fa-comments"></i>
                        <h3>Employee Feedback</h3>
                    </div>
                    <div class="section-controls">
                        <span class="section-status">{{ feedback|selectattr('read', 'equalto', 0)|list|length }} Unread</span>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                </div>
                <div class="section-content" id="feedback-content">
                    <div class="content-block">
                        <h4>üí¨ Recent Feedback</h4>
                        {{ macros.render_feedback_table(feedback, 'feedback', 'admin_mark_feedback_read') }}
                    </div>
                </div>
            </div>

            <!-- ‚öôÔ∏è System Settings Section (Master Admin Only) -->
            {% if is_master %}
            <div class="admin-section" data-section="settings">
                <div class="section-header" onclick="toggleSection('settings')">
                    <div class="section-title">
                        <i class="fas fa-cogs"></i>
                        <h3>System Settings</h3>
                        <span class="master-only">Master Admin Only</span>
                    </div>
                    <div class="section-controls">
                        <button class="btn btn-sm btn-warning" onclick="openSettingsModal()">
                            <i class="fas fa-cogs"></i> Settings Panel
                        </button>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                </div>
                <div class="section-content" id="settings-content">
                    <div class="content-block">
                        <h4>‚öôÔ∏è System Configuration</h4>
                        <p>Advanced system settings are available in the dedicated settings panel.</p>
                        <button class="btn btn-primary" onclick="openSettingsModal()">
                            <i class="fas fa-cogs"></i> Open Settings Panel
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Enhanced CSS Styles -->
<style>
.admin-header {
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    color: white;
    padding: 20px;
    border-radius: 15px;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.admin-title h1 {
    margin: 0;
    font-size: 2rem;
}

.admin-info {
    display: flex;
    gap: 10px;
    margin-top: 5px;
}

.admin-role {
    background: #D4AF37;
    color: #000;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: bold;
}

.admin-user {
    background: rgba(255,255,255,0.2);
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
}

.stats-overview {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

.stat-card {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    padding: 20px;
    border-radius: 12px;
    text-align: center;
    border-left: 4px solid #D4AF37;
}

.stat-number {
    font-size: 2rem;
    font-weight: bold;
    color: #2d2d2d;
}

.stat-label {
    color: #6c757d;
    font-size: 0.9rem;
    margin-top: 5px;
}

.admin-section {
    background: white;
    border-radius: 15px;
    margin-bottom: 20px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    overflow: hidden;
}

.section-header {
    background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
    color: white;
    padding: 20px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.3s ease;
}

.section-header:hover {
    background: linear-gradient(135deg, #3d3d3d 0%, #2a2a2a 100%);
}

.section-title {
    display: flex;
    align-items: center;
    gap: 15px;
}

.section-title i {
    font-size: 1.5rem;
    color: #D4AF37;
}

.section-title h3 {
    margin: 0;
    font-size: 1.3rem;
}

.master-only {
    background: #ff6b6b;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: bold;
    margin-left: 10px;
}

.section-controls {
    display: flex;
    align-items: center;
    gap: 15px;
}

.section-status {
    background: rgba(255,255,255,0.2);
    padding: 4px 12px;
    border-radius: 15px;
    font-size: 0.8rem;
}

.toggle-icon {
    transition: transform 0.3s ease;
    font-size: 1.2rem;
}

.section-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
}

.section-content.expanded {
    max-height: none;
    overflow: visible;
}

.content-block {
    padding: 25px;
    border-bottom: 1px solid #e9ecef;
}

.content-block:last-child {
    border-bottom: none;
}

.content-block h4 {
    color: #2d2d2d;
    margin-bottom: 20px;
    font-size: 1.2rem;
}

.employee-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
}

.employee-card {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 20px;
    border-left: 4px solid #28a745;
    transition: all 0.3s ease;
}

.employee-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.employee-card.inactive {
    border-left-color: #6c757d;
    opacity: 0.7;
}

.employee-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.employee-details .detail-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
}

.employee-actions {
    margin-top: 15px;
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.score-badge {
    background: #D4AF37;
    color: white;
    padding: 4px 12px;
    border-radius: 15px;
    font-weight: bold;
}

.rules-management {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 12px;
}

.rule-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background: white;
    border-radius: 8px;
    margin-bottom: 10px;
    border-left: 4px solid #D4AF37;
}

.rule-points {
    background: #e9ecef;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.8rem;
    font-weight: bold;
}

/* Auto-game rule specific styles */
.rule-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.rule-header h6 {
    margin: 0;
    color: #2d2d2d;
    font-weight: bold;
}

.rule-content {
    flex: 1;
    margin-right: 15px;
}

.rule-actions {
    display: flex;
    gap: 5px;
    flex-shrink: 0;
}

.rule-condition, .rule-reward, .rule-frequency {
    font-size: 0.85rem;
    margin-bottom: 5px;
    color: #666;
}

.rule-condition strong, .rule-reward strong, .rule-frequency strong {
    color: #333;
}

.no-rules {
    border: 2px dashed #dee2e6;
    border-radius: 12px;
}

.point-conditions .table th {
    background-color: #2d2d2d;
    color: white;
    border: none;
    font-size: 0.9rem;
}

.point-conditions .table td {
    vertical-align: middle;
    font-size: 0.9rem;
}

.award-game-form {
    background: #fff3cd;
    padding: 20px;
    border-radius: 12px;
    border-left: 4px solid #ffc107;
}

.stat-box {
    background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
    padding: 20px;
    border-radius: 12px;
    text-align: center;
    border: 1px solid #e9ecef;
}

.stat-box .stat-number {
    font-size: 1.8rem;
    font-weight: bold;
    color: #D4AF37;
}

.game-results-filters {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
}

.prize-points {
    background: #d4edda;
    color: #155724;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.8rem;
    font-weight: bold;
}

.prize-special {
    background: #fff3cd;
    color: #856404;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.8rem;
    font-weight: bold;
}

.admin-table {
    background: white;
}

.admin-table th {
    background: #2d2d2d;
    color: white;
    border: none;
    padding: 15px 10px;
}

.admin-table td {
    padding: 12px 10px;
    vertical-align: middle;
}

.export-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.pot-summary {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 12px;
}

.pot-stat {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
}

.pot-value {
    font-weight: bold;
    color: #D4AF37;
}

/* Responsive Design */
@media (max-width: 768px) {
    .admin-header {
        flex-direction: column;
        gap: 15px;
    }
    
    .stats-overview {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .employee-grid {
        grid-template-columns: 1fr;
    }
    
    .employee-actions {
        justify-content: center;
    }
    
    .export-buttons {
        justify-content: center;
    }
}

/* Import/Export Redesign Styles */
.nav-pills .nav-link {
    font-weight: 500;
    border-radius: 10px;
    transition: all 0.3s ease;
}

.nav-pills .nav-link.active {
    background: linear-gradient(135deg, #007bff, #0056b3);
    box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
}

.card.h-100 {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border-radius: 12px;
    border: 1px solid #e9ecef;
}

.card.h-100:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.card-header {
    border-radius: 12px 12px 0 0 !important;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

.alert-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
}

#importExportTabs .nav-link i {
    margin-right: 6px;
}
</style>

<!-- Enhanced JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize all sections as collapsed except the first one
    const sections = document.querySelectorAll('.admin-section');
    sections.forEach((section, index) => {
        if (index === 0) {
            section.querySelector('.section-content').classList.add('expanded');
            section.querySelector('.section-content').style.maxHeight = 'none';
        }
    });
});

function toggleSection(sectionName) {
    const section = document.querySelector(`[data-section="${sectionName}"]`);
    const content = section.querySelector('.section-content');
    const icon = section.querySelector('.toggle-icon');
    
    if (content.classList.contains('expanded')) {
        content.classList.remove('expanded');
        content.style.maxHeight = '0';
        icon.style.transform = 'rotate(0deg)';
    } else {
        // Close other sections first
        document.querySelectorAll('.section-content.expanded').forEach(otherContent => {
            otherContent.classList.remove('expanded');
            otherContent.style.maxHeight = '0';
        });
        document.querySelectorAll('.toggle-icon').forEach(otherIcon => {
            otherIcon.style.transform = 'rotate(0deg)';
        });
        
        // Open this section
        content.classList.add('expanded');
        content.style.maxHeight = 'none';
        icon.style.transform = 'rotate(180deg)';
    }
}

function toggleAllSections() {
    const sections = document.querySelectorAll('.section-content');
    const allExpanded = Array.from(sections).every(section => section.classList.contains('expanded'));
    
    sections.forEach(section => {
        const icon = section.parentElement.querySelector('.toggle-icon');
        if (allExpanded) {
            section.classList.remove('expanded');
            section.style.maxHeight = '0';
            icon.style.transform = 'rotate(0deg)';
        } else {
            section.classList.add('expanded');
            section.style.maxHeight = 'none';
            icon.style.transform = 'rotate(180deg)';
        }
    });
}

// Enhanced award game function
async function awardGame() {
    const employeeId = document.getElementById('award_game_employee').value;
    const gameType = document.getElementById('award_game_type').value;
    const quantity = document.getElementById('award_game_quantity').value;
    
    if (!employeeId || !gameType) {
        alert('Please select both employee and game type.');
        return;
    }
    
    try {
        const formData = new FormData();
        formData.append('employee_id', employeeId);
        formData.append('game_type', gameType);
        formData.append('quantity', quantity);
        formData.append('csrf_token', document.querySelector('input[name="csrf_token"]').value);
        
        const response = await fetch('/admin/award_game', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(`Success! Awarded ${quantity} ${gameType} game(s) to employee.`);
            setTimeout(() => location.reload(), 1000);
        } else {
            alert(`Error: ${result.message}`);
        }
        
    } catch (error) {
        console.error('Error awarding game:', error);
        alert('An error occurred while awarding the game.');
    }
}

// Filter game results
function filterGameResults() {
    const employeeFilter = document.getElementById('filter-employee').value;
    const typeFilter = document.getElementById('filter-game-type').value;
    const statusFilter = document.getElementById('filter-status').value;
    
    const rows = document.querySelectorAll('.game-row');
    
    rows.forEach(row => {
        const employee = row.dataset.employee;
        const type = row.dataset.type;
        const status = row.dataset.status;
        
        const matchEmployee = !employeeFilter || employee.includes(employeeFilter);
        const matchType = !typeFilter || type === typeFilter;
        const matchStatus = !statusFilter || status === statusFilter;
        
        if (matchEmployee && matchType && matchStatus) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// Employee management functions
function editEmployee(employeeId) {
    // Load employee data and show modal
    fetch(`/admin/get_employee/${employeeId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('edit_employee_id').value = employeeId;
                document.getElementById('edit_name').value = data.employee.name;
                document.getElementById('edit_initials').value = data.employee.initials;
                document.getElementById('edit_role').value = data.employee.role;
                
                const modal = new bootstrap.Modal(document.getElementById('editEmployeeModal'));
                modal.show();
            } else {
                alert('Failed to load employee data');
            }
        })
        .catch(error => {
            console.error('Error loading employee:', error);
            alert('Error loading employee data');
        });
}

function adjustPoints(employeeId) {
    document.getElementById('adjust_employee_id').value = employeeId;
    const modal = new bootstrap.Modal(document.getElementById('adjustPointsModal'));
    modal.show();
}

function toggleEmployeeStatus(employeeId, activate) {
    const endpoint = activate ? '/admin/reactivate_employee' : '/admin/retire_employee';
    const action = activate ? 'reactivate' : 'deactivate';
    
    if (confirm(`Are you sure you want to ${action} this employee?`)) {
        fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `employee_id=${employeeId}&csrf_token=${document.querySelector('input[name="csrf_token"]').value}`
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            if (data.success) {
                window.location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred');
        });
    }
}

function showAddEmployeeModal() {
    const modal = new bootstrap.Modal(document.getElementById('addEmployeeModal'));
    modal.show();
}

// Game management functions
function revokeGame(gameId) {
    if (confirm('Are you sure you want to revoke this unused game token?')) {
        fetch('/admin/revoke_game', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `game_id=${gameId}&csrf_token=${document.querySelector('input[name="csrf_token"]').value}`
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            if (data.success) {
                window.location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred');
        });
    }
}

function viewGameDetails(gameId) {
    fetch(`/admin/game_details/${gameId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const game = data.game;
                document.getElementById('game_details_content').innerHTML = `
                    <p><strong>Game ID:</strong> ${game.id}</p>
                    <p><strong>Employee:</strong> ${game.employee_name || 'Unknown'}</p>
                    <p><strong>Game Type:</strong> ${game.game_type}</p>
                    <p><strong>Status:</strong> ${game.status}</p>
                    <p><strong>Awarded:</strong> ${game.awarded_date}</p>
                    ${game.played_date ? `<p><strong>Played:</strong> ${game.played_date}</p>` : ''}
                    ${game.outcome ? `<p><strong>Outcome:</strong> ${JSON.stringify(game.outcome)}</p>` : ''}
                `;
                
                const modal = new bootstrap.Modal(document.getElementById('gameDetailsModal'));
                modal.show();
            } else {
                alert('Failed to load game details');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading game details');
        });
}

// Rule management functions
function editRule(ruleId) {
    fetch(`/admin/get_rule/${ruleId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('edit_rule_id').value = ruleId;
                document.getElementById('edit_rule_description').value = data.rule.description;
                document.getElementById('edit_rule_points').value = data.rule.points;
                document.getElementById('edit_rule_details').value = data.rule.details || '';
                
                const modal = new bootstrap.Modal(document.getElementById('editRuleModal'));
                modal.show();
            } else {
                alert('Failed to load rule data');
            }
        })
        .catch(error => {
            console.error('Error loading rule:', error);
            alert('Error loading rule data');
        });
}

function deleteRule(ruleId) {
    if (confirm('Are you sure you want to delete this rule?')) {
        fetch('/admin/remove_rule', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `rule_id=${ruleId}&csrf_token=${document.querySelector('input[name="csrf_token"]').value}`
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            if (data.success) {
                window.location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred');
        });
    }
}

// Voting session functions
function startVotingSession() {
    const form = document.getElementById('startVotingForm');
    const formData = new FormData(form);
    
    fetch('/admin/start_voting_session', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message);
        if (data.success) {
            window.location.reload();
        }
    })
    .catch(error => console.error('Error:', error));
}

function endVotingSession() {
    if (confirm('Are you sure you want to end the current voting session?')) {
        fetch('/admin/end_voting_session', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `csrf_token=${document.querySelector('input[name="csrf_token"]').value}`
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            if (data.success) {
                window.location.reload();
            }
        })
        .catch(error => console.error('Error:', error));
    }
}

// AJAX form submission functions
async function updatePot() {
    const form = document.getElementById('updatePotForm');
    const formData = new FormData(form);
    
    try {
        const response = await fetch('{{ url_for("admin_update_pot_endpoint") }}', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            showSuccessModal('Pot updated successfully!');
            setTimeout(() => location.reload(), 1500);
        } else {
            const errorText = await response.text();
            showErrorModal('Failed to update pot: ' + errorText);
        }
    } catch (error) {
        console.error('Error updating pot:', error);
        showErrorModal('An error occurred while updating the pot.');
    }
}

async function addRule() {
    const form = document.getElementById('addRuleForm');
    const formData = new FormData(form);
    
    try {
        const response = await fetch('{{ url_for("admin_add_rule") }}', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            showSuccessModal('Rule added successfully!');
            form.reset();
            setTimeout(() => location.reload(), 1500);
        } else {
            const errorText = await response.text();
            showErrorModal('Failed to add rule: ' + errorText);
        }
    } catch (error) {
        console.error('Error adding rule:', error);
        showErrorModal('An error occurred while adding the rule.');
    }
}

async function resetScores() {
    if (!confirm('Reset all employee scores to 50? This cannot be undone.')) {
        return;
    }
    
    const form = document.getElementById('resetScoresForm');
    const formData = new FormData(form);
    
    try {
        const response = await fetch('{{ url_for("admin_reset") }}', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            showSuccessModal('All scores have been reset to 50!');
            setTimeout(() => location.reload(), 1500);
        } else {
            const errorText = await response.text();
            showErrorModal('Failed to reset scores: ' + errorText);
        }
    } catch (error) {
        console.error('Error resetting scores:', error);
        showErrorModal('An error occurred while resetting scores.');
    }
}

async function masterReset() {
    if (!confirm('MASTER RESET: This will reset all scores AND history to install state. This CANNOT be undone. Are you absolutely sure?')) {
        return;
    }
    
    const form = document.getElementById('masterResetForm');
    const formData = new FormData(form);
    
    try {
        const response = await fetch('{{ url_for("admin_master_reset") }}', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            showSuccessModal('Master reset completed successfully!');
            setTimeout(() => location.reload(), 2000);
        } else {
            const errorText = await response.text();
            showErrorModal('Failed to perform master reset: ' + errorText);
        }
    } catch (error) {
        console.error('Error performing master reset:', error);
        showErrorModal('An error occurred during master reset.');
    }
}

async function exportPayoutCSV() {
    const startDate = document.getElementById('export_start_date').value;
    const endDate = document.getElementById('export_end_date').value;
    
    if (!startDate || !endDate) {
        showErrorModal('Please select both start and end dates.');
        return;
    }
    
    try {
        const url = `{{ url_for('export_payout') }}?start_date=${startDate}&end_date=${endDate}`;
        
        // Create a temporary link to download the file
        const link = document.createElement('a');
        link.href = url;
        link.download = `payout_export_${startDate}_to_${endDate}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showSuccessModal('Payout CSV export started. Download should begin shortly.');
    } catch (error) {
        console.error('Error exporting payout CSV:', error);
        showErrorModal('An error occurred while exporting payout CSV.');
    }
}

// Modal form submission functions
async function submitAddEmployee() {
    const form = document.getElementById('addEmployeeForm');
    const formData = new FormData(form);
    
    try {
        const response = await fetch('/admin/add', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('addEmployeeModal'));
            modal.hide();
            showSuccessModal('Employee added successfully!');
            setTimeout(() => location.reload(), 1500);
        } else {
            showErrorModal('Failed to add employee: ' + result.message);
        }
    } catch (error) {
        console.error('Error adding employee:', error);
        showErrorModal('An error occurred while adding the employee.');
    }
}

async function submitEditEmployee() {
    const form = document.getElementById('editEmployeeForm');
    const formData = new FormData(form);
    
    try {
        const response = await fetch('/admin/edit_employee', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('editEmployeeModal'));
            modal.hide();
            showSuccessModal('Employee updated successfully!');
            setTimeout(() => location.reload(), 1500);
        } else {
            showErrorModal('Failed to update employee: ' + result.message);
        }
    } catch (error) {
        console.error('Error updating employee:', error);
        showErrorModal('An error occurred while updating the employee.');
    }
}

async function submitAdjustPoints() {
    const form = document.getElementById('adjustPointsForm');
    const formData = new FormData(form);
    
    try {
        const response = await fetch('/admin/adjust_points', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('adjustPointsModal'));
            modal.hide();
            showSuccessModal('Points adjusted successfully!');
            setTimeout(() => location.reload(), 1500);
        } else {
            showErrorModal('Failed to adjust points: ' + result.message);
        }
    } catch (error) {
        console.error('Error adjusting points:', error);
        showErrorModal('An error occurred while adjusting points.');
    }
}

async function submitEditRule() {
    const form = document.getElementById('editRuleForm');
    const formData = new FormData(form);
    
    try {
        const response = await fetch('/admin/edit_rule', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('editRuleModal'));
            modal.hide();
            showSuccessModal('Rule updated successfully!');
            setTimeout(() => location.reload(), 1500);
        } else {
            showErrorModal('Failed to update rule: ' + result.message);
        }
    } catch (error) {
        console.error('Error updating rule:', error);
        showErrorModal('An error occurred while updating the rule.');
    }
}

// Utility functions for showing success/error modals
function showSuccessModal(message) {
    // Create or update a success alert
    const alertContainer = document.querySelector('.vegas-wrapper');
    const alertHtml = `
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle"></i> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
    alertContainer.insertAdjacentHTML('afterbegin', alertHtml);
    
    // Auto-dismiss after 3 seconds
    setTimeout(() => {
        const alert = alertContainer.querySelector('.alert-success');
        if (alert) {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        }
    }, 3000);
}

function showErrorModal(message) {
    // Create or update an error alert
    const alertContainer = document.querySelector('.vegas-wrapper');
    const alertHtml = `
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle"></i> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
    alertContainer.insertAdjacentHTML('afterbegin', alertHtml);
    
    // Auto-dismiss after 5 seconds for errors
    setTimeout(() => {
        const alert = alertContainer.querySelector('.alert-danger');
        if (alert) {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        }
    }, 5000);
}

// Export functions
function exportCSV(tableName) {
    try {
        const url = `{{ url_for('admin_export_csv', table_name='') }}${tableName}`;
        
        // Create a temporary link to download the file
        const link = document.createElement('a');
        link.href = url;
        link.download = `${tableName}_export.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showSuccessModal(`${tableName} CSV export started. Download should begin shortly.`);
    } catch (error) {
        console.error('Error exporting CSV:', error);
        showErrorModal('An error occurred while exporting CSV.');
    }
}

function exportData(format) {
    try {
        const url = `{{ url_for('admin_export_data', format='') }}${format}`;
        
        // Create a temporary link to download the file
        const link = document.createElement('a');
        link.href = url;
        link.download = `${format}_export.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showSuccessModal(`${format} data export started. Download should begin shortly.`);
    } catch (error) {
        console.error('Error exporting data:', error);
        showErrorModal('An error occurred while exporting data.');
    }
}

// Session data loading
async function loadSessionData(sessionId) {
    if (!sessionId) return;
    
    try {
        // Use AJAX to load session data without page refresh
        const url = new URL(window.location);
        url.searchParams.set('session_id', sessionId);
        
        const response = await fetch(url.toString());
        if (response.ok) {
            // Replace the voting results section with new data
            const html = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // Find and replace voting results tables
            const currentVotingSection = document.querySelector('#voting-content');
            const newVotingSection = doc.querySelector('#voting-content');
            
            if (currentVotingSection && newVotingSection) {
                currentVotingSection.innerHTML = newVotingSection.innerHTML;
                showSuccessModal('Session data loaded successfully!');
            }
        } else {
            throw new Error('Failed to load session data');
        }
    } catch (error) {
        console.error('Error loading session data:', error);
        showErrorModal('An error occurred while loading session data.');
    }
}

// Settings modal functionality
function openSettingsModal() {
    // Navigate to settings in the same tab to preserve session
    console.log('Opening settings page...');
    
    if (confirm('Open settings panel?')) {
        window.location.href = '{{ url_for("admin_settings") }}';
    }
}

// Mini-games navigation functions
function openGameDetails() {
    // Open the game details overview in a new tab
    window.open('/admin/game_details', '_blank');
}

function openGameAnalytics() {
    // Open the game analytics dashboard in a new tab
    window.open('/admin/game_analytics', '_blank');
}

function openGameSettings() {
    // Open the game settings panel in a new tab
    window.open('/admin/game_settings', '_blank');
}

// Database Dump Import functionality
document.getElementById('databaseDumpImportForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData();
    const fileInput = document.getElementById('dump_file');
    const modeSelect = document.getElementById('dump_import_mode');
    const csrfToken = document.getElementById('dump_import_csrf_token');
    
    if (!fileInput.files[0]) {
        alert('Please select a database dump file');
        return;
    }
    
    // Show confirmation for replace mode
    if (modeSelect.value === 'replace') {
        if (!confirm('‚ö†Ô∏è WARNING: Replace mode will DELETE ALL existing data and replace it with the dump file data.\n\nThis cannot be undone! Are you absolutely sure you want to proceed?')) {
            return;
        }
    }
    
    formData.append('dump_file', fileInput.files[0]);
    formData.append('dump_import_mode', modeSelect.value);
    formData.append('csrf_token', csrfToken.value);
    
    // Show loading message
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Importing Database...';
    submitBtn.disabled = true;
    
    fetch('/admin/import_database_dump', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        
        if (data.success) {
            // Create detailed success message
            let message = `‚úÖ Database dump imported successfully!\n\n`;
            message += `üìä Summary:\n`;
            message += `‚Ä¢ Total Records Imported: ${data.details.total_success}\n`;
            message += `‚Ä¢ Total Errors: ${data.details.total_errors}\n`;
            message += `‚Ä¢ Tables Processed: ${data.details.tables_imported.join(', ')}\n\n`;
            
            // Add table-specific results
            if (data.details.table_results) {
                message += `üìã Table Details:\n`;
                Object.entries(data.details.table_results).forEach(([table, results]) => {
                    message += `‚Ä¢ ${table}: ${results.success} success, ${results.errors} errors\n`;
                });
            }
            
            alert(message);
            
            // Show detailed errors if any
            let hasDetailedErrors = false;
            Object.values(data.details.table_results || {}).forEach(results => {
                if (results.error_details && results.error_details.length > 0) {
                    hasDetailedErrors = true;
                }
            });
            
            if (hasDetailedErrors && confirm('Some records had errors during import. View error details in console?')) {
                console.log('Database dump import results:', data.details);
                console.log('Detailed errors by table:');
                Object.entries(data.details.table_results).forEach(([table, results]) => {
                    if (results.error_details && results.error_details.length > 0) {
                        console.log(`${table} errors:`, results.error_details);
                    }
                });
            }
            
            // Clear form
            this.reset();
            
            // Offer to reload page
            if (confirm('Database import completed successfully! Reload the page to see the updated data?')) {
                window.location.reload();
            }
        } else {
            alert(`‚ùå Database dump import failed:\n\n${data.message}`);
        }
    })
    .catch(error => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        console.error('Database dump import error:', error);
        alert('Database dump import failed due to network error. Check console for details.');
    });
});

// CSV Import functionality
document.getElementById('csvImportForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData();
    const fileInput = document.getElementById('csv_file');
    const tableSelect = document.getElementById('table_name');
    const modeSelect = document.getElementById('import_mode');
    const csrfToken = document.getElementById('csv_import_csrf_token');
    
    if (!fileInput.files[0]) {
        alert('Please select a CSV file');
        return;
    }
    
    if (!tableSelect.value) {
        alert('Please select a table to import to');
        return;
    }
    
    formData.append('csv_file', fileInput.files[0]);
    formData.append('table_name', tableSelect.value);
    formData.append('import_mode', modeSelect.value);
    formData.append('csrf_token', csrfToken.value);
    
    // Show loading message
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Importing...';
    submitBtn.disabled = true;
    
    fetch('/admin/import_csv', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        
        if (data.success) {
            alert(`Import successful!\n${data.message}\n\nDetails:\n- Success: ${data.details.success_count}\n- Errors: ${data.details.error_count}`);
            
            // Show errors if any
            if (data.details.errors && data.details.errors.length > 0) {
                const errorList = data.details.errors.join('\n');
                if (confirm(`There were some errors during import. View details?\n\nFirst few errors:\n${errorList}`)) {
                    console.log('Import errors:', data.details.errors);
                }
            }
            
            // Clear form
            this.reset();
            
            // Optionally reload page to show changes
            if (confirm('Import completed. Reload page to see changes?')) {
                window.location.reload();
            }
        } else {
            alert(`Import failed: ${data.message}`);
        }
    })
    .catch(error => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        console.error('Import error:', error);
        alert('Import failed due to network error');
    });
});

// JSON Import functionality
document.getElementById('jsonImportForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData();
    const fileInput = document.getElementById('json_file');
    const tableSelect = document.getElementById('json_table_name');
    const csrfToken = document.getElementById('json_import_csrf_token');
    const resultDiv = document.getElementById('json_import_result');
    
    // Validation
    if (!fileInput.files[0]) {
        showJsonResult('Please select a JSON file', 'danger');
        return;
    }
    
    if (!tableSelect.value) {
        showJsonResult('Please select a table to import to', 'danger');
        return;
    }
    
    // Validate file type
    const file = fileInput.files[0];
    if (!file.name.toLowerCase().endsWith('.json')) {
        showJsonResult('Please select a valid JSON file', 'danger');
        return;
    }
    
    formData.append('json_file', file);
    formData.append('table_name', tableSelect.value);
    formData.append('csrf_token', csrfToken.value);
    
    // Show loading message
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Importing JSON...';
    submitBtn.disabled = true;
    
    // Hide any previous results
    resultDiv.style.display = 'none';
    
    fetch('/admin/import_json', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        
        if (data.success) {
            showJsonResult(`Import successful! ${data.message}`, 'success');
            
            // Clear form on success
            this.reset();
            
            // Optionally reload page to show changes
            setTimeout(() => {
                if (confirm('JSON import completed successfully. Reload page to see changes?')) {
                    window.location.reload();
                }
            }, 1500);
        } else {
            showJsonResult(`Import failed: ${data.message}`, 'danger');
        }
    })
    .catch(error => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        console.error('JSON Import error:', error);
        showJsonResult('Import failed due to network error. Please check the file format and try again.', 'danger');
    });
});

// Helper function to show JSON import results
function showJsonResult(message, type) {
    const resultDiv = document.getElementById('json_import_result');
    resultDiv.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
    resultDiv.style.display = 'block';
}

// Auto Game Rules Management Functions
async function addAutoGameRule() {
    const form = document.getElementById('addAutoGameRuleForm');
    const formData = new FormData(form);
    
    try {
        const response = await fetch('/admin/add_auto_game_rule', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Automatic game rule added successfully!');
            location.reload();
        } else {
            alert('Error adding rule: ' + result.message);
        }
    } catch (error) {
        console.error('Error adding auto game rule:', error);
        alert('An error occurred while adding the rule.');
    }
}

async function editAutoGameRule(ruleId) {
    try {
        const response = await fetch(`/admin/get_auto_game_rule/${ruleId}`);
        const rule = await response.json();
        
        if (rule.success) {
            // Populate form with rule data
            const form = document.getElementById('addAutoGameRuleForm');
            form.elements['rule_name'].value = rule.data.rule_name;
            form.elements['condition_type'].value = rule.data.condition_type;
            form.elements['threshold_value'].value = rule.data.threshold_value;
            form.elements['game_type'].value = rule.data.game_type;
            form.elements['game_count'].value = rule.data.game_count;
            form.elements['award_chance'].value = rule.data.award_chance;
            form.elements['reset_frequency'].value = rule.data.reset_frequency;
            form.elements['active'].checked = rule.data.active;
            
            // Change button to update mode
            const submitBtn = form.querySelector('button[onclick="addAutoGameRule()"]');
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Update Rule';
            submitBtn.setAttribute('onclick', `updateAutoGameRule(${ruleId})`);
            
            // Scroll to form
            form.scrollIntoView({ behavior: 'smooth' });
        } else {
            alert('Error loading rule: ' + rule.message);
        }
    } catch (error) {
        console.error('Error loading auto game rule:', error);
        alert('An error occurred while loading the rule.');
    }
}

async function updateAutoGameRule(ruleId) {
    const form = document.getElementById('addAutoGameRuleForm');
    const formData = new FormData(form);
    formData.append('rule_id', ruleId);
    
    try {
        const response = await fetch('/admin/update_auto_game_rule', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Automatic game rule updated successfully!');
            location.reload();
        } else {
            alert('Error updating rule: ' + result.message);
        }
    } catch (error) {
        console.error('Error updating auto game rule:', error);
        alert('An error occurred while updating the rule.');
    }
}

async function toggleAutoGameRule(ruleId) {
    try {
        const response = await fetch('/admin/toggle_auto_game_rule', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `rule_id=${ruleId}&csrf_token=${document.querySelector('input[name="csrf_token"]').value}`
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Update the button and badge without full reload
            const ruleItem = document.querySelector(`[data-rule-id="${ruleId}"]`);
            const badge = ruleItem.querySelector('.badge');
            const toggleBtn = ruleItem.querySelector('button[onclick*="toggleAutoGameRule"]');
            
            if (result.active) {
                badge.className = 'badge bg-success';
                badge.textContent = 'Active';
                toggleBtn.className = 'btn btn-sm btn-warning';
                toggleBtn.innerHTML = '<i class="fas fa-pause"></i>';
            } else {
                badge.className = 'badge bg-secondary';
                badge.textContent = 'Inactive';
                toggleBtn.className = 'btn btn-sm btn-success';
                toggleBtn.innerHTML = '<i class="fas fa-play"></i>';
            }
            
            alert(`Rule ${result.active ? 'activated' : 'deactivated'} successfully!`);
        } else {
            alert('Error toggling rule: ' + result.message);
        }
    } catch (error) {
        console.error('Error toggling auto game rule:', error);
        alert('An error occurred while toggling the rule.');
    }
}

async function deleteAutoGameRule(ruleId) {
    if (!confirm('Are you sure you want to delete this automatic game rule? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch('/admin/delete_auto_game_rule', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `rule_id=${ruleId}&csrf_token=${document.querySelector('input[name="csrf_token"]').value}`
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Automatic game rule deleted successfully!');
            location.reload();
        } else {
            alert('Error deleting rule: ' + result.message);
        }
    } catch (error) {
        console.error('Error deleting auto game rule:', error);
        alert('An error occurred while deleting the rule.');
    }
}

async function executeAutoRules() {
    if (!confirm('This will check all active automatic game rules and award games to qualifying employees. Continue?')) {
        return;
    }
    
    const executeBtn = document.querySelector('button[onclick="executeAutoRules()"]');
    executeBtn.disabled = true;
    executeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Executing...';
    
    try {
        const response = await fetch('/admin/execute_auto_rules', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `csrf_token=${document.querySelector('input[name="csrf_token"]').value}`
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(`‚úÖ Auto Rules Executed Successfully!\n\n${result.message}\n\nRules checked: ${result.details.rules_checked}`);
            if (result.details.games_awarded > 0) {
                // Refresh the page to show new game awards
                location.reload();
            }
        } else {
            alert('‚ùå Error executing auto rules: ' + result.message);
        }
    } catch (error) {
        console.error('Error executing auto rules:', error);
        alert('‚ùå An error occurred while executing auto rules.');
    } finally {
        executeBtn.disabled = false;
        executeBtn.innerHTML = '<i class="fas fa-play"></i> Execute All Active Rules Now';
    }
}

</script>

<!-- Modal Dialogs -->

<!-- Add Employee Modal -->
<div class="modal fade" id="addEmployeeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Employee</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addEmployeeForm">
                <div class="modal-body">
                    {{ macros.render_csrf_token() }}
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Initials</label>
                        <input type="text" class="form-control" name="initials" maxlength="3" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Role</label>
                        <select class="form-select" name="role" required>
                            {% for role in roles %}
                            <option value="{{ role.role }}">{{ role.role }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="submitAddEmployee()">Add Employee</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Employee Modal -->
<div class="modal fade" id="editEmployeeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Employee</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editEmployeeForm">
                <div class="modal-body">
                    {{ macros.render_csrf_token() }}
                    <input type="hidden" id="edit_employee_id" name="employee_id">
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-control" id="edit_name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Initials</label>
                        <input type="text" class="form-control" id="edit_initials" name="initials" maxlength="3" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Role</label>
                        <select class="form-select" id="edit_role" name="role" required>
                            {% for role in roles %}
                            <option value="{{ role.role }}">{{ role.role }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitEditEmployee()">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Adjust Points Modal -->
<div class="modal fade" id="adjustPointsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Adjust Points</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="adjustPointsForm">
                <div class="modal-body">
                    {{ macros.render_csrf_token() }}
                    <input type="hidden" id="adjust_employee_id" name="employee_id">
                    <div class="mb-3">
                        <label class="form-label">Points Adjustment</label>
                        <input type="number" class="form-control" name="points" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Reason</label>
                        <input type="text" class="form-control" name="reason" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" onclick="submitAdjustPoints()">Adjust Points</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Rule Modal -->
<div class="modal fade" id="editRuleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Rule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editRuleForm">
                <div class="modal-body">
                    {{ macros.render_csrf_token() }}
                    <input type="hidden" id="edit_rule_id" name="rule_id">
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-control" id="edit_rule_description" name="description" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Points</label>
                        <input type="number" class="form-control" id="edit_rule_points" name="points" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Details</label>
                        <input type="text" class="form-control" id="edit_rule_details" name="details">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitEditRule()">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Game Details Modal -->
<div class="modal fade" id="gameDetailsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Game Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="game_details_content">
                    <!-- Game details will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}