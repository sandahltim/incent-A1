{% extends "base.html" %}
{% block content %}
<h1>Admin Management</h1>

<!-- Adjust Points Section -->
<h2>Adjust Points</h2>
<form id="adjustPointsFormUnique" method="POST" action="/admin/adjust_points">
    <div class="mb-3">
        <label class="form-label">Employee:</label>
        <select name="employee_id" id="adjust_employee_id" class="form-control" required>
            <option value="">Select an employee</option>
            {% for emp in employees %}
                {% set role_display = roles|selectattr('role_name', 'eq', emp.role)|map(attribute='role_name')|first|default(emp.role) %}
                <option value="{{ emp.employee_id }}">{{ emp.employee_id }} - {{ emp.name }} ({{ emp.initials }}) - {{ emp.score }} {% if emp.active == 0 %}(Retired){% endif %}</option>
            {% endfor %}
        </select>
    </div>
    <div class="mb-3">
        <label class="form-label">Points (positive or negative):</label>
        <input type="number" name="points" id="adjust_points" class="form-control" required min="-100" max="100">
    </div>
    <div class="mb-3">
        <label class="form-label">Reason:</label>
        <input type="text" name="reason" id="adjust_reason" class="form-control" required maxlength="200">
        <div>Select a rule or enter a custom reason:</div>
        <ul>
            {% for rule in rules %}
                <li><a class="rule-link" href="#" data-points="{{ rule.points }}" data-reason="{{ rule.description }}">{{ rule.description }} ({{ rule.points }})</a></li>
            {% endfor %}
        </ul>
    </div>
    <button type="submit" class="btn btn-primary">Adjust Points</button>
</form>

<!-- Points Rules Section -->
<h2>Points Rules</h2>
<form id="addRuleFormUnique" method="POST" action="/admin/add_rule">
    <div class="mb-3">
        <label class="form-label">Description:</label>
        <input type="text" name="description" id="add_rule_description" class="form-control" required maxlength="200">
    </div>
    <div class="mb-3">
        <label class="form-label">Points:</label>
        <input type="number" name="points" id="add_rule_points" class="form-control" required min="-100" max="100">
    </div>
    <button type="submit" class="btn btn-primary">Add Rule</button>
</form>

<h3>Edit or Remove Rules</h3>
<div>
    {% for rule in rules %}
        <div>
            <form class="editRuleFormUnique" method="POST" action="/admin/edit_rule">
                <input type="hidden" name="old_description" value="{{ rule.description }}">
                <input type="text" name="new_description" value="{{ rule.description }}" required maxlength="200">
                <input type="number" name="points" value="{{ rule.points }}" required min="-100" max="100">
                <button type="submit" class="btn btn-primary">Edit</button>
            </form>
            <form class="removeRuleFormUnique" method="POST" action="/admin/remove_rule">
                <input type="hidden" name="description" value="{{ rule.description }}">
                <button type="submit" class="btn btn-danger">Remove</button>
            </form>
        </div>
    {% endfor %}
</div>

<!-- Incentive Pot Debug Section -->
<h2>Incentive Pot</h2>
<h3>Debug - Employee Data:</h3>
<div>
    {% for emp in employees %}
        {% set role_display = roles|selectattr('role_name', 'eq', emp.role)|map(attribute='role_name')|first|default(emp.role) %}
        <p>{{ emp.employee_id }}: Score={{ emp.score }}, Role={{ role_display }}, Active={{ emp.active|default('MISSING') }}, Point Value={{ pot_info.get(emp.role.lower() + '_point_value', 0) }}, Share={{ emp.score * pot_info.get(emp.role.lower() + '_point_value', 0) }}</p>
    {% endfor %}
    {% set shares = [] %}
    {% for emp in employees %}
        {% if emp.active == 1 and emp.score > 50 %}
            {% set share = emp.score * pot_info.get(emp.role.lower() + '_point_value', 0) %}
            {% set _ = shares.append(share) %}
        {% endif %}
    {% endfor %}
    <p>Shares List: {{ shares }}</p>
    <p>Total Bonus Payout: ${{ "%.2f"|format(shares | sum) }}</p>
</div>

<!-- Reset Scores Section -->
<h2>Reset Scores</h2>
<form id="resetScoresFormUnique" method="POST" action="/admin/reset">
    <button type="submit" class="btn btn-warning">Reset All Scores to 50</button>
</form>

<!-- Voting Controls Section -->
{% if voting_active %}
    <h2>Voting Controls</h2>
    <form id="pauseVotingFormUnique" method="POST" action="/pause_voting">
        <button type="submit" class="btn btn-warning">Pause Voting</button>
    </form>
    <form id="closeVotingFormUnique" method="POST" action="/close_voting">
        <div class="mb-3">
            <input type="password" name="password" class="form-control" placeholder="Admin Password" required>
        </div>
        <button type="submit" class="btn btn-danger">End Weekly Voting</button>
    </form>
{% endif %}

<!-- Add Employee Section (Master Only) -->
{% if is_master %}
    <h2>Add Employee</h2>
    <form id="addEmployeeFormUnique" method="POST" action="/admin/add">
        <div class="mb-3">
            <label class="form-label">Name:</label>
            <input type="text" name="name" id="add_employee_name" class="form-control" required maxlength="100">
        </div>
        <div class="mb-3">
            <label class="form-label">Initials:</label>
            <input type="text" name="initials" id="add_employee_initials" class="form-control" required maxlength="10">
        </div>
        <div class="mb-3">
            <label class="form-label">Role:</label>
            <select name="role" id="add_employee_role" class="form-control" required>
                {% for role in roles %}
                    <option value="{{ role.role_name }}">{{ role.role_name }}</option>
                {% endfor %}
            </select>
        </div>
        <button type="submit" class="btn btn-primary">Add Employee</button>
    </form>
{% endif %}

<!-- Manage Employees Section (Master Only) -->
{% if is_master %}
    <h2>Manage Employees</h2>
    <form id="editEmployeeFormUnique" method="POST" action="/admin/edit_employee">
        <div class="mb-3">
            <label class="form-label">Employee:</label>
            <select name="employee_id" id="edit_employee_id" class="form-control" required>
                <option value="">Select an employee</option>
                {% for emp in employees %}
                    <option value="{{ emp.employee_id }}">{{ emp.employee_id }} - {{ emp.name }} ({{ emp.initials }}) {% if emp.active == 0 %}(Retired){% endif %}</option>
                {% endfor %}
            </select>
        </div>
        <div class="mb-3">
            <label class="form-label">New Name:</label>
            <input type="text" name="name" id="edit_employee_name" class="form-control" required maxlength="100">
        </div>
        <div class="mb-3">
            <label class="form-label">New Role:</label>
            <select name="role" id="edit_employee_role" class="form-control" required>
                {% for role in roles %}
                    <option value="{{ role.role_name }}">{{ role.role_name }}</option>
                {% endfor %}
            </select>
        </div>
        <button type="submit" class="btn btn-primary">Edit Employee</button>
        <button type="button" id="retireBtn" class="btn btn-warning">Retire</button>
        <button type="button" id="reactivateBtn" class="btn btn-success">Reactivate</button>
        <button type="button" id="deleteBtn" class="btn btn-danger">Delete Forever</button>
    </form>
{% endif %}

<!-- Update Incentive Pot Section (Master Only) -->
{% if is_master %}
    <h2>Update Incentive Pot</h2>
    <form id="updatePotFormUnique" method="POST" action="/admin/update_pot">
        <div class="mb-3">
            <label class="form-label">Sales Dollars:</label>
            <input type="number" name="sales_dollars" id="update_pot_sales_dollars" class="form-control" required min="0">
        </div>
        <div class="mb-3">
            <label class="form-label">Bonus % of Sales Amount:</label>
            <input type="number" name="bonus_percent" id="update_pot_bonus_percent" class="form-control" required min="0" max="100">
        </div>
        <button type="submit" class="btn btn-primary">Update Pot</button>
    </form>
{% endif %}

<!-- Prior Year Sales Section (Master Only) -->
{% if is_master %}
    <h2>Prior Year Sales</h2>
    <form id="updatePriorYearSalesFormUnique" method="POST" action="/admin/update_prior_year_sales">
        <div class="mb-3">
            <label class="form-label">Prior Year Sales Dollars (Current: ${{ "%.2f"|format(pot_info.get('prior_year_sales', 0)) }}):</label>
            <input type="number" name="prior_year_sales" id="update_prior_year_sales_prior_year_sales" class="form-control" required min="0">
        </div>
        <button type="submit" class="btn btn-primary">Update Prior Year Sales</button>
    </form>
{% endif %}

<!-- Set Daily Point Decay Section (Master Only) -->
{% if is_master %}
    <h2>Set Daily Point Decay</h2>
    <form id="setPointDecayFormUnique" method="POST" action="/admin/set_point_decay">
        <div class="mb-3">
            <label class="form-label">Role:</label>
            <select name="role_name" id="set_point_decay_role_name" class="form-control" required>
                {% for role in roles %}
                    <option value="{{ role.role_name }}">{{ role.role_name }} (Current: {{ decay[role.role_name].points|default(1) }} points, {{ decay[role.role_name].days|default([])|join(', ') }})</option>
                {% endfor %}
            </select>
        </div>
        <div class="mb-3">
            <label class="form-label">Points to Deduct Daily:</label>
            <input type="number" name="points" id="set_point_decay_points" class="form-control" required min="0" max="100">
        </div>
        <div class="mb-3">
            <label class="form-label">Days to Trigger:</label>
            <div>
                <label><input type="checkbox" name="days[]" value="Monday"> Monday</label>
                <label><input type="checkbox" name="days[]" value="Tuesday"> Tuesday</label>
                <label><input type="checkbox" name="days[]" value="Wednesday"> Wednesday</label>
                <label><input type="checkbox" name="days[]" value="Thursday"> Thursday</label>
                <label><input type="checkbox" name="days[]" value="Friday"> Friday</label>
                <label><input type="checkbox" name="days[]" value="Saturday"> Saturday</label>
                <label><input type="checkbox" name="days[]" value="Sunday"> Sunday</label>
            </div>
        </div>
        <button type="submit" class="btn btn-primary">Set Point Decay</button>
    </form>
{% endif %}

<!-- Manage Admins Section (Master Only) -->
{% if is_master %}
    <h2>Manage Admins</h2>
    <form id="updateAdminFormUnique" method="POST" action="/admin/update_admin">
        <div class="mb-3">
            <label class="form-label">Current Username:</label>
            <select name="old_username" id="update_admin_old_username" class="form-control" required>
                <option value="">Select an admin</option>
                {% for admin in admins %}
                    <option value="{{ admin.username }}">{{ admin.username }} ({{ admin.admin_id }})</option>
                {% endfor %}
            </select>
        </div>
        <div class="mb-3">
            <label class="form-label">New Username:</label>
            <input type="text" name="new_username" id="update_admin_new_username" class="form-control" required maxlength="50">
        </div>
        <div class="mb-3">
            <label class="form-label">New Password:</label>
            <input type="password" name="new_password" id="update_admin_new_password" class="form-control" required>
        </div>
        <button type="submit" class="btn btn-primary">Update Admin</button>
    </form>
{% endif %}

<!-- Manage Job Roles Section (Master Only) -->
{% if is_master %}
    <h2>Manage Job Roles</h2>
    <form id="addRoleFormUnique" method="POST" action="/admin/add_role">
        <div class="mb-3">
            <label class="form-label">Role Name:</label>
            <input type="text" name="role_name" id="add_role_role_name" class="form-control" required maxlength="50">
        </div>
        <div class="mb-3">
            <label class="form-label">Percentage:</label>
            <input type="number" name="percentage" id="add_role_percentage" class="form-control" required min="0" max="100">
        </div>
        <button type="submit" class="btn btn-primary">Add Role</button>
    </form>
    <h3>Edit or Remove Roles (Must Total ≤ 100%)</h3>
    <div>
        {% for role in roles %}
            <div>
                <form class="editRoleFormUnique" method="POST" action="/admin/edit_role">
                    <input type="hidden" name="old_role_name" value="{{ role.role_name }}">
                    <input type="text" name="new_role_name" value="{{ role.role_name }}" required maxlength="50">
                    <input type="number" name="percentage" value="{{ role.percentage }}" required min="0" max="100">
                    <button type="submit" class="btn btn-primary">Edit</button>
                </form>
                <form class="removeRoleFormUnique" method="POST" action="/admin/remove_role">
                    <input type="hidden" name="role_name" value="{{ role.role_name }}">
                    <button type="submit" class="btn btn-danger">Remove</button>
                </form>
            </div>
        {% endfor %}
    </div>
{% endif %}

<!-- Master Reset Section (Master Only) -->
{% if is_master %}
    <h2>Master Reset</h2>
    <form id="masterResetFormUnique" method="POST" action="/admin/master_reset">
        <div class="mb-3">
            <label class="form-label">Master Password:</label>
            <input type="password" name="password" id="master_reset_password" class="form-control" required>
        </div>
        <button type="submit" class="btn btn-danger">Reset All Voting and History</button>
    </form>
{% endif %}

<!-- Voting Results Section -->
<h2>Voting Results</h2>
{% if voting_results %}
    {% set sessions = voting_results | groupby('session_id') %}
    {% for session_id, session_results in sessions %}
        <h3>Session {{ session_id }}</h3>
        <table class="table" id="votingResults">
            <thead>
                <tr>
                    <th>Voter Initials</th>
                    <th>Recipient Name</th>
                    <th>Vote</th>
                    <th>Date</th>
                    <th>Points</th>
                </tr>
            </thead>
            <tbody>
                {% for result in session_results %}
                    <tr>
                        <td>{{ result.voter_initials }}</td>
                        <td>{{ result.recipient_name }}</td>
                        <td>{{ result.vote_value }}</td>
                        <td>{{ result.vote_date }}</td>
                        <td>{{ result.points|default(0) }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endfor %}
{% else %}
    <p>No voting results available.</p>
{% endif %}

<!-- Feedback Section -->
<h2>Feedback</h2>
{% if unread_feedback > 0 %}
    <p>Unread Feedback: {{ unread_feedback }}</p>
{% endif %}
<table class="table">
    <thead>
        <tr>
            <th>ID</th>
            <th>Submitter</th>
            <th>Comment</th>
            <th>Timestamp</th>
            <th>Read</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        {% for fb in feedback %}
            <tr>
                <td>{{ fb.id }}</td>
                <td>{{ fb.submitter }}</td>
                <td>{{ fb.comment }}</td>
                <td>{{ fb.timestamp }}</td>
                <td>{{ 'Yes' if fb.read else 'No' }}</td>
                <td>
                    {% if not fb.read %}
                        <form class="markReadFormUnique" method="POST" action="/admin/mark_feedback_read">
                            <input type="hidden" name="feedback_id" value="{{ fb.id }}">
                            <button type="submit" class="btn btn-primary">Mark Read</button>
                        </form>
                    {% endif %}
                </td>
            </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Export Payout Data Section -->
<h2>Export Payout Data</h2>
<p><a href="/admin/export_payout">Export All</a></p>
<p><a href="/admin/export_payout?month={{ current_month }}">Export Current Month</a></p>

<!-- Settings Section (Master Only) -->
{% if is_master %}
    <h2>Settings</h2>
    <p><a href="/admin/settings">Manage Settings</a></p>
{% endif %}

<!-- Logout Section -->
<h2>Logout</h2>
<form method="POST" action="/admin/logout">
    <button type="submit" class="btn btn-secondary">Logout</button>
</form>

{% endblock %}