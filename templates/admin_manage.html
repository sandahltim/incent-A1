{% extends "base.html" %}
{% block content %}
<div class="container">
    <h1>Admin Management</h1>

    <h2>Adjust Points</h2>
    <form action="{{ url_for('admin_adjust_points') }}" method="post">
        {{ adjust_points_form.csrf_token }}
        <div class="form-group">
            <label for="employee_id" class="form-label">{{ adjust_points_form.employee_id.label }}</label>
            {{ adjust_points_form.employee_id(class="form-control") }}
        </div>
        <div class="form-group">
            <label for="points" class="form-label">{{ adjust_points_form.points.label }} (positive or negative)</label>
            {{ adjust_points_form.points(class="form-control") }}
        </div>
        <div class="form-group">
            <label for="reason" class="form-label">{{ adjust_points_form.reason.label }}</label>
            {{ adjust_points_form.reason(class="form-control") }}
            <small>Select a rule or enter a custom reason:</small>
            <ul>
                {% for rule in rules %}
                <li><a href="#" class="rule-link" onclick="document.querySelector('input[name=reason]').value = '{{ rule.description }}'">{{ rule.description }} ({{ rule.points }})</a></li>
                {% endfor %}
            </ul>
        </div>
        {{ adjust_points_form.submit(class="btn btn-primary") }}
    </form>

    <h2>Points Rules</h2>
    <form action="{{ url_for('admin_add_rule') }}" method="post">
        {{ add_rule_form.csrf_token }}
        <div class="form-group">
            <label for="description" class="form-label">{{ add_rule_form.description.label }}</label>
            {{ add_rule_form.description(class="form-control") }}
        </div>
        <div class="form-group">
            <label for="points" class="form-label">{{ add_rule_form.points.label }}</label>
            {{ add_rule_form.points(class="form-control") }}
        </div>
        {{ add_rule_form.submit(class="btn btn-primary") }}
    </form>

    <h3>Edit or Remove Rules</h3>
    <table class="table">
        {% for rule in rules %}
        <tr>
            <td>
                <form action="{{ url_for('admin_edit_rule') }}" method="post">
                    {{ edit_rule_form.csrf_token }}
                    <input type="hidden" name="old_description" value="{{ rule.description }}">
                    <div class="form-group">
                        <input type="text" name="new_description" class="form-control" value="{{ rule.description }}" required>
                    </div>
                    <div class="form-group">
                        <input type="number" name="points" class="form-control" value="{{ rule.points }}" required>
                    </div>
                    <button type="submit" class="btn btn-success">Edit</button>
                </form>
            </td>
            <td>
                <form action="{{ url_for('admin_remove_rule') }}" method="post">
                    {{ remove_rule_form.csrf_token }}
                    <input type="hidden" name="description" value="{{ rule.description }}">
                    <button type="submit" class="btn btn-danger">Remove</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </table>

    <h2>Incentive Pot</h2>
    <h3>Debug - Employee Data:</h3>
    {% for emp in employees %}
    {% set role_display = roles|selectattr('role_name', 'eq', emp.role)|map(attribute='role_name')|first|default(emp.role) %}
    <p>{{ emp.employee_id }}: Score={{ emp.score }}, Role={{ role_display }}, Active={{ emp.active|default('MISSING') }}, Point Value={{ pot_info.get(emp.role.lower() + '_point_value', 0) }}, Share={{ emp.score * pot_info.get(emp.role.lower() + '_point_value', 0) }}</p>
    {% endfor %}

    {% set shares = [] %}
    {% for emp in employees %}
        {% if emp.active == 1 and emp.score > 50 %}
            {% set share = emp.score * pot_info.get(emp.role.lower() + '_point_value', 0) %}
            {% set _ = shares.append(share) %}
        {% endif %}
    {% endfor %}
    <p>Shares List: {{ shares }}</p>
    <p>Total Bonus Payout: ${{ "%.2f"|format(shares | sum) }}</p>

    <h2>Reset Scores</h2>
    <form action="{{ url_for('admin_reset') }}" method="post">
        {{ form.csrf_token }}
        <button type="submit" class="btn btn-warning">Reset All Scores to 50</button>
    </form>

    {% if is_master %}
    <h2>Add Employee</h2>
    <form action="{{ url_for('admin_add') }}" method="post">
        {{ add_employee_form.csrf_token }}
        <div class="form-group">
            <label for="name" class="form-label">{{ add_employee_form.name.label }}</label>
            {{ add_employee_form.name(class="form-control") }}
        </div>
        <div class="form-group">
            <label for="initials" class="form-label">{{ add_employee_form.initials.label }}</label>
            {{ add_employee_form.initials(class="form-control") }}
        </div>
        <div class="form-group">
            <label for="role" class="form-label">{{ add_employee_form.role.label }}</label>
            {{ add_employee_form.role(class="form-control") }}
        </div>
        {{ add_employee_form.submit(class="btn btn-primary") }}
    </form>

    <h2>Manage Employees</h2>
    <form action="{{ url_for('admin_edit_employee') }}" method="post" style="display:inline;">
        {{ edit_employee_form.csrf_token }}
        <div class="form-group">
            <label for="employee_id" class="form-label">{{ edit_employee_form.employee_id.label }}</label>
            {{ edit_employee_form.employee_id(class="form-control") }}
        </div>
        <div class="form-group">
            <label for="name" class="form-label">{{ edit_employee_form.name.label }}</label>
            {{ edit_employee_form.name(class="form-control") }}
        </div>
        <div class="form-group">
            <label for="role" class="form-label">{{ edit_employee_form.role.label }}</label>
            {{ edit_employee_form.role(class="form-control") }}
        </div>
        {{ edit_employee_form.submit(class="btn btn-success") }}
    </form>
    <form action="{{ url_for('admin_retire_employee') }}" method="post" style="display:inline;">
        {{ retire_employee_form.csrf_token }}
        {{ retire_employee_form.employee_id(class="form-control", style="display:none;") }}
        {{ retire_employee_form.submit(class="btn btn-warning") }}
    </form>
    <form action="{{ url_for('admin_reactivate_employee') }}" method="post" style="display:inline;">
        {{ reactivate_employee_form.csrf_token }}
        {{ reactivate_employee_form.employee_id(class="form-control", style="display:none;") }}
        {{ reactivate_employee_form.submit(class="btn btn-success") }}
    </form>
    <form action="{{ url_for('admin_delete_employee') }}" method="post" style="display:inline;">
        {{ delete_employee_form.csrf_token }}
        {{ delete_employee_form.employee_id(class="form-control", style="display:none;") }}
        {{ delete_employee_form.submit(class="btn btn-danger") }}
    </form>

    <h2>Update Incentive Pot</h2>
    <form action="{{ url_for('admin_update_pot') }}" method="post">
        {{ update_pot_form.csrf_token }}
        <div class="form-group">
            <label for="sales_dollars" class="form-label">{{ update_pot_form.sales_dollars.label }}</label>
            {{ update_pot_form.sales_dollars(class="form-control") }}
        </div>
        <div class="form-group">
            <label for="bonus_percent" class="form-label">{{ update_pot_form.bonus_percent.label }}</label>
            {{ update_pot_form.bonus_percent(class="form-control") }}
        </div>
        {{ update_pot_form.submit(class="btn btn-primary") }}
    </form>

    <h2>Prior Year Sales</h2>
    <form action="{{ url_for('admin_update_prior_year_sales') }}" method="post">
        {{ update_prior_year_sales_form.csrf_token }}
        <div class="form-group">
            <label for="prior_year_sales" class="form-label">{{ update_prior_year_sales_form.prior_year_sales.label }} (Current: ${{ "%.2f"|format(pot_info.get('prior_year_sales', 0)) }})</label>
            {{ update_prior_year_sales_form.prior_year_sales(class="form-control") }}
        </div>
        {{ update_pot_form.submit(class="btn btn-primary") }}
    </form>

    <h2>Set Daily Point Decay</h2>
    <form action="{{ url_for('admin_set_point_decay') }}" method="post">
        {{ set_point_decay_form.csrf_token }}
        <div class="form-group">
            <label for="role_name" class="form-label">{{ set_point_decay_form.role_name.label }}</label>
            {{ set_point_decay_form.role_name(class="form-control") }}
            {% for role in roles %}
            <small>{{ role.role_name }} (Current: {{ decay[role.role_name].points|default(1) }} points, {{ decay[role.role_name].days|default([])|join(', ') }})</small><br>
            {% endfor %}
        </div>
        <div class="form-group">
            <label for="points" class="form-label">{{ set_point_decay_form.points.label }}</label>
            {{ set_point_decay_form.points(class="form-control") }}
        </div>
        <div class="form-group">
            <label for="days" class="form-label">{{ set_point_decay_form.days.label }}</label>
            {{ set_point_decay_form.days(class="form-control") }}
        </div>
        {{ set_point_decay_form.submit(class="btn btn-primary") }}
    </form>

    <h2>Manage Admins</h2>
    <form action="{{ url_for('admin_update_admin') }}" method="post">
        {{ update_admin_form.csrf_token }}
        <div class="form-group">
            <label for="old_username" class="form-label">{{ update_admin_form.old_username.label }}</label>
            {{ update_admin_form.old_username(class="form-control") }}
        </div>
        <div class="form-group">
            <label for="new_username" class="form-label">{{ update_admin_form.new_username.label }}</label>
            {{ update_admin_form.new_username(class="form-control") }}
        </div>
        <div class="form-group">
            <label for="new_password" class="form-label">{{ update_admin_form.new_password.label }}</label>
            {{ update_admin_form.new_password(class="form-control") }}
        </div>
        {{ update_admin_form.submit(class="btn btn-primary") }}
    </form>

    <h2>Manage Job Roles</h2>
    <form action="{{ url_for('admin_add_role') }}" method="post">
        {{ add_role_form.csrf_token }}
        <div class="form-group">
            <label for="role_name" class="form-label">{{ add_role_form.role_name.label }}</label>
            {{ add_role_form.role_name(class="form-control") }}
        </div>
        <div class="form-group">
            <label for="percentage" class="form-label">{{ add_role_form.percentage.label }}</label>
            {{ add_role_form.percentage(class="form-control") }}
        </div>
        {{ add_role_form.submit(class="btn btn-primary") }}
    </form>

    <h3>Edit or Remove Roles (Must Total ≤ 100%)</h3>
    <table class="table">
        {% for role in roles %}
        <tr>
            <td>
                <form action="{{ url_for('admin_edit_role') }}" method="post">
                    {{ edit_role_form.csrf_token }}
                    <input type="hidden" name="old_role_name" value="{{ role.role_name }}">
                    <div class="form-group">
                        <input type="text" name="new_role_name" class="form-control" value="{{ role.role_name }}" required>
                    </div>
                    <div class="form-group">
                        <input type="number" name="percentage" class="form-control" value="{{ role.percentage }}" required>
                    </div>
                    <button type="submit" class="btn btn-success">Edit</button>
                </form>
            </td>
            <td>
                <form action="{{ url_for('admin_remove_role') }}" method="post">
                    {{ remove_role_form.csrf_token }}
                    <input type="hidden" name="role_name" value="{{ role.role_name }}">
                    <button type="submit" class="btn btn-danger">Remove</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </table>

    <h2>Master Reset</h2>
    <form action="{{ url_for('admin_master_reset') }}" method="post">
        {{ master_reset_form.csrf_token }}
        <div class="form-group">
            <label for="password" class="form-label">{{ master_reset_form.password.label }}</label>
            {{ master_reset_form.password(class="form-control") }}
        </div>
        {{ master_reset_form.submit(class="btn btn-danger") }}
    </form>

    <h2>Voting Results</h2>
    {% if voting_results %}
        {% set sessions = voting_results | groupby('session_id') %}
        {% for session_id, session_results in sessions %}
            <h3>Session {{ session_id }}</h3>
            <table class="table" id="votingResults">
                <thead>
                    <tr>
                        <th>Voter Initials</th>
                        <th>Recipient Name</th>
                        <th>Vote</th>
                        <th>Date</th>
                        <th>Points</th>
                    </tr>
                </thead>
                <tbody>
                    {% for result in session_results %}
                    <tr>
                        <td>{{ result.voter_initials }}</td>
                        <td>{{ result.recipient_name }}</td>
                        <td>{{ result.vote_value }}</td>
                        <td>{{ result.vote_date }}</td>
                        <td>{{ result.points|default(0) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>No results for Session {{ session_id }}.</p>
        {% endfor %}
    {% else %}
        <p>No voting results available.</p>
    {% endif %}

    <form action="{{ url_for('admin_logout') }}" method="post">
        {{ form.csrf_token }}
        <button type="submit" class="btn btn-secondary">Logout</button>
    </form>
</div>
{% endblock %}