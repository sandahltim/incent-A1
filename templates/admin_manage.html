{% extends "base.html" %}
{% block content %}
<h1>Admin Management</h1>

<h2>Adjust Points</h2>
<form id="adjustPointsForm" method="POST" action="{{ url_for('admin_adjust_points') }}">
    {{ adjust_form.hidden_tag() }}
    <div class="mb-3">
        <label for="employee_id" class="form-label">Employee:</label>
        {{ adjust_form.employee_id(class="form-control", required="required") }}
    </div>
    <div class="mb-3">
        <label for="points" class="form-label">Points (positive or negative):</label>
        {{ adjust_form.points(class="form-control", required="required") }}
    </div>
    <div class="mb-3">
        <label for="reason" class="form-label">Reason:</label>
        {{ adjust_form.reason(class="form-control", required="required") }}
        <small style="color: #FFD700;">Select a rule or enter a custom reason:</small>
        <ul class="rule-list">
            {% for rule in rules %}
            <li>
                <a href="#" class="rule-link" data-points="{{ rule.points }}" data-reason="{{ rule.description }}">
                    {{ rule.description }} ({{ rule.points }})
                </a>
            </li>
            {% endfor %}
        </ul>
    </div>
    <div class="mb-3">
        <label for="notes" class="form-label">Notes (optional):</label>
        {{ adjust_form.notes(class="form-control") }}
    </div>
    <button type="submit" class="btn btn-primary">Adjust Points</button>
</form>

<h2>Points Rules</h2>
<form id="addRuleForm" method="POST" action="{{ url_for('admin_add_rule') }}">
    {{ add_rule_form.hidden_tag() }}
    <div class="mb-3">
        <label for="description" class="form-label">Description:</label>
        {{ add_rule_form.description(class="form-control", required="required") }}
    </div>
    <div class="mb-3">
        <label for="points" class="form-label">Points:</label>
        {{ add_rule_form.points(class="form-control", required="required") }}
    </div>
    <div class="mb-3">
        <label for="details" class="form-label">Details:</label>
        {{ add_rule_form.details(class="form-control") }}
    </div>
    <button type="submit" class="btn btn-primary">Add Rule</button>
</form>

<h3>Edit or Remove Rules</h3>
<ul class="rule-list">
    {% for rule in rules %}
    <li>
        <form class="edit-rule-form" method="POST" action="{{ url_for('admin_edit_rule') }}">
            {{ edit_rule_form.hidden_tag() }}
            <input type="hidden" name="old_description" value="{{ rule.description }}">
            <div class="mb-3" style="display: inline-block; margin-right: 10px;">
                <label for="new_description_{{ loop.index }}" class="form-label">New Description:</label>
                <input type="text" name="new_description" value="{{ rule.description }}" class="form-control" id="new_description_{{ loop.index }}" required>
            </div>
            <div class="mb-3" style="display: inline-block; margin-right: 10px;">
                <label for="points_{{ loop.index }}" class="form-label">Points:</label>
                <input type="number" name="points" value="{{ rule.points }}" class="form-control" id="points_{{ loop.index }}" required>
            </div>
            <div class="mb-3" style="display: inline-block; margin-right: 10px;">
                <label for="details_{{ loop.index }}" class="form-label">Details:</label>
                <textarea name="details" class="form-control" id="details_{{ loop.index }}">{{ rule.details }}</textarea>
            </div>
            <button type="submit" class="btn btn-sm btn-success">Edit</button>
        </form>
        <form class="remove-rule-form" method="POST" action="{{ url_for('admin_remove_rule') }}">
            {{ remove_rule_form.hidden_tag() }}
            <input type="hidden" name="description" value="{{ rule.description }}">
            <button type="submit" class="btn btn-sm btn-danger">Remove</button>
        </form>
    </li>
    {% endfor %}
</ul>

<h2>Incentive Pot</h2>
<p>Debug - Employee Data:</p>
<ul>
    {% for emp in employees %}
    {% set role_display = roles|selectattr('role_name', 'eq', emp.role)|map(attribute='role_name')|first|default(emp.role) %}
    <li>
        {{ emp.employee_id }}: Score={{ emp.score }}, Role={{ role_display }}, Active={{ emp.active|default('MISSING') }},
        Point Value={{ pot_info.get(emp.role.lower() + '_point_value', 0) }},
        Share={{ emp.score * pot_info.get(emp.role.lower() + '_point_value', 0) }}
    </li>
    {% endfor %}
</ul>
{% set shares = [] %}
{% for emp in employees %}
    {% if emp.active == 1 and emp.score > 50 %}
        {% set share = emp.score * pot_info.get(emp.role.lower() + '_point_value', 0) %}
        {% set _ = shares.append(share) %}
    {% endif %}
{% endfor %}
<p>Shares List: {{ shares }}</p>
<p>Total Bonus Payout: ${{ "%.2f"|format(shares | sum) }}</p>

<h2>Reset Scores</h2>
<form id="resetScoresForm" method="POST" action="{{ url_for('admin_reset') }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <button type="submit" class="btn btn-danger">Reset All Scores to 50</button>
</form>

{% if voting_active %}
<h2>Voting Controls</h2>
<form id="pauseVotingForm" method="POST" action="{{ url_for('pause_voting') }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <button type="submit" class="btn btn-warning">Pause Voting</button>
</form>
<form id="closeVotingForm" method="POST" action="{{ url_for('close_voting') }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <input type="password" name="password" placeholder="Admin Password" required class="form-control" style="display: inline-block; width: auto;">
    <button type="submit" class="btn btn-danger">End Weekly Voting</button>
</form>
{% endif %}

{% if is_master %}
<h2>Add Employee</h2>
<form id="addEmployeeForm" method="POST" action="{{ url_for('admin_add') }}">
    {{ add_employee_form.hidden_tag() }}
    <div class="mb-3">
        <label for="name" class="form-label">Name:</label>
        {{ add_employee_form.name(class="form-control", required="required") }}
    </div>
    <div class="mb-3">
        <label for="initials" class="form-label">Initials:</label>
        {{ add_employee_form.initials(class="form-control", required="required") }}
    </div>
    <div class="mb-3">
        <label for="role" class="form-label">Role:</label>
        {{ add_employee_form.role(class="form-control", required="required") }}
    </div>
    <button type="submit" class="btn btn-primary">Add Employee</button>
</form>

<h2>Manage Employees</h2>
<form id="editEmployeeForm" method="POST" action="{{ url_for('admin_edit_employee') }}">
    {{ edit_employee_form.hidden_tag() }}
    <div class="mb-3">
        <label for="employee_id" class="form-label">Employee:</label>
        {{ edit_employee_form.employee_id(class="form-control", required="required") }}
    </div>
    <div class="mb-3">
        <label for="name" class="form-label">New Name:</label>
        {{ edit_employee_form.name(class="form-control", required="required") }}
    </div>
    <div class="mb-3">
        <label for="role" class="form-label">New Role:</label>
        {{ edit_employee_form.role(class="form-control", required="required") }}
    </div>
    <button type="submit" class="btn btn-primary">Edit Employee</button>
    <button type="button" id="retireBtn" class="btn btn-warning">Retire</button>
    <button type="button" id="reactivateBtn" class="btn btn-success">Reactivate</button>
    <button type="button" id="deleteBtn" class="btn btn-danger">Delete Forever</button>
</form>

<h2>Update Incentive Pot</h2>
<form id="updatePotForm" method="POST" action="{{ url_for('admin_update_pot') }}">
    {{ update_pot_form.hidden_tag() }}
    <div class="mb-3">
        <label for="sales_dollars" class="form-label">Sales Dollars:</label>
        {{ update_pot_form.sales_dollars(class="form-control", required="required") }}
    </div>
    <div class="mb-3">
        <label for="bonus_percent" class="form-label">Bonus % of Sales Amount:</label>
        {{ update_pot_form.bonus_percent(class="form-control", required="required") }}
    </div>
    <button type="submit" class="btn btn-primary">Update Pot</button>
</form>

<h2>Prior Year Sales</h2>
<form id="updatePriorYearSalesForm" method="POST" action="{{ url_for('admin_update_prior_year_sales') }}">
    {{ update_prior_year_sales_form.hidden_tag() }}
    <div class="mb-3">
        <label for="prior_year_sales" class="form-label">Prior Year Sales Dollars (Current: ${{ "%.2f"|format(pot_info.get('prior_year_sales', 0)) }}):</label>
        {{ update_prior_year_sales_form.prior_year_sales(class="form-control", required="required") }}
    </div>
    <button type="submit" class="btn btn-primary">Update Prior Year Sales</button>
</form>

<h2>Set Daily Point Decay</h2>
<form id="setPointDecayForm" method="POST" action="{{ url_for('admin_set_point_decay') }}">
    {{ set_point_decay_form.hidden_tag() }}
    <div class="mb-3">
        <label for="role_name" class="form-label">Role:</label>
        {{ set_point_decay_form.role_name(class="form-control", required="required") }}
    </div>
    <div class="mb-3">
        <label for="points" class="form-label">Points to Deduct Daily:</label>
        {{ set_point_decay_form.points(class="form-control", required="required") }}
    </div>
    <div class="mb-3">
        <label class="form-label">Days to Trigger:</label><br>
        {% for value, label in set_point_decay_form.days.choices %}
        <input type="checkbox" name="days" value="{{ value }}">{{ label }}<br>
        {% endfor %}
    </div>
    <button type="submit" class="btn btn-primary">Set Point Decay</button>
</form>

<h2>Manage Admins</h2>
<form id="updateAdminForm" method="POST" action="{{ url_for('admin_update_admin') }}">
    {{ update_admin_form.hidden_tag() }}
    <div class="mb-3">
        <label for="old_username" class="form-label">Current Username:</label>
        {{ update_admin_form.old_username(class="form-control", required="required") }}
    </div>
    <div class="mb-3">
        <label for="new_username" class="form-label">New Username:</label>
        {{ update_admin_form.new_username(class="form-control", required="required") }}
    </div>
    <div class="mb-3">
        <label for="new_password" class="form-label">New Password:</label>
        {{ update_admin_form.new_password(class="form-control", required="required") }}
    </div>
    <button type="submit" class="btn btn-primary">Update Admin</button>
</form>

<h2>Manage Job Roles</h2>
<form id="addRoleForm" method="POST" action="{{ url_for('admin_add_role') }}">
    {{ add_role_form.hidden_tag() }}
    <div class="mb-3">
        <label for="role_name" class="form-label">Role Name:</label>
        {{ add_role_form.role_name(class="form-control", required="required") }}
    </div>
    <div class="mb-3">
        <label for="percentage" class="form-label">Percentage:</label>
        {{ add_role_form.percentage(class="form-control", required="required") }}
    </div>
    <button type="submit" class="btn btn-primary">Add Role</button>
</form>

<h3>Edit or Remove Roles (Must Total ≤ 100%)</h3>
<ul class="role-list">
    {% for role in roles %}
    <li>
        <form class="edit-role-form" method="POST" action="{{ url_for('admin_edit_role') }}">
            {{ edit_role_form.hidden_tag() }}
            <input type="hidden" name="old_role_name" value="{{ role.role_name }}">
            <div class="mb-3" style="display: inline-block; margin-right: 10px;">
                <label for="new_role_name_{{ loop.index }}" class="form-label">New Role Name:</label>
                <input type="text" name="new_role_name" value="{{ role.role_name }}" class="form-control" id="new_role_name_{{ loop.index }}" required>
            </div>
            <div class="mb-3" style="display: inline-block; margin-right: 10px;">
                <label for="percentage_{{ loop.index }}" class="form-label">Percentage:</label>
                <input type="number" step="0.1" name="percentage" value="{{ role.percentage }}" class="form-control" id="percentage_{{ loop.index }}" required>
            </div>
            <button type="submit" class="btn btn-sm btn-success">Edit</button>
        </form>
        <form class="remove-role-form" method="POST" action="{{ url_for('admin_remove_role') }}">
            {{ remove_role_form.hidden_tag() }}
            <input type="hidden" name="role_name" value="{{ role.role_name }}">
            <button type="submit" class="btn btn-sm btn-danger">Remove</button>
        </form>
    </li>
    {% endfor %}
</ul>

<h2>Master Reset</h2>
<form id="masterResetForm" method="POST" action="{{ url_for('admin_master_reset') }}">
    {{ master_reset_form.hidden_tag() }}
    <div class="mb-3">
        <label for="password" class="form-label">Master Password:</label>
        {{ master_reset_form.password(class="form-control", required="required") }}
    </div>
    <button type="submit" class="btn btn-danger">Reset All Voting and History</button>
</form>

<h2>Voting Results</h2>
<div id="adminVotingResults">
    {% if voting_results %}
    {% set sessions = voting_results | groupby('session_id') %}
    {% for session_id, session_results in sessions %}
    <h3>Session {{ session_id }}</h3>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Voter Initials