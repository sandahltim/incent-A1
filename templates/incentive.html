{# incentive.html #}
{# Version: 1.2.18 #}
{# Note: Added quickAdjustModal div with adjustPointsForm to fix 'Quick Adjust Form Not Found' error. Maintained fixes from version 1.2.17 (role_key_map, Start Voting button, Quick Adjust section placement, unread feedback notice, admin login link, week_options). Ensured compatibility with app.py (1.2.38), incentive_service.py (1.2.10), config.py (1.2.6), forms.py (1.2.2), admin_manage.html (1.2.18), quick_adjust.html (1.2.8), script.js (1.2.29), style.css (1.2.11), base.html (1.2.12), macros.html (1.2.5), start_voting.html (1.2.4), settings.html (1.2.5). No changes to core functionality (scoreboard, voting, feedback submission). #}

{% extends "base.html" %}
{% import "macros.html" as macros %}
{% block content %}
<div class="container">
    {% for message in get_flashed_messages(with_categories=true) %}
    <div class="alert alert-{{ message[0] }}">
        {{ message[1] }}
        <button type="button" class="close" data-dismiss="alert">&times;</button>
    </div>
    {% endfor %}
    <h1>A1 Rent-It Incentive Program</h1>
    <div class="row">
        <div class="col-md-12">
            {% if not is_admin %}
            <a href="{{ url_for('admin') }}" class="btn btn-primary">Admin Login</a>
            {% else %}
                {% if not voting_active %}
                <a href="{{ url_for('start_voting') }}" class="btn btn-primary">Start Voting Session</a>
                {% endif %}
            {% endif %}
            <h2>Scoreboard (Total Pot: ${{ '%.2f' % (pot_info.driver_pot + pot_info.laborer_pot + pot_info.supervisor_pot + pot_info['warehouse labor_pot'] + pot_info.warehouse_pot) }})</h2>
            <table class="table table-striped" id="scoreboard">
                <thead>
                    <tr>
                        <th>Employee ID</th>
                        <th>Name</th>
                        <th>Score</th>
                        <th>Role</th>
                        <th>Payout</th>
                    </tr>
                </thead>
                <tbody>
                    {% for employee in scoreboard %}
                    <tr class="{{ get_score_class(employee.score) }}">
                        <td>{{ employee.employee_id }}</td>
                        <td>{{ employee.name }}</td>
                        <td>{{ employee.score }}</td>
                        <td>{{ employee.role|capitalize }}</td>
                        <td>${{ '%.2f' % (employee.score * pot_info[employee.role.lower().replace(' ', '_') + '_point_value'] if employee.score >= 50 else 0) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <h2>Quick Adjust Points</h2>
            <div class="row">
                <div class="col-md-6">
                    <h3>Positive Rules</h3>
                    <ul class="list-group">
                        {% for rule in rules if rule.points > 0 %}
                        <li class="list-group-item">
                            <a href="#" class="quick-adjust-link" data-points="{{ rule.points }}" data-reason="{{ rule.description }}">{{ rule.description }} (+{{ rule.points }})</a>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                <div class="col-md-6">
                    <h3>Negative Rules</h3>
                    <ul class="list-group">
                        {% for rule in rules if rule.points < 0 %}
                        <li class="list-group-item">
                            <a href="#" class="quick-adjust-link" data-points="{{ rule.points }}" data-reason="{{ rule.description }}">{{ rule.description }} ({{ rule.points }})</a>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            {% set role_key_map = {
                'Driver': 'driver',
                'Laborer': 'laborer',
                'Supervisor': 'supervisor',
                'Warehouse Labor': 'warehouse labor',
                'Warehouse': 'warehouse'
            } %}
            {% for role in roles %}
            {% set key_prefix = role_key_map.get(role.role_name, role.role_name.lower().replace(' ', '_')) %}
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title">{{ role.role_name }} Pot</h5>
                    <p class="card-text">{{ role.role_name }} Pot: ${{ '%.2f' % pot_info[key_prefix + '_pot'] }}</p>
                    <p class="card-text">{{ role.role_name }} Point Value: ${{ '%.2f' % pot_info[key_prefix + '_point_value'] }}</p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% if voting_active %}
    <div class="row">
        <div class="col-md-12">
            <h2>Vote</h2>
            <form id="voteInitialsForm" style="display: block;">
                {{ macros.render_field(name='voterInitials', id='voterInitials', label_text='Enter Your Initials', class='form-control') }}
                <button type="button" id="checkInitialsBtn" class="btn btn-primary">Submit Initials</button>
            </form>
            <form id="voteForm" action="/vote" method="POST" style="display: none;">
                {{ form.csrf_token }}
                <input type="hidden" id="hiddenInitials" name="initials">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Employee</th>
                            <th>Role</th>
                            <th>Score</th>
                            <th>-1</th>
                            <th>0</th>
                            <th>+1</th>
                        </tr>
                    </thead>
                    <tbody id="voteTableBody">
                        {% for employee in scoreboard %}
                        <tr>
                            <td>{{ employee.name }}</td>
                            <td>{{ employee.role|capitalize }}</td>
                            <td>{{ employee.score }}</td>
                            <td><input type="radio" name="vote_{{ employee.employee_id }}" value="-1"></td>
                            <td><input type="radio" name="vote_{{ employee.employee_id }}" value="0" checked></td>
                            <td><input type="radio" name="vote_{{ employee.employee_id }}" value="1"></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {{ macros.render_submit_button('Cast Vote') }}
            </form>
        </div>
    </div>
    {% endif %}
    <div class="row">
        <div class="col-md-12">
            <h2>Voting Results for {{ current_month }}</h2>
            <form id="weekFilterForm">
                {{ macros.render_select_field(name='week', id='week', label_text='Select Week', options=week_options, selected_value=selected_week) }}
            </form>
            {{ macros.render_voting_results(voting_results, is_admin) }}
        </div>
    </div>
    {% if is_admin and unread_feedback > 0 %}
    <div class="row">
        <div class="col-md-12">
            <h2>Feedback</h2>
            <p><a href="{{ url_for('admin') }}">Unread Feedback: {{ unread_feedback }}</a></p>
        </div>
    </div>
    {% endif %}
    <div class="row">
        <div class="col-md-12">
            <h2>Submit Feedback</h2>
            <form id="feedbackForm" action="/submit_feedback" method="POST">
                {% if not is_admin %}
                {{ macros.render_field(name='initials', id='feedback_initials', label_text='Your Initials', class='form-control') }}
                {% endif %}
                {{ macros.render_field(name='comment', id='feedback_comment', label_text='Feedback Comment', class='form-control', type='textarea') }}
                {{ macros.render_submit_button('Submit Feedback') }}
            </form>
        </div>
    </div>
    <div id="quickAdjustModal" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Quick Adjust Points</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="adjustPointsForm" action="/admin/quick_adjust_points" method="POST">
                        {{ form.csrf_token }}
                        {{ macros.render_select_field('employee_id', 'quick_adjust_employee_id', 'Employee', employee_options, class='form-control') }}
                        {{ macros.render_field(name='points', id='quick_adjust_points', label_text='Points', class='form-control', type='number', required=True) }}
                        {{ macros.render_field(name='reason', id='quick_adjust_reason', label_text='Reason', class='form-control', required=True) }}
                        {{ macros.render_field(name='notes', id='quick_adjust_notes', label_text='Notes (Optional)', class='form-control') }}
                        {{ macros.render_submit_button('Adjust Points') }}
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    document.getElementById('weekFilterForm')?.addEventListener('change', function() {
        const week = document.getElementById('week').value;
        window.location.href = '/?week=' + (week ? encodeURIComponent(week) : '');
    });
</script>
{% endblock %}