{% extends "base.html" %}
{% import "macros.html" as macros %}
{# incentive.html #}
{# Version: 1.2.39 #}
{# Note: Fixed quick adjust to use modal on main page without navigation. Added tooltip CSS for rule details, conditional ? display only if details present. Removed href from quick-adjust-link. Compatible with app.py (1.2.98), script.js (1.2.75), forms.py (1.2.16), config.py (1.2.6), admin_manage.html (1.2.36), quick_adjust.html (1.2.18), style.css (1.2.24), base.html (1.2.21), macros.html (1.2.10), start_voting.html (1.2.7), settings.html (1.2.6), admin_login.html (1.2.5), incentive_service.py (1.2.27), history.html (1.2.6), error.html, init_db.py (1.2.4). #}

{% block content %}
    <h1>Incentive Program</h1>

    {% if get_flashed_messages() %}
        {% for category, message in get_flashed_messages(with_categories=true) %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message|safe }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

    <div class="container">
        <div class="scoreboard-container">
            <h2>Scoreboard - {{ current_month }}</h2>
            <table class="table" id="scoreboard">
                <thead>
                    <tr>
                        <th>Employee ID</th>
                        <th>Name</th>
                        <th>Score</th>
                        <th>Role</th>
                        <th>Payout</th>
                    </tr>
                </thead>
                <tbody>
                    {% for emp in scoreboard %}
                        <tr class="{{ get_score_class(emp.score) }}">
                            <td>{{ emp.employee_id }}</td>
                            <td>{{ emp.name }}</td>
                            <td>{{ emp.score }}</td>
                            <td>{{ emp.role|capitalize }}</td>
                            <td>${{ (emp.score * (pot_info[role_key_map.get(emp.role|capitalize, emp.role.lower().replace(' ', '_')) + '_point_value']|float))|round(2) if emp.score >= 50 else 0 }}</td>
                        </tr>
                    {% else %}
                        <tr><td colspan="5" class="text-center">No employees found</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if voting_active %}
            <div class="voting-container">
                <h2>Cast Your Votes</h2>
                <form id="voteInitialsForm" style="display: block;">
                    <div class="mb-3">
                        <label for="voterInitials" class="form-label">Your Initials</label>
                        <input type="text" id="voterInitials" class="form-control" required>
                    </div>
                    <button type="button" id="checkInitialsBtn" class="btn btn-primary">Check Initials</button>
                </form>
                <form id="voteForm" action="{{ url_for('vote') }}" method="POST" style="display: none;">
                    {{ macros.render_csrf_token(id='vote_csrf_token') }}
                    <input type="hidden" name="initials" id="hiddenInitials">
                    <table class="table" id="voteTableBody">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Role</th>
                                <th>-1</th>
                                <th>0</th>
                                <th>+1</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for emp in scoreboard %}
                                <tr>
                                    <td>{{ emp.name }}</td>
                                    <td>{{ emp.role|capitalize }}</td>
                                    <td><input type="radio" name="vote_{{ emp.employee_id }}" value="-1"></td>
                                    <td><input type="radio" name="vote_{{ emp.employee_id }}" value="0" checked></td>
                                    <td><input type="radio" name="vote_{{ emp.employee_id }}" value="1"></td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <button type="submit" class="btn btn-primary">Submit Votes</button>
                </form>
            </div>
        {% endif %}

        <div class="rules-container">
            <div class="rules-column">
                <h3>Positive Rules</h3>
                <ul>
                    {% for rule in rules if rule.points > 0 %}
                        <li>
                            <a href="#" class="rule-link quick-adjust-link" data-points="{{ rule.points }}" data-reason="{{ rule.description }}" data-employee="">
                                {{ rule.description }} (+{{ rule.points }})
                            </a>
                            {% if rule.details and rule.details|trim %}
                                <span class="tooltip-text" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ rule.details }}">?</span>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            </div>
            <div class="rules-column">
                <h3>Negative Rules</h3>
                <ul>
                    {% for rule in rules if rule.points < 0 %}
                        <li>
                            <a href="#" class="rule-link quick-adjust-link" data-points="{{ rule.points }}" data-reason="{{ rule.description }}" data-employee="">
                                {{ rule.description }} ({{ rule.points }})
                            </a>
                            {% if rule.details and rule.details|trim %}
                                <span class="tooltip-text" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ rule.details }}">?</span>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>

        <div class="pot-container">
            {% for role in roles %}
                {% set key = role_key_map.get(role.role_name, role.role_name.lower().replace(' ', '_')) %}
                <div class="pot-column">
                    <h3>{{ role.role_name }} Pot</h3>
                    <p>Percentage: {{ pot_info[key + '_percent'] }}%</p>
                    <p>Pot: ${{ pot_info[key + '_pot']|round(2) }}</p>
                    <p>Point Value: ${{ pot_info[key + '_point_value']|round(2) }}</p>
                </div>
            {% endfor %}
        </div>

        <div class="feedback-container">
            <h2>Submit Feedback</h2>
            <form id="feedbackForm" action="{{ url_for('submit_feedback') }}" method="POST">
                {{ macros.render_csrf_token(id='feedback_csrf_token') }}
                {{ macros.render_field(name='comment', id='feedback_comment', label_text='Comment', class='form-control', type='textarea', required=True) }}
                {{ macros.render_field(name='initials', id='feedback_initials', label_text='Initials (optional)', class='form-control') }}
                <button type="submit" class="btn btn-primary">Submit Feedback</button>
            </form>
        </div>

        <div class="modal fade" id="quickAdjustModal" tabindex="-1" aria-labelledby="quickAdjustModalLabel" aria-hidden="true" inert>
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="quickAdjustModalLabel">Quick Adjust Points</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="adjustPointsForm" action="{{ url_for('admin_quick_adjust_points') }}" method="POST">
                            {{ macros.render_csrf_token(id='adjust_csrf_token') }}
                            {% if not is_admin %}
                                {{ macros.render_field(name='username', id='quick_adjust_username', label_text='Username', class='form-control', required=True) }}
                                {{ macros.render_field(name='password', id='quick_adjust_password', label_text='Password', class='form-control', type='password', required=True) }}
                            {% endif %}
                            {{ macros.render_select_field('employee_id', 'quick_adjust_employee_id', 'Employee', employee_options) }}
                            {{ macros.render_field(name='points', id='quick_adjust_points', label_text='Points', class='form-control', type='number', required=True) }}
                            {{ macros.render_select_field('reason', 'quick_adjust_reason', 'Reason', reason_options) }}
                            {{ macros.render_field(name='notes', id='quick_adjust_notes', label_text='Notes (if Other)', class='form-control') }}
                            {{ macros.render_submit_button('Adjust Points') }}
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}