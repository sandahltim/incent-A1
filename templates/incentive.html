{# incentive.html #}
{# Version: 1.2.7 #}
{# Note: Added Quick Adjust Points modal triggered by rule links on main page, with login fields (if not logged in) and employee selection. Removed direct adjust points form to align with popup-based workflow. Ensured compatibility with app.py (version 1.2.24), macros.html (version 1.2.4), and script.js (version 1.2.13). Maintained core functionality (scoreboard, voting, feedback display). #}

{% extends "base.html" %}
{% import "macros.html" as macros %}
{% block content %}
<h1>Incentive Program</h1>
<p>Current Month: {{ current_month }}</p>

<h2>Scoreboard</h2>
<table class="table">
    <thead>
        <tr>
            <th>Name</th>
            <th>Role</th>
            <th>Score</th>
            <th>Share</th>
        </tr>
    </thead>
    <tbody>
        {% for employee in scoreboard %}
            <tr class="{{ get_score_class(employee.score) }}">
                <td>{{ employee.name }}</td>
                <td>{{ employee.role }}</td>
                <td>{{ employee.score }}</td>
                <td>${{ "%.2f"|format(employee.score * pot_info[employee.role + '_point_value']) }}</td>
            </tr>
        {% endfor %}
    </tbody>
</table>

<h2>Pot Info</h2>
<p>Sales Dollars: ${{ "%.2f"|format(pot_info.sales_dollars) }}</p>
<p>Bonus Percentage: {{ pot_info.bonus_percent }}%</p>
<p>Prior Year Sales: ${{ "%.2f"|format(pot_info.prior_year_sales) }}</p>
{% for role in roles %}
    {% set role_name = role.role_name|lower %}
    <p>{{ role_name|capitalize }} Pot: ${{ "%.2f"|format(pot_info[role_name + '_pot']) }}</p>
    <p>{{ role_name|capitalize }} Point Value: ${{ "%.2f"|format(pot_info[role_name + '_point_value']) }}</p>
{% endfor %}

<h2>Voting</h2>
{% if voting_active %}
    <form id="voteForm" method="POST" action="{{ url_for('vote') }}">
        {{ macros.render_field(name='initials', id='vote_initials', label_text='Your Initials', class='form-control', required=True) }}
        {% for employee in scoreboard %}
            <div class="mb-3">
                <label class="form-label">{{ employee.name }} ({{ employee.initials }})</label>
                <select name="vote_{{ employee.employee_id }}" class="form-control">
                    <option value="0">No Vote</option>
                    <option value="1">+1</option>
                    <option value="-1">-1</option>
                </select>
            </div>
        {% endfor %}
        {{ macros.render_submit_button('Submit Votes') }}
    </form>
{% else %}
    <p>Voting is not active.</p>
{% endif %}

<h2>Quick Adjust Points</h2>
<ul>
    {% for rule in rules %}
        <li><a class="quick-adjust-link" href="#" data-points="{{ rule.points }}" data-reason="{{ rule.description }}">{{ rule.description }} ({{ rule.points }})</a></li>
    {% endfor %}
</ul>

<h2>Voting Results</h2>
<form method="GET" action="{{ url_for('show_incentive') }}">
    {{ macros.render_select_field(name='week', id='week', label_text='Select Week', options=[('', 'All Weeks')] + [(str(i), 'Week ' + str(i)) for i in range(1, 53)], selected_value=selected_week) }}
    {{ macros.render_submit_button('Filter') }}
</form>
{{ macros.render_voting_results(voting_results, is_admin=False) }}

<h2>Rules</h2>
<ul>
    {% for rule in rules %}
        <li>{{ rule.description }}: {{ rule.points }} points</li>
    {% endfor %}
</ul>

<h2>Feedback</h2>
<form id="feedbackForm" method="POST" action="{{ url_for('submit_feedback') }}">
    {{ macros.render_field(name='comment', id='feedback_comment', label_text='Feedback Comment', class='form-control', type='textarea', required=True) }}
    {{ macros.render_field(name='initials', id='feedback_initials', label_text='Your Initials', class='form-control', required=True) }}
    {{ macros.render_submit_button('Submit Feedback') }}
</form>
{% if is_admin %}
    <p><a href="{{ url_for('admin') }}">Go to Admin Panel</a></p>
{% endif %}
{% if feedback %}
    {{ macros.render_feedback_table(feedback, '', 'admin_mark_feedback_read') }}
{% endif %}

<!-- Quick Adjust Modal -->
<div class="modal fade" id="quickAdjustModal" tabindex="-1" aria-labelledby="quickAdjustModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="quickAdjustModalLabel">Quick Adjust Points</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="quickAdjustForm" method="POST" action="{{ url_for('admin_quick_adjust_points') }}">
                    {% if not is_admin %}
                        {{ macros.render_field(name='username', id='quick_adjust_username', label_text='Admin Username', class='form-control', required=True) }}
                        {{ macros.render_field(name='password', id='quick_adjust_password', label_text='Admin Password', class='form-control', type='password', required=True) }}
                    {% endif %}
                    {{ macros.render_select_field(name='employee_id', id='quick_adjust_employee_id', label_text='Employee', options=employee_options) }}
                    {{ macros.render_field(name='points', id='quick_adjust_points', label_text='Points', class='form-control', type='number', required=True) }}
                    {{ macros.render_field(name='reason', id='quick_adjust_reason', label_text='Reason', class='form-control', required=True) }}
                    {{ macros.render_field(name='notes', id='quick_adjust_notes', label_text='Notes (Optional)', class='form-control') }}
                    {{ macros.render_submit_button('Adjust Points') }}
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}