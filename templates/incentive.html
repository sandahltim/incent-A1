{% extends "base.html" %}
{% block title %}Incentive Program{% endblock %}
{% block content %}
<div class="container">
    <h1>A1 Rent-It Incentive Program</h1>
    <h2>Total Incentive Pot: ${{ "%.2f"|format(pot_info.get('sales_dollars', 0) * pot_info.get('bonus_percent', 0) / 100) }}</h2>

    <p id="css-status">CSS Load Status: Checking...</p>

    <h2>Scoreboard</h2>
    <table class="table" id="scoreboard">
        <thead>
            <tr>
                <th>Employee ID</th>
                <th>Name</th>
                <th>Score</th>
                <th>Role</th>
                <th>Share</th>
            </tr>
        </thead>
        <tbody>
            {% for emp in scoreboard %}
            <tr class="{{ get_score_class(emp.score) }}">
                <td>{{ emp.employee_id }}</td>
                <td>{{ emp.name }}</td>
                <td>{{ emp.score }}</td>
                <td>{{ emp.role }}</td>
                <td>${{ "%.2f"|format(0 if emp.score < 50 else (emp.score * pot_info.get(emp.role.lower() + '_point_value', 0))) }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h2>Points Rules</h2>
    <div class="rules-container">
        <div class="rules-column">
            <h3>Positive Points</h3>
            <ul>
                {% for rule in rules|selectattr('points', 'ge', 0)|sort(attribute='description') %}
                <li><a href="#" class="rule-link" data-description="{{ rule.description }}" data-points="{{ rule.points }}" data-details="{{ rule.details }}">{{ rule.description }}: {{ rule.points }} points</a></li>
                {% endfor %}
            </ul>
        </div>
        <div class="rules-column">
            <h3>Negative Points</h3>
            <ul>
                {% for rule in rules|selectattr('points', 'lt', 0)|sort(attribute='description') %}
                <li><a href="#" class="rule-link" data-description="{{ rule.description }}" data-points="{{ rule.points }}" data-details="{{ rule.details }}">{{ rule.description }}: {{ rule.points }} points</a></li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <h2>Incentive Pot</h2>
    <div class="pot-container">
        <div class="pot-column">
            <h3>Current Year</h3>
            <p>Sales Dollars: ${{ "%.2f"|format(pot_info.get('sales_dollars', 0)) }}</p>
            <p>Bonus %: {{ pot_info.get('bonus_percent', 0) }}%</p>
            <p>Total Pot: ${{ "%.2f"|format(pot_info.get('sales_dollars', 0) * pot_info.get('bonus_percent', 0) / 100) }}</p>
            {% for role in roles %}
            <p>{{ role.role_name }} ({{ role.percentage }}%): ${{ "%.2f"|format(pot_info.get(role.role_name.lower() + '_pot', 0)) }}, Point Value: ${{ "%.2f"|format(pot_info.get(role.role_name.lower() + '_point_value', 0)) }}</p>
            {% endfor %}
        </div>
        <div class="pot-column">
            <h3>Prior Year</h3>
            <p>Prior Year Sales Dollars: ${{ "%.2f"|format(pot_info.get('prior_year_sales', 0)) }}</p>
            <p>Bonus %: {{ pot_info.get('bonus_percent', 0) }}%</p>
            <p>Total Pot: ${{ "%.2f"|format(pot_info.get('prior_year_sales', 0) * pot_info.get('bonus_percent', 0) / 100) }}</p>
            {% for role in roles %}
            <p>{{ role.role_name }} ({{ role.percentage }}%): ${{ "%.2f"|format(pot_info.get(role.role_name.lower() + '_prior_year_pot', 0)) }}, Point Value: ${{ "%.2f"|format(pot_info.get(role.role_name.lower() + '_prior_year_point_value', 0)) }}</p>
            {% endfor %}
        </div>
    </div>

    {% if session.admin_id %}
    <a href="{{ url_for('start_voting') }}" class="btn btn-primary">Start Voting</a>
    {% if voting_active %}
    <a href="{{ url_for('pause_voting') }}" class="btn btn-warning">Pause Voting</a>
    <a href="{{ url_for('close_voting') }}" class="btn btn-danger">End Weekly Voting</a>
    {% endif %}
    <a href="{{ url_for('admin') }}" class="btn btn-primary">Manage Employees</a>
    <a href="{{ url_for('admin_logout') }}" class="btn btn-secondary">Logout</a>
    {% else %}
    <a href="{{ url_for('admin') }}" class="btn btn-primary">Admin Login</a>
    {% endif %}
    <a href="{{ url_for('history') }}" class="btn btn-info">View History</a>

    {% if unread_feedback > 0 and session.admin_id %}
    <span class="badge bg-danger">New Feedback ({{ unread_feedback }})</span>
    {% endif %}

    {% if voting_active %}
    <h2>Cast Your Vote</h2>
    <form id="initialsForm" action="" method="post">
        {{ vote_form.csrf_token }}
        <div class="form-group">
            <label for="initials" class="form-label">{{ vote_form.initials.label }}</label>
            {{ vote_form.initials(class="form-control") }}
        </div>
        <button type="button" onclick="checkVote()" class="btn btn-primary">OK</button>
    </form>

    <form id="voteForm" action="{{ url_for('vote') }}" method="post" style="display:none;">
        {{ vote_form.csrf_token }}
        <table class="table">
            <thead>
                <tr>
                    <th>Employee ID</th>
                    <th>Name</th>
                    {% if session.admin_id %}
                    <th>Initials</th>
                    {% endif %}
                    <th>Role</th>
                    <th>+1</th>
                    <th>0</th>
                    <th>-1</th>
                </tr>
            </thead>
            <tbody>
                {% for emp in scoreboard %}
                <tr>
                    <td>{{ emp.employee_id }}</td>
                    <td>{{ emp.name }}</td>
                    {% if session.admin_id %}
                    <td>{{ emp.initials }}</td>
                    {% endif %}
                    <td>{{ emp.role }}</td>
                    <td><input type="radio" name="vote_{{ emp.employee_id }}" value="1"></td>
                    <td><input type="radio" name="vote_{{ emp.employee_id }}" value="0" checked></td>
                    <td><input type="radio" name="vote_{{ emp.employee_id }}" value="-1"></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {{ vote_form.submit(class="btn btn-primary") }}
    </form>
    {% endif %}

    <h2>Employee Feedback</h2>
    <form action="{{ url_for('submit_feedback') }}" method="post">
        {{ feedback_form.csrf_token }}
        <div class="form-group">
            <label for="comment">{{ feedback_form.comment.label }}</label>
            {{ feedback_form.comment(class="form-control") }}
        </div>
        {% if not session.admin_id %}
        <div class="form-group">
            <label for="initials">Your Initials (optional)</label>
            <input type="text" name="initials" class="form-control">
        </div>
        {% endif %}
        <button type="submit" class="btn btn-primary">Submit Feedback</button>
    </form>

    <h2>{{ current_month }} Voting Results</h2>
    {% if not session.admin_id %}
    {% set weeks = voting_results | groupby('week_number') %}
    {% for week_num, week_results in weeks %}
    <h3>Week {{ week_num }}</h3>
    <table class="table">
        <thead>
            <tr>
                <th>Recipient Name</th>
                <th>+1 Votes</th>
                <th>-1 Votes</th>
                <th>Points</th>
            </tr>
        </thead>
        <tbody>
            {% for result in week_results %}
            <tr>
                <td>{{ result.recipient_name }}</td>
                <td>{{ result.plus_votes }}</td>
                <td>{{ result.minus_votes }}</td>
                <td>{{ result.points|default(0) }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No voting results for Week {{ week_num }}</p>
    {% endfor %}
    {% else %}
    <p>Voting results are available on the admin page for authorized users.</p>
    {% endif %}
</div>

<!-- Rule Details Modal -->
<div id="ruleModal" class="modal">
    <div class="modal-content">
        <span class="close">×</span>
        <h3 id="modalTitle"></h3>
        <p id="modalDetails"></p>
        <button id="applyRuleBtn" class="btn btn-primary">Apply Rule</button>
    </div>
</div>

<!-- Quick Adjust Modal -->
<div id="adjustModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="document.getElementById('adjustModal').style.display='none'">×</span>
        <h3>Apply Rule Adjustment</h3>
        <form id="quickAdjustForm" action="{{ url_for('admin_quick_adjust_points') }}" method="post">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="mb-3">
                <label for="adjust_employee_id" class="form-label">Employee:</label>
                <select class="form-control" id="adjust_employee_id" name="employee_id" required>
                    {% for emp in scoreboard %}
                    <option value="{{ emp.employee_id }}">{{ emp.name }} ({{ emp.employee_id }})</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-3">
                <label for="adjust_points" class="form-label">Points:</label>
                <input type="number" class="form-control" id="adjust_points" name="points" readonly>
            </div>
            <div class="mb-3">
                <label for="adjust_reason" class="form-label">Reason:</label>
                <input type="text" class="form-control" id="adjust_reason" name="reason" readonly>
            </div>
            <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" id="add_notes" onclick="toggleNotes()">
                <label class="form-check-label" for="add_notes">Add Notes</label>
            </div>
            <div class="mb-3" id="notes_section" style="display:none;">
                <label for="notes" class="form-label">Notes:</label>
                <textarea class="form-control" id="notes" name="notes"></textarea>
            </div>
            <div class="mb-3">
                <label for="admin_username" class="form-label">Admin Username:</label>
                <input type="text" class="form-control" id="admin_username" name="username" required>
            </div>
            <div class="mb-3">
                <label for="admin_password" class="form-label">Admin Password:</label>
                <input type="password" class="form-control" id="admin_password" name="password" required>
            </div>
            <button type="submit" class="btn btn-primary">Submit Adjustment</button>
        </form>
    </div>
</div>

<script>
    // Check CSS load
    var cssStatus = document.getElementById('css-status');
    var testElement = document.createElement('div');
    testElement.style.display = 'none';
    testElement.className = 'test-css-load';
    document.body.appendChild(testElement);
    var computedStyle = window.getComputedStyle(testElement);
    if (computedStyle.backgroundColor === 'rgb(255, 255, 255)') {  // Assume a style in CSS for .test-css-load { background-color: #fff; }
        cssStatus.textContent = 'CSS Loaded Successfully';
    } else {
        cssStatus.textContent = 'CSS Failed to Load';
    }
    document.body.removeChild(testElement);

    function checkVote() {
        // Logic to check if can vote, then show vote form
        // This is client-side, no CSRF needed here as it's not a POST
        document.getElementById('voteForm').style.display = 'block';
    }

    // Rule modals
    var ruleModal = document.getElementById("ruleModal");
    var ruleSpan = ruleModal.getElementsByClassName("close")[0];
    document.querySelectorAll('.rule-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById("modalTitle").textContent = this.dataset.description + ": " + this.dataset.points + " points";
            document.getElementById("modalDetails").textContent = this.dataset.details;
            ruleModal.style.display = "block";
            // For apply: set data and show adjust modal
            document.getElementById("applyRuleBtn").onclick = function() {
                document.getElementById("adjust_points").value = link.dataset.points;
                document.getElementById("adjust_reason").value = link.dataset.description;
                ruleModal.style.display = "none";
                document.getElementById("adjustModal").style.display = "block";
            }
        });
    });
    ruleSpan.onclick = function() {
        ruleModal.style.display = "none";
    }
    window.onclick = function(event) {
        if (event.target == ruleModal) {
            ruleModal.style.display = "none";
        } else if (event.target == document.getElementById("adjustModal")) {
            document.getElementById("adjustModal").style.display = "none";
        }
    }

    function toggleNotes() {
        var notesSection = document.getElementById("notes_section");
        notesSection.style.display = document.getElementById("add_notes").checked ? "block" : "none";
    }

    // AJAX submit for adjust
    document.getElementById("quickAdjustForm").addEventListener("submit", function(e) {
        e.preventDefault();
        fetch(this.action, {
            method: "POST",
            body: new FormData(this),
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            if (data.success) {
                document.getElementById("adjustModal").style.display = "none";
                location.reload();
            }
        })
        .catch(error => {
            alert("Error: " + error);
        });
    });
</script>
{% endblock %}