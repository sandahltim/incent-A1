{% extends "base.html" %}
{% import "macros.html" as macros %}
{# incentive.html #}
{# Version: 1.3.3 #}
{# Note: Added animated quick adjust buttons, slot animation for voting, and random rule popups. #}

{% block head %}
    <style>
        .top-performer-marquee {
            animation: marquee 10s linear infinite;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color), var(--primary-color));
            color: var(--surface-color);
            padding: 10px;
            font-size: 1.5em;
            font-weight: bold;
            text-shadow: 0 0 10px #fff;
        }
        @keyframes marquee {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
    </style>
{% endblock %}

{% block content %}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message|safe }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <h1 class="casino-banner">{{ site_name }} Trial Incentive Jackpot!</h1>

    {% if scoreboard and scoreboard|length > 0 %}
        {% set top_performer = scoreboard|sort(attribute='score', reverse=True)|first %}
        <div class="top-performer-marquee">
            ðŸŽ° JACKPOT ALERT! {{ top_performer.name }} Leads with {{ top_performer.score }} Points! ðŸŽ°
        </div>
    {% endif %}

    <div class="container casino-table">
        <h2 class="text-center">Scoreboard</h2>
        <table class="table table-striped table-hover" id="scoreboardTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Score</th>
                    <th>Role</th>
                    <th>Payout ($)</th>
                    {% if session.admin_id %}<th>Actions</th>{% endif %}
                </tr>
            </thead>
            <tbody>
                {% for emp in scoreboard %}
                    <tr class="scoreboard-row {{ 'top-performer' if loop.first else 'encouraging-row' if emp.score < 50 else '' }}">
                        <td>{{ emp.employee_id }}</td>
                        <td>{{ emp.name }}</td>
                        <td class="score-cell">{{ emp.score }}
                            {% if loop.first %}
                                <span class="strobing-effect">ðŸŽ‰</span>
                            {% elif emp.score < 50 %}
                                <span class="coin-animation">ðŸ’°</span>
                            {% endif %}
                        </td>
                        <td>{{ emp.role|capitalize }}</td>
                        <td>{% set role_key = role_key_map.get(emp.role|capitalize, emp.role.lower().replace(' ', '_')) %}{{ (emp.score * pot_info[role_key + '_point_value']|round(4))|round(2) if emp.score >= 50 else 0 }}</td>
                        {% if session.admin_id %}
                            <td>
                                <button class="quick-adjust-btn" data-points="5" data-reason="Bonus" data-employee="{{ emp.employee_id }}">+5</button>
                                <button class="quick-adjust-btn" data-points="-5" data-reason="Penalty" data-employee="{{ emp.employee_id }}">-5</button>
                            </td>
                        {% endif %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if voting_active %}
        <div class="container casino-table">
            <h2 class="text-center">Cast Your Vote</h2>
            <form id="voteInitialsForm" action="/check_vote" method="POST">
                {{ macros.render_csrf_token(id='vote_initials_csrf_token') }}
                {{ macros.render_field('', id='voterInitials', label_text='Your Initials', class='form-control', required=True, value='') }}
                {{ macros.render_submit_button('Check Initials', id='checkInitialsBtn', class='btn btn-success') }}
            </form>
            <form id="voteForm" action="/vote" method="POST" style="display: none;" onsubmit="return playSlotAnimation(event)">
                {{ macros.render_csrf_token(id='vote_csrf_token') }}
                <input type="hidden" id="hiddenInitials" name="initials" value="">
                <input type="hidden" id="max_plus_votes" value="{{ max_plus_votes }}">
                <input type="hidden" id="max_minus_votes" value="{{ max_minus_votes }}">
                <input type="hidden" id="max_total_votes" value="{{ max_total_votes }}">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Vote</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for emp in scoreboard %}
                            <tr>
                                <td>{{ emp.employee_id }}</td>
                                <td>{{ emp.name }}</td>
                                <td>
                                    <input type="radio" name="vote_{{ emp.employee_id }}" value="1" class="vote-option"> +1
                                    <input type="radio" name="vote_{{ emp.employee_id }}" value="0" class="vote-option" checked> 0
                                    <input type="radio" name="vote_{{ emp.employee_id }}" value="-1" class="vote-option"> -1
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {{ macros.render_submit_button('Submit Votes', class='btn btn-success slot-trigger') }}
            </form>
        </div>
    {% else %}
        <div class="container casino-table">
            <h2 class="text-center">Voting is Closed</h2>
            <p class="text-center">Please wait for the next voting session to begin. Keep spinning those reels! ðŸ’°</p>
        </div>
    {% endif %}

    <div class="container casino-table">
        <h2 class="text-center">Point Conditions</h2>
        {% set half = (rules|length + 1) // 2 %}
        <div class="row">
            <div class="col-md-6">
                {% for rule in rules[:half] %}
                    <div class="rule-item">
                        {{ rule.description }} ({{ rule.points }} points)
                        {% if rule.details %}
                            <span class="tooltip" data-bs-toggle="tooltip" data-bs-title="{{ rule.details }}">?</span>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
            <div class="col-md-6">
                {% for rule in rules[half:] %}
                    <div class="rule-item">
                        {{ rule.description }} ({{ rule.points }} points)
                        {% if rule.details %}
                            <span class="tooltip" data-bs-toggle="tooltip" data-bs-title="{{ rule.details }}">?</span>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="container casino-table">
        <div class="row">
            <div class="col-md-6">
                <h2 class="text-center">Current Pot</h2>
                <div class="pot-box">
                    Sales: ${{ pot_info.sales_dollars|round(2) }}<br>
                    Bonus %: {{ pot_info.bonus_percent|round(1) }}%<br>
                    Total Pot: ${{ (pot_info.sales_dollars * pot_info.bonus_percent / 100)|round(2) }}
                </div>
            </div>
            <div class="col-md-6">
                <h2 class="text-center">Prior Year</h2>
                <div class="pot-box">
                    Sales: ${{ pot_info.prior_year_sales|round(2) }}<br>
                    Bonus %: {{ pot_info.bonus_percent|round(1) }}%<br>
                    Total Pot: ${{ (pot_info.prior_year_sales * pot_info.bonus_percent / 100)|round(2) }}
                </div>
            </div>
        </div>
    </div>

    {% if session.admin_id %}
        <!-- Quick Adjust Modal -->
        <div class="modal fade" id="quickAdjustModal" tabindex="-1" aria-labelledby="quickAdjustModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="quickAdjustModalLabel">Quick Adjust Points</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="adjustPointsForm" action="/admin/quick_adjust_points" method="POST">
                            {{ macros.render_csrf_token(id='adjust_csrf_token') }}
                            {{ macros.render_select_field(adjust_form.employee_id, id='quick_adjust_employee_id', label_text='Employee', options=employee_options, selected_value='', class='form-control') }}
                            {{ macros.render_field(adjust_form.points, id='quick_adjust_points', label_text='Points', class='form-control', type='number', required=True, value=adjust_form.points.data if adjust_form.points.data else '') }}
                            {{ macros.render_select_field(adjust_form.reason, id='quick_adjust_reason', label_text='Reason', options=reason_options, selected_value=adjust_form.reason.data if adjust_form.reason.data else 'Other', class='form-control') }}
                            {{ macros.render_field(adjust_form.notes, id='quick_adjust_notes', label_text='Notes', class='form-control', type='textarea', value=adjust_form.notes.data if adjust_form.notes.data else '') }}
                            {% if not is_admin %}
                                {{ macros.render_field(adjust_form.username, id='quick_adjust_username', label_text='Username', class='form-control', required=True, value=adjust_form.username.data if adjust_form.username.data else '') }}
                                {{ macros.render_field(adjust_form.password, id='quick_adjust_password', label_text='Password', class='form-control', type='password', required=True, value=adjust_form.password.data if adjust_form.password.data else '') }}
                            {% endif %}
                            {{ macros.render_submit_button('Adjust Points', class='btn btn-success') }}
                        </form>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <div class="container casino-table">
        <h2 class="text-center">Voting Results</h2>
        <div class="week-selector">
            {% for value, text in week_options %}
                <button class="btn btn-secondary week-btn" data-week="{{ value }}">{{ text }}</button>
            {% endfor %}
        </div>
        <div id="votingResultsContainer" class="slot-reveal">
            {{ macros.render_voting_results(voting_results) }}
        </div>
    </div>

    <div class="container casino-table">
        <h2 class="text-center">Submit Feedback</h2>
        <form action="{{ url_for('incentive') }}" method="POST">
            {{ macros.render_csrf_token(id='feedback_csrf_token') }}
            {{ macros.render_field(feedback_form.comment, id='feedback_comment', label_text='Comment', class='form-control', type='textarea', required=True, value=feedback_form.comment.data if feedback_form.comment.data else '') }}
            {{ macros.render_field(feedback_form.initials, id='feedback_initials', label_text='Initials (Optional)', class='form-control', value=feedback_form.initials.data if feedback_form.initials.data else '') }}
            {{ macros.render_submit_button('Submit Feedback', class='btn btn-success') }}
        </form>
    </div>

    <script>
        window.recentAdjustments = [
            {% for adj in recent_adjustments %}
                {name: "{{ adj['name'] }}", points: {{ adj['points'] }}, reason: "{{ adj['reason'] }}", date: "{{ adj['date'] }}"},
            {% endfor %}
        ];
        window.ruleData = [
            {% for rule in rules %}
                { description: "{{ rule.description }}", points: {{ rule.points }}, details: "{{ rule.details|default('') }}" },
            {% endfor %}
        ];
    </script>
{% endblock %}
