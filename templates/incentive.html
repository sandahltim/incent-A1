{# incentive.html #}
{# Version: 1.2.4 #}
{# Note: Fixed FormField undefined error by using simplified macros without FormField. Ensured proper extension of base.html for Jinja2 rendering. No changes to core functionality (scoreboard, voting, feedback). Added version marker and notes. #}

{% extends "base.html" %}
{% import "macros.html" as macros %}
{% block title %}BTE Uncommonly Real Incentive Trial{% endblock %}
{% block content %}
<h1>BTE Uncommonly Real Incentive Trial</h1>
<p>Total Pot: ${{ "%.2f"|format(pot_info.get('sales_dollars', 0) * pot_info.get('bonus_percent', 0) / 100) }}</p>

<span id="css-status">CSS Load Status: Checking...</span>

<h2>Scoreboard</h2>
<table class="table" id="scoreboard">
    <thead>
        <tr>
            <th>Employee ID</th>
            <th>Name</th>
            <th>Score</th>
            <th>Role</th>
            <th>Share</th>
        </tr>
    </thead>
    <tbody>
        {% for emp in scoreboard %}
            <tr class="{{ get_score_class(emp.score) }}">
                <td>{{ emp.employee_id }}</td>
                <td>{{ emp.name }}</td>
                <td>{{ emp.score }}</td>
                <td>{{ emp.role }}</td>
                <td>${{ "%.2f"|format(0 if emp.score < 50 else (emp.score * pot_info.get(emp.role.lower() + '_point_value', 0))) }}</td>
            </tr>
        {% endfor %}
    </tbody>
</table>

<h2>Points Rules</h2>
<div class="rules-container">
    <div class="rules-column">
        <h3>Positive Points</h3>
        <ul id="positiveRulesList">
            {% for rule in rules|selectattr('points', 'ge', 0)|sort(attribute='description') %}
                <li data-description="{{ rule.description }}">{{ rule.description }}: <span class="badge">{{ rule.points }} points</span></li>
            {% endfor %}
        </ul>
    </div>
    <div class="rules-column">
        <h3>Negative Points</h3>
        <ul id="negativeRulesList">
            {% for rule in rules|selectattr('points', 'lt', 0)|sort(attribute='description') %}
                <li data-description="{{ rule.description }}">{{ rule.description }}: <span class="badge">{{ rule.points }} points</span></li>
            {% endfor %}
        </ul>
    </div>
</div>

<h2>Incentive Pot</h2>
<div class="pot-container">
    <div class="pot-column">
        <h3>Current Year</h3>
        <p>Sales Dollars: ${{ "%.2f"|format(pot_info.get('sales_dollars', 0)) }}</p>
        <p>Bonus %: {{ pot_info.get('bonus_percent', 0) }}%</p>
        <p>Total Pot: ${{ "%.2f"|format(pot_info.get('sales_dollars', 0) * pot_info.get('bonus_percent', 0) / 100) }}</p>
        {% for role in roles %}
            <p>{{ role.role_name }} ({{ role.percentage }}%): ${{ "%.2f"|format(pot_info.get(role.role_name.lower() + '_pot', 0)) }}, Point Value: ${{ "%.2f"|format(pot_info.get(role.role_name.lower() + '_point_value', 0)) }}</p>
        {% endfor %}
    </div>
    <div class="pot-column">
        <h3>Prior Year</h3>
        <p>Prior Year Sales Dollars: ${{ "%.2f"|format(pot_info.get('prior_year_sales', 0)) }}</p>
        <p>Bonus %: {{ pot_info.get('bonus_percent', 0) }}%</p>
        <p>Total Pot: ${{ "%.2f"|format(pot_info.get('prior_year_sales', 0) * pot_info.get('bonus_percent', 0) / 100) }}</p>
        {% for role in roles %}
            <p>{{ role.role_name }} ({{ role.percentage }}%): ${{ "%.2f"|format(pot_info.get(role.role_name.lower() + '_prior_year_pot', 0)) }}, Point Value: ${{ "%.2f"|format(pot_info.get(role.role_name.lower() + '_prior_year_point_value', 0)) }}</p>
        {% endfor %}
    </div>
</div>

{% if is_admin %}
    <a class="btn btn-primary" href="{{ url_for('start_voting') }}">Start Voting</a>
    {% if voting_active %}
        <form id="pauseVotingFormUnique" method="POST" action="{{ url_for('pause_voting') }}">
            {{ macros.render_submit_button('Pause Voting', class='btn btn-warning') }}
        </form>
        <form id="closeVotingFormUnique" method="POST" action="{{ url_for('close_voting') }}">
            {{ macros.render_field(name='password', id='close_voting_password', label_text='Admin Password', class='form-control', type='password', required=True) }}
            {{ macros.render_submit_button('End Weekly Voting', class='btn btn-danger') }}
        </form>
    {% endif %}
    <a class="btn btn-primary" href="{{ url_for('admin') }}">Manage Employees</a>
    <form method="POST" action="{{ url_for('admin_logout') }}">
        {{ macros.render_submit_button('Logout', class='btn btn-secondary') }}
    </form>
{% else %}
    <a class="btn btn-primary" href="{{ url_for('admin') }}">Admin Login</a>
{% endif %}

<a class="btn btn-info" href="{{ url_for('history') }}">View History</a>

{% if voting_active and not is_admin %}
    <h2>Cast Your Vote</h2>
    <form id="voteInitialsForm" method="POST">
        {{ macros.render_field(name='voterInitials', id='voterInitials', label_text='Your Initials', class='form-control', required=True) }}
        {{ macros.render_submit_button('OK', class='btn btn-primary', id='checkInitialsBtn') }}
    </form>
    <form id="voteForm" method="POST" style="display: none;">
        <input type="hidden" name="initials" id="hiddenInitials">
        <table class="table" id="voteTableBody">
            <thead>
                <tr>
                    <th>Employee ID</th>
                    <th>Name</th>
                    <th>Role</th>
                    <th>+1</th>
                    <th>0</th>
                    <th>-1</th>
                </tr>
            </thead>
            <tbody>
                {% for emp in scoreboard %}
                    <tr>
                        <td>{{ emp.employee_id }}</td>
                        <td>{{ emp.name }}</td>
                        <td>{{ emp.role }}</td>
                        <td><input type="radio" name="vote_{{ emp.employee_id }}" value="1"></td>
                        <td><input type="radio" name="vote_{{ emp.employee_id }}" value="0" checked></td>
                        <td><input type="radio" name="vote_{{ emp.employee_id }}" value="-1"></td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        {{ macros.render_submit_button('Submit Votes', class='btn btn-primary') }}
    </form>
{% endif %}

<h2>{{ current_month }} Voting Results</h2>
{{ macros.render_voting_results(voting_results, is_admin) }}

{% if unread_feedback > 0 %}
    <p>Unread Feedback: {{ unread_feedback }}</p>
{% endif %}

<h2>Submit Feedback</h2>
<form id="feedbackForm" method="POST" action="{{ url_for('submit_feedback') }}">
    {{ macros.render_field(name='comment', id='comment', label_text='Comment', class='form-control', type='textarea', required=True) }}
    {% if not is_admin %}
        {{ macros.render_field(name='initials', id='initials', label_text='Initials (optional)', class='form-control', required=False) }}
    {% endif %}
    {{ macros.render_submit_button('Submit Feedback', class='btn btn-primary') }}
</form>

{% if is_admin %}
    <h2>Feedback</h2>
    {{ macros.render_feedback_table(feedback, '', 'admin_mark_feedback_read') }}
{% endif %}
{% endblock %}