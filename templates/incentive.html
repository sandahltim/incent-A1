{% extends "base.html" %}
{% import "macros.html" as macros %}
{# incentive.html #}
{# Version: 1.3.4 #}
{# Note: Added confetti bursts for top scores, particle effects in background, and explosive animations on quick adjusts. #}

{% block content %}
<div class="vegas-wrapper">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message|safe }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <h1 class="casino-banner">{{ site_name }} Trial Incentive Jackpot!</h1>

    <!-- Top Performer Marquee -->
    {% if scoreboard and scoreboard|length > 0 %}
        {% set top_performer = scoreboard|sort(attribute='score', reverse=True)|first %}
        <div class="top-performer-marquee">
            <span>üé∞ JACKPOT ALERT! {{ top_performer.name }} Leads with {{ top_performer.score }} Points! üé∞</span>
        </div>
    {% endif %}

    <div class="text-center mb-3">
        <a href="{{ url_for('employee_portal') }}" class="btn btn-info" style="min-height: 44px; font-size: 16px; padding: 0.75rem 1.5rem;">Employee Portal</a>
    </div>

    <div class="container casino-table">
        <!-- Total Pot Display -->
        <div class="pot-total-display mb-4">
            <h2 class="pot-title">üé∞ TOTAL JACKPOT POT üé∞</h2>
            <div class="pot-amount">${{ "%.2f"|format(pot_info.sales_dollars * pot_info.bonus_percent / 100) }}</div>
            <div class="pot-details">
                Sales: ${{ "%.0f"|format(pot_info.sales_dollars) }} √ó {{ "%.1f"|format(pot_info.bonus_percent) }}% Bonus
            </div>
        </div>
        
        <!-- Top Employee Showcase -->
        {% if scoreboard and scoreboard|length > 0 %}
            {% set top_employee = scoreboard|sort(attribute='score', reverse=True)|first %}
            {% set role_key = top_employee.role.lower().replace(' ', '_') %}
            {% set point_value = pot_info.get(role_key + '_point_value', 0) %}
            {% set leader_payout = top_employee.score * point_value if top_employee.score >= money_threshold else 0 %}
            <div class="top-employee-showcase mb-4">
                <div class="champion-card">
                    <h3 class="champion-title">üèÜ CURRENT CHAMPION üèÜ</h3>
                    <div class="champion-info">
                        <div class="champion-name">{{ top_employee.name }}</div>
                        <div class="champion-score">{{ top_employee.score }} Points</div>
                        <div class="champion-role">{{ top_employee.role|title }}</div>
                        {% if leader_payout > 0 %}
                            <div class="champion-payout">üí∞ ${{ "%.2f"|format(leader_payout) }}</div>
                        {% else %}
                            <div class="champion-payout-pending">Earn {{ money_threshold - top_employee.score }} more points for payout!</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endif %}
        
        <h2 class="text-center">Scoreboard</h2>
        <div class="table-responsive-custom">
            <table class="table table-striped table-hover" id="scoreboardTable">
                <thead>
                    <tr>
                        <th style="width: 8%; min-width: 60px;">ID</th>
                        <th style="width: 25%; min-width: 120px;">Name</th>
                        <th style="width: 20%; min-width: 80px;">Score</th>
                        <th style="width: 22%; min-width: 100px;">Role</th>
                        <th style="width: 25%; min-width: 100px;">Payout ($)</th>
                    </tr>
                </thead>
            <tbody>
                {% for emp in scoreboard %}
                    <tr class="score-row {{ get_score_class(emp.score, loop.index0, money_threshold) }} {% if loop.first %}score-row-win{% endif %}">
                        <td>{{ emp.employee_id }}</td>
                        <td>{{ emp.name }}</td>
                        <td class="reel-cell">
                            <div class="reel" data-reel-index="{{ loop.index0 * 2 }}">
                                <div class="symbol-container">
                                    <div class="symbol">{{ emp.score }}</div>
                                </div>
                            </div>
                        </td>
                        <td>{{ emp.role|capitalize }}</td>
                        <td class="reel-cell {% if emp.score >= money_threshold %}payout-cell{% endif %}">
                            <div class="reel" data-reel-index="{{ loop.index0 * 2 + 1 }}">
                                <div class="symbol-container">
                                    <div class="symbol">$
                                        {%- if emp.score >= money_threshold -%}
                                            {%- set role_key = emp.role.lower().replace(' ', '_') -%}
                                            {%- set point_value = pot_info.get(role_key + '_point_value', 0) -%}
                                            {{ "%.2f"|format(emp.score * point_value) }}
                                        {%- else -%}
                                            0.00
                                        {%- endif -%}
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
    </div>

    <div class="container casino-table">
        <h2 class="text-center casino-header">üéØ Point Conditions & Rewards üéØ</h2>
        <div class="point-conditions-container">
            <div class="row">
                <div class="col-md-6">
                    <div class="points-section positive-points">
                        <h3 class="points-title">‚úÖ Earn Points</h3>
                        <div class="points-list">
                            {% for rule in rules %}
                                {% if rule.points > 0 %}
                                    <div class="rule-item positive-rule quick-adjust-link" data-points="{{ rule.points }}" data-reason="{{ rule.description }}">
                                        <div class="rule-content">
                                            <span class="rule-description">{{ rule.description }}</span>
                                            <span class="rule-points positive">+{{ rule.points }}</span>
                                        </div>
                                        {% if rule.details %}
                                            <div class="rule-details">
                                                <span class="tooltip-icon" data-bs-toggle="tooltip" data-bs-title="{{ rule.details }}">‚ÑπÔ∏è</span>
                                            </div>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="points-section negative-points">
                        <h3 class="points-title">‚ùå Lose Points</h3>
                        <div class="points-list">
                            {% for rule in rules %}
                                {% if rule.points < 0 %}
                                    <div class="rule-item negative-rule quick-adjust-link" data-points="{{ rule.points }}" data-reason="{{ rule.description }}">
                                        <div class="rule-content">
                                            <span class="rule-description">{{ rule.description }}</span>
                                            <span class="rule-points negative">{{ rule.points }}</span>
                                        </div>
                                        {% if rule.details %}
                                            <div class="rule-details">
                                                <span class="tooltip-icon" data-bs-toggle="tooltip" data-bs-title="{{ rule.details }}">‚ÑπÔ∏è</span>
                                            </div>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analytics Dashboard Section -->
    <div class="container casino-table analytics-dashboard">
        <h2 class="text-center casino-header">üìä Vegas Analytics Dashboard üìä</h2>
        
        <!-- Analytics Controls -->
        <div class="analytics-controls mb-4">
            <div class="btn-group" role="group">
                <button class="btn btn-outline-primary analytics-period-btn active" data-period="7">7 Days</button>
                <button class="btn btn-outline-primary analytics-period-btn" data-period="30">30 Days</button>
                <button class="btn btn-outline-primary analytics-period-btn" data-period="90">90 Days</button>
            </div>
        </div>
        
        <!-- Key Metrics Cards -->
        <div class="row mb-4">
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="metric-card engagement-card">
                    <div class="metric-icon">üë•</div>
                    <div class="metric-value" id="activeEmployees">-</div>
                    <div class="metric-label">Active Players</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="metric-card games-card">
                    <div class="metric-icon">üé∞</div>
                    <div class="metric-value" id="weeklyGames">-</div>
                    <div class="metric-label">Games This Week</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="metric-card payout-card">
                    <div class="metric-icon">üí∞</div>
                    <div class="metric-value" id="monthlyPayouts">$-</div>
                    <div class="metric-label">Monthly Payouts</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="metric-card score-card">
                    <div class="metric-icon">‚≠ê</div>
                    <div class="metric-value" id="avgScore">-</div>
                    <div class="metric-label">Average Score</div>
                </div>
            </div>
        </div>
        
        <!-- Charts Row -->
        <div class="row">
            <!-- Score Trends Chart -->
            <div class="col-lg-6 mb-4">
                <div class="chart-container">
                    <h4 class="chart-title">üéØ Daily Points Activity</h4>
                    <div class="chart-wrapper">
                        <canvas id="scoresTrendChart" width="400" height="200"></canvas>
                    </div>
                    <div class="chart-loading" id="scoresTrendLoading">
                        <div class="spinner-border text-primary" role="status"></div>
                        <span>Loading trends...</span>
                    </div>
                </div>
            </div>
            
            <!-- Prize Distribution Chart -->
            <div class="col-lg-6 mb-4">
                <div class="chart-container">
                    <h4 class="chart-title">üèÜ Prize Distribution</h4>
                    <div class="chart-wrapper">
                        <canvas id="prizeDistributionChart" width="400" height="200"></canvas>
                    </div>
                    <div class="chart-loading" id="prizeDistributionLoading">
                        <div class="spinner-border text-primary" role="status"></div>
                        <span>Loading distribution...</span>
                    </div>
                </div>
            </div>
            
            <!-- Top Performers Chart -->
            <div class="col-lg-6 mb-4">
                <div class="chart-container">
                    <h4 class="chart-title">üåü Top Performers</h4>
                    <div class="top-performers-list" id="topPerformersList">
                        <div class="chart-loading">
                            <div class="spinner-border text-primary" role="status"></div>
                            <span>Loading top performers...</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Voting Participation Chart -->
            <div class="col-lg-6 mb-4">
                <div class="chart-container">
                    <h4 class="chart-title">üó≥Ô∏è Voting Participation Trends</h4>
                    <div class="chart-wrapper">
                        <canvas id="votingTrendChart" width="400" height="200"></canvas>
                    </div>
                    <div class="chart-loading" id="votingTrendLoading">
                        <div class="spinner-border text-primary" role="status"></div>
                        <span>Loading voting data...</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Mini-Games Analytics Preview -->
        <div class="minigames-preview mb-4">
            <h4 class="chart-title">üéÆ Mini-Games Analytics Preview</h4>
            <div class="row" id="miniGamesPreview">
                <div class="chart-loading col-12 text-center">
                    <div class="spinner-border text-primary" role="status"></div>
                    <span>Loading games analytics...</span>
                </div>
            </div>
        </div>
    </div>

    {% if voting_active %}
        <div class="container casino-table">
            <h2 class="text-center">Cast Your Vote</h2>
            <form id="checkInitialsForm" action="{{ url_for('check_vote') }}" method="POST">
                {{ macros.render_csrf_token(id='vote_initials_csrf_token') }}
                {{ macros.render_field(vote_form.initials, id='voterInitials', label_text='Your Initials', class='form-control', required=True, value=vote_form.initials.data if vote_form.initials.data else '') }}
                {{ macros.render_submit_button('Check Initials', id='checkInitialsBtn', class='btn btn-success') }}
            </form>
            <form id="voteForm" action="{{ url_for('vote') }}" method="POST" style="display: none;">
                {{ macros.render_csrf_token(id='vote_csrf_token') }}
                <input type="hidden" id="hiddenInitials" name="initials" value="">
                <input type="hidden" id="max_plus_votes" value="{{ max_plus_votes }}">
                <input type="hidden" id="max_minus_votes" value="{{ max_minus_votes }}">
                <input type="hidden" id="max_total_votes" value="{{ max_total_votes }}">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Vote</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for emp in scoreboard %}
                            <tr>
                                <td>{{ emp.employee_id }}</td>
                                <td>{{ emp.name }}</td>
                                <td>
                                    <input type="radio" name="vote_{{ emp.employee_id }}" value="1" class="vote-option"> +1
                                    <input type="radio" name="vote_{{ emp.employee_id }}" value="0" class="vote-option" checked> 0
                                    <input type="radio" name="vote_{{ emp.employee_id }}" value="-1" class="vote-option"> -1
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {{ macros.render_submit_button('Submit Votes', class='btn btn-primary slot-trigger') }}
            </form>
            <div id="slotMachine" class="slots">
                <div class="reel">üé∞</div>
                <div class="reel">üé∞</div>
                <div class="reel">üé∞</div>
            </div>
        </div>
    {% else %}
        <div class="container casino-table">
            <h2 class="text-center">Voting is Closed</h2>
            <p class="text-center">Please wait for the next voting session to begin. Keep spinning those reels! üí∞</p>
        </div>
    {% endif %}

    <div class="container casino-table">
        <div class="row">
            <div class="col-md-6">
                <h2 class="text-center">Current Pot</h2>
                <div class="pot-box">
                    Sales: ${{ pot_info.sales_dollars|round(2) }}<br>
                    Bonus %: {{ pot_info.bonus_percent|round(1) }}%<br>
                    Total Pot: ${{ (pot_info.sales_dollars * pot_info.bonus_percent / 100)|round(2) }}
                </div>
            </div>
            <div class="col-md-6">
                <h2 class="text-center">Prior Year</h2>
                <div class="pot-box">
                    Sales: ${{ pot_info.prior_year_sales|round(2) }}<br>
                    Bonus %: {{ pot_info.bonus_percent|round(1) }}%<br>
                    Total Pot: ${{ (pot_info.prior_year_sales * pot_info.bonus_percent / 100)|round(2) }}
                </div>
            </div>
        </div>
    </div>


    <div class="modal" id="quickAdjustModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">

            <div class="modal-content quick-adjust-modal">
                <div class="modal-header">
                    <h5 class="modal-title">Quick Adjust Points</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="adjustPointsForm" action="{{ url_for('admin_quick_adjust_points') }}" method="POST">
                    <div class="modal-body">
                        {{ macros.render_csrf_token(id='adjust_csrf_token') }}
                        {{ macros.render_select_field(adjust_form.employee_id, id='quick_adjust_employee_id', label_text='Employee', options=employee_options, selected_value='', class='form-control') }}
                        {{ macros.render_field(adjust_form.points, id='quick_adjust_points', label_text='Points', class='form-control', type='number', required=True, value=adjust_form.points.data if adjust_form.points.data else '') }}
                        {{ macros.render_select_field(adjust_form.reason, id='quick_adjust_reason', label_text='Reason', options=reason_options, selected_value=adjust_form.reason.data if adjust_form.reason.data else 'Other', class='form-control') }}
                        {{ macros.render_field(adjust_form.notes, id='quick_adjust_notes', label_text='Notes', class='form-control', type='textarea', value=adjust_form.notes.data if adjust_form.notes.data else '') }}
                        {% if not is_admin %}
                            {{ macros.render_field(adjust_form.username, id='quick_adjust_username', label_text='Username', class='form-control', required=True, value=adjust_form.username.data if adjust_form.username.data else '') }}
                            {{ macros.render_field(adjust_form.password, id='quick_adjust_password', label_text='Password', class='form-control', type='password', required=True, value=adjust_form.password.data if adjust_form.password.data else '') }}
                        {% endif %}
                    </div>
                    <div class="modal-footer">
                        {{ macros.render_submit_button('PUMP UP THE POT!', class='btn btn-success explode-btn') }}
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="container casino-table">
        <h2 class="text-center">Voting Results</h2>
        <div class="week-selector">
            {% for value, text in week_options %}
                <button class="btn btn-secondary week-btn" data-week="{{ value }}">{{ text }}</button>
            {% endfor %}
        </div>
        <div id="votingResultsContainer" class="slot-reveal">
            {{ macros.render_voting_results(voting_results) }}
        </div>
    </div>

    <div class="container casino-table">
        <h2 class="text-center">Submit Feedback</h2>
        <form id="feedbackForm" action="{{ url_for('submit_feedback') }}" method="POST">
            {{ macros.render_csrf_token(id='feedback_csrf_token') }}
            {{ macros.render_field(feedback_form.comment, id='feedback_comment', label_text='Comment', class='form-control', type='textarea', required=True, value=feedback_form.comment.data if feedback_form.comment.data else '') }}
            {{ macros.render_field(feedback_form.initials, id='feedback_initials', label_text='Initials (Optional)', class='form-control', value=feedback_form.initials.data if feedback_form.initials.data else '') }}
            {{ macros.render_submit_button('Submit Feedback', class='btn btn-success') }}
        </form>
    </div>
</div>

<!-- Analytics JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Analytics Dashboard Management
class VegasAnalyticsDashboard {
    constructor() {
        this.currentPeriod = 7;
        this.charts = {};
        this.init();
    }
    
    init() {
        this.setupEventListeners();
        this.loadAnalytics();
        
        // Auto-refresh analytics every 5 minutes
        setInterval(() => this.loadAnalytics(), 300000);
    }
    
    setupEventListeners() {
        // Period selection buttons
        document.querySelectorAll('.analytics-period-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.analytics-period-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                this.currentPeriod = parseInt(e.target.dataset.period);
                this.loadAnalytics();
            });
        });
    }
    
    async loadAnalytics() {
        try {
            // Show loading states
            this.showLoadingStates();
            
            // Load dashboard analytics
            const response = await fetch(`/api/analytics/dashboard?days=${this.currentPeriod}`);
            const data = await response.json();
            
            if (data.success) {
                this.updateMetricCards(data.analytics.engagement_metrics);
                this.updateScoresTrendChart(data.analytics.score_trends);
                this.updatePrizeDistributionChart(data.analytics.prize_distribution);
                this.updateTopPerformers(data.analytics.top_performers);
                this.updateVotingTrendChart(data.analytics.voting_trends);
                await this.loadMiniGamesPreview();
            }
            
            // Hide loading states
            this.hideLoadingStates();
            
        } catch (error) {
            console.error('Error loading analytics:', error);
            this.showError('Failed to load analytics data. Please try again.');
        }
    }
    
    showLoadingStates() {
        document.querySelectorAll('.chart-loading').forEach(el => el.style.display = 'flex');
        document.querySelectorAll('.chart-wrapper').forEach(el => el.style.display = 'none');
    }
    
    hideLoadingStates() {
        document.querySelectorAll('.chart-loading').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.chart-wrapper').forEach(el => el.style.display = 'block');
    }
    
    updateMetricCards(metrics) {
        if (!metrics) return;
        
        document.getElementById('activeEmployees').textContent = metrics.active_employees || '-';
        document.getElementById('weeklyGames').textContent = metrics.weekly_games || '-';
        document.getElementById('monthlyPayouts').textContent = metrics.monthly_payout_value ? 
            `$${parseFloat(metrics.monthly_payout_value).toFixed(2)}` : '$-';
        document.getElementById('avgScore').textContent = metrics.avg_employee_score ? 
            Math.round(metrics.avg_employee_score) : '-';
    }
    
    updateScoresTrendChart(scoreData) {
        const ctx = document.getElementById('scoresTrendChart').getContext('2d');
        
        if (this.charts.scoresChart) {
            this.charts.scoresChart.destroy();
        }
        
        if (!scoreData || scoreData.length === 0) {
            ctx.font = '16px Arial';
            ctx.fillStyle = '#888';
            ctx.textAlign = 'center';
            ctx.fillText('No data available', ctx.canvas.width / 2, ctx.canvas.height / 2);
            return;
        }
        
        const labels = scoreData.slice().reverse().map(item => 
            new Date(item.date).toLocaleDateString('en-US', {month: 'short', day: 'numeric'})
        );
        const pointsAwarded = scoreData.slice().reverse().map(item => item.points_awarded || 0);
        const pointsDeducted = scoreData.slice().reverse().map(item => item.points_deducted || 0);
        
        this.charts.scoresChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Points Awarded',
                    data: pointsAwarded,
                    borderColor: 'var(--neon-green)',
                    backgroundColor: 'rgba(0, 255, 127, 0.1)',
                    tension: 0.4,
                    fill: true
                }, {
                    label: 'Points Deducted',
                    data: pointsDeducted,
                    borderColor: 'var(--casino-red)',
                    backgroundColor: 'rgba(220, 38, 38, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: { color: '#fff' }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#fff' },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    },
                    y: {
                        ticks: { color: '#fff' },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    }
                }
            }
        });
    }
    
    updatePrizeDistributionChart(prizeData) {
        const ctx = document.getElementById('prizeDistributionChart').getContext('2d');
        
        if (this.charts.prizeChart) {
            this.charts.prizeChart.destroy();
        }
        
        if (!prizeData || prizeData.length === 0) {
            ctx.font = '16px Arial';
            ctx.fillStyle = '#888';
            ctx.textAlign = 'center';
            ctx.fillText('No prizes awarded yet', ctx.canvas.width / 2, ctx.canvas.height / 2);
            return;
        }
        
        const labels = prizeData.map(item => item.prize_type);
        const values = prizeData.map(item => item.total_value || 0);
        const colors = [
            'var(--primary-gold)',
            'var(--neon-blue)', 
            'var(--neon-pink)',
            'var(--neon-green)',
            'var(--casino-red)'
        ];
        
        this.charts.prizeChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: colors.slice(0, labels.length),
                    borderColor: '#fff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: '#fff', padding: 20 }
                    }
                }
            }
        });
    }
    
    updateTopPerformers(topPerformers) {
        const container = document.getElementById('topPerformersList');
        
        if (!topPerformers || topPerformers.length === 0) {
            container.innerHTML = '<div class="text-center text-muted">No performance data available</div>';
            return;
        }
        
        let html = '';
        topPerformers.slice(0, 5).forEach((performer, index) => {
            const medalEmoji = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`;
            html += `
                <div class="performer-item ${index < 3 ? 'top-three' : ''}">
                    <span class="performer-rank">${medalEmoji}</span>
                    <div class="performer-info">
                        <div class="performer-name">${performer.name}</div>
                        <div class="performer-details">
                            <span class="performer-score">${performer.score} pts</span>
                            <span class="performer-weekly">+${performer.weekly_points || 0} this week</span>
                        </div>
                    </div>
                    <div class="performer-role">${performer.role}</div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    updateVotingTrendChart(votingData) {
        const ctx = document.getElementById('votingTrendChart').getContext('2d');
        
        if (this.charts.votingChart) {
            this.charts.votingChart.destroy();
        }
        
        if (!votingData || votingData.length === 0) {
            ctx.font = '16px Arial';
            ctx.fillStyle = '#888';
            ctx.textAlign = 'center';
            ctx.fillText('No voting data available', ctx.canvas.width / 2, ctx.canvas.height / 2);
            return;
        }
        
        // Group by date and sum participants
        const groupedData = votingData.reduce((acc, item) => {
            const date = item.date;
            if (!acc[date]) {
                acc[date] = { date, participants: 0, total_votes: 0 };
            }
            acc[date].participants += item.participants || 0;
            acc[date].total_votes += item.total_votes || 0;
            return acc;
        }, {});
        
        const sortedData = Object.values(groupedData).sort((a, b) => new Date(a.date) - new Date(b.date));
        
        const labels = sortedData.map(item => 
            new Date(item.date).toLocaleDateString('en-US', {month: 'short', day: 'numeric'})
        );
        const participants = sortedData.map(item => item.participants);
        
        this.charts.votingChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Voting Participants',
                    data: participants,
                    backgroundColor: 'var(--neon-blue)',
                    borderColor: 'var(--diamond-white)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: { color: '#fff' }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#fff' },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    },
                    y: {
                        ticks: { color: '#fff' },
                        grid: { color: 'rgba(255,255,255,0.1)' },
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    async loadMiniGamesPreview() {
        try {
            const response = await fetch(`/api/analytics/minigames?days=${this.currentPeriod}`);
            const data = await response.json();
            
            if (data.success && data.analytics.popular_games) {
                this.updateMiniGamesPreview(data.analytics.popular_games);
            }
        } catch (error) {
            console.error('Error loading minigames preview:', error);
        }
    }
    
    updateMiniGamesPreview(gamesData) {
        const container = document.getElementById('miniGamesPreview');
        
        if (!gamesData || gamesData.length === 0) {
            container.innerHTML = '<div class="col-12 text-center text-muted">No minigame data available</div>';
            return;
        }
        
        let html = '';
        gamesData.slice(0, 4).forEach(game => {
            const gameEmoji = this.getGameEmoji(game.game_type);
            html += `
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="minigame-card">
                        <div class="minigame-icon">${gameEmoji}</div>
                        <div class="minigame-name">${game.game_type}</div>
                        <div class="minigame-stats">
                            <div class="stat">
                                <span class="stat-value">${game.total_plays}</span>
                                <span class="stat-label">Plays</span>
                            </div>
                            <div class="stat">
                                <span class="stat-value">${game.win_rate}%</span>
                                <span class="stat-label">Win Rate</span>
                            </div>
                            <div class="stat">
                                <span class="stat-value">$${parseFloat(game.total_payout_value || 0).toFixed(0)}</span>
                                <span class="stat-label">Payouts</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    getGameEmoji(gameType) {
        const emojis = {
            'slot': 'üé∞',
            'scratch': 'üé´',
            'roulette': 'üéØ',
            'dice': 'üé≤',
            'wheel': 'üé°'
        };
        return emojis[gameType.toLowerCase()] || 'üéÆ';
    }
    
    showError(message) {
        // Create a temporary error message
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger alert-dismissible fade show';
        errorDiv.innerHTML = `
            <strong>Analytics Error:</strong> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        const dashboard = document.querySelector('.analytics-dashboard');
        dashboard.insertBefore(errorDiv, dashboard.firstChild);
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
            if (errorDiv.parentNode) {
                errorDiv.remove();
            }
        }, 5000);
    }
}

// Initialize analytics dashboard when page loads
document.addEventListener('DOMContentLoaded', function() {
    if (document.querySelector('.analytics-dashboard')) {
        const analyticsDashboard = new VegasAnalyticsDashboard();
        
        // Make it globally accessible for debugging
        window.vegasAnalytics = analyticsDashboard;
    }
});
</script>
{% endblock %}
