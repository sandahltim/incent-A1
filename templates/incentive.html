{% extends "base.html" %}
{% import "macros.html" as macros %}
{# incentive.html #}
{# Version: 1.2.30 #}
{# Note: Fixed Quick Adjust Form rendering to ensure username and password fields are only shown when is_admin is false, using session.admin_id check. Updated total_pot to use default 0.0 for safety. Ensured dynamic role_key_map usage. Retained all functionality from version 1.2.29. Compatible with app.py (1.2.86), forms.py (1.2.9), config.py (1.2.6), admin_manage.html (1.2.33), quick_adjust.html (1.2.11), script.js (1.2.66), style.css (1.2.17), base.html (1.2.21), macros.html (1.2.10), start_voting.html (1.2.7), settings.html (1.2.6), admin_login.html (1.2.5), incentive_service.py (1.2.22), history.html (1.2.6), error.html, init_db.py (1.2.4). #}

{% block content %}

    {% for message in get_flashed_messages(with_categories=true) %}
        <div class="alert alert-{{ message[0] }} alert-dismissible fade show" role="alert">
            {{ message[1] }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endfor %}

    <h1>A1 Rent-It Incentive Program</h1>

    <div class="container">
        {% if not session.admin_id %}
            <p><a href="{{ url_for('admin') }}">Admin Login</a></p>
        {% else %}
            {% if not voting_active %}
                <p><a href="{{ url_for('start_voting') }}">Start Voting Session</a></p>
            {% endif %}
        {% endif %}
    </div>

    <div class="container">
        <h2>Scoreboard (Total Pot: ${{ '%.2f' % (total_pot|default(0.0)) }})</h2>
        <table class="table" id="scoreboard">
            <thead>
                <tr>
                    <th>Employee ID</th>
                    <th>Name</th>
                    <th>Score</th>
                    <th>Role</th>
                    <th>Payout</th>
                </tr>
            </thead>
            <tbody>
                {% for employee in scoreboard %}
                    {% set role_key = role_key_map.get(employee.role|capitalize, employee.role.lower().replace(' ', '_')) %}
                    <tr>
                        <td>{{ employee.employee_id }}</td>
                        <td>{{ employee.name }}</td>
                        <td>{{ employee.score }}</td>
                        <td>{{ employee.role|capitalize }}</td>
                        <td>${{ '%.2f' % (employee.score * pot_info[role_key + '_point_value'] if employee.score >= 50 else 0) }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="container">
        <div class="row">
            <div class="col-md-6">
                <h3>Positive Rules</h3>
                <ul class="list-group">
                    {% for rule in rules if rule.points > 0 %}
                        <li class="list-group-item">
                            <a href="#" class="rule-link quick-adjust-link" data-points="{{ rule.points }}" data-reason="{{ rule.description }}" {% if rule.details|length > 0 %}data-bs-toggle="tooltip" data-bs-title="{{ rule.details }}"{% endif %}>
                                {{ rule.description }} (+{{ rule.points }})
                            </a>
                        </li>
                    {% endfor %}
                </ul>
            </div>
            <div class="col-md-6">
                <h3>Negative Rules</h3>
                <ul class="list-group">
                    {% for rule in rules if rule.points < 0 %}
                        <li class="list-group-item">
                            <a href="#" class="rule-link quick-adjust-link" data-points="{{ rule.points }}" data-reason="{{ rule.description }}" {% if rule.details|length > 0 %}data-bs-toggle="tooltip" data-bs-title="{{ rule.details }}"{% endif %}>
                                {{ rule.description }} ({{ rule.points }})
                            </a>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>

    <div class="container">
        {% for role in roles %}
            {% set key_prefix = role_key_map.get(role.role_name, role.role_name.lower().replace(' ', '_')) %}
            <div class="pot-container">
                <h3>{{ role.role_name }} Pot</h3>
                <p>{{ role.role_name }} Pot: ${{ '%.2f' % pot_info[key_prefix + '_pot'] }}</p>
                <p>{{ role.role_name }} Point Value: ${{ '%.2f' % pot_info[key_prefix + '_point_value'] }}</p>
            </div>
        {% endfor %}
    </div>

    {% if voting_active %}
        <div class="container">
            <h2>Vote</h2>
            <div id="voteInitialsForm">
                {{ macros.render_field(name='voterInitials', id='voterInitials', label_text='Enter Your Initials', class='form-control') }}
                <button type="button" id="checkInitialsBtn" class="btn btn-primary">Submit Initials</button>
            </div>
            <form id="voteForm" style="display: none;" method="POST" action="/vote">
                {{ vote_form.csrf_token(id='vote_csrf_token') }}
                <table class="table" id="voteTable">
                    <thead>
                        <tr>
                            <th>Employee</th>
                            <th>Role</th>
                            <th>Score</th>
                            <th>-1</th>
                            <th>0</th>
                            <th>+1</th>
                        </tr>
                    </thead>
                    <tbody id="voteTableBody">
                        {% for employee in scoreboard %}
                            <tr>
                                <td>{{ employee.name }}</td>
                                <td>{{ employee.role|capitalize }}</td>
                                <td>{{ employee.score }}</td>
                                <td><input type="radio" name="vote_{{ employee.employee_id }}" value="-1"></td>
                                <td><input type="radio" name="vote_{{ employee.employee_id }}" value="0" checked></td>
                                <td><input type="radio" name="vote_{{ employee.employee_id }}" value="1"></td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {{ macros.render_submit_button('Cast Vote') }}
            </form>
        </div>
    {% endif %}

    <div class="container">
        <h2>Voting Results for {{ current_month }}</h2>
        <form method="GET" action="{{ url_for('show_incentive') }}">
            {{ macros.render_select_field(name='week', id='week', label_text='Select Week', options=week_options, selected_value=selected_week) }}
        </form>
        {{ macros.render_voting_results(voting_results, session.admin_id is defined) }}
    </div>

    {% if session.admin_id and unread_feedback > 0 %}
        <div class="container">
            <h2>Feedback</h2>
            <p>Unread Feedback: {{ unread_feedback }}</p>
            <p><a href="{{ url_for('admin') }}">View All Feedback</a></p>
        </div>
    {% endif %}

    <div class="container">
        <h2>Submit Feedback</h2>
        <form id="feedbackForm" method="POST" action="/submit_feedback">
            {{ feedback_form.csrf_token(id='feedback_csrf_token') }}
            {% if not session.admin_id %}
                {{ macros.render_field(name=feedback_form.initials.name, id='feedback_initials', label_text='Your Initials', class='form-control') }}
            {% endif %}
            {{ macros.render_field(name=feedback_form.comment.name, id='feedback_comment', label_text='Feedback Comment', class='form-control', type='textarea') }}
            {{ macros.render_submit_button('Submit Feedback') }}
        </form>
    </div>

    <div class="container">
        <div class="modal fade" id="quickAdjustModal" tabindex="-1" aria-labelledby="quickAdjustModalLabel" aria-hidden="true" inert>
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="quickAdjustModalLabel">Quick Adjust Points</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="adjustPointsForm" method="POST" action="/admin/quick_adjust_points">
                            {{ adjust_form.csrf_token(id='adjust_csrf_token') }}
                            {% if not session.admin_id %}
                                {{ macros.render_field(name='username', id='quick_adjust_username', label_text='Admin Username', class='form-control', required=True) }}
                                {{ macros.render_field(name='password', id='quick_adjust_password', label_text='Admin Password', class='form-control', type='password', required=True) }}
                            {% endif %}
                            {{ macros.render_select_field(name=adjust_form.employee_id.name, id='quick_adjust_employee_id', label_text='Employee', options=employee_options) }}
                            {{ macros.render_field(name=adjust_form.points.name, id='quick_adjust_points', label_text='Points', class='form-control', type='number', required=True) }}
                            {{ macros.render_field(name=adjust_form.reason.name, id='quick_adjust_reason', label_text='Reason', class='form-control', required=True) }}
                            {{ macros.render_field(name=adjust_form.notes.name, id='quick_adjust_notes', label_text='Notes (Optional)', class='form-control') }}
                            {{ macros.render_submit_button('Adjust Points') }}
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <p><a href="{{ url_for('history') }}">View Score History</a></p>
    </div>

{% endblock %}