{# incentive.html #}
{# Version: 1.2.17 #}
{# Note: Fixed UndefinedError by using role_key_map consistently in pot container loop for 'warehouse labor_pot'. Added Start Voting button for admins when voting_active is False, linking to /start_voting. Moved Quick Adjust Points section below scoreboard and before pot container. Removed feedback table, added unread feedback notice for admins linking to /admin. Added admin login link for non-admin users. Fixed TypeError by removing is_admin parameter from render_feedback_table macro call in prior versions. Fixed TemplateSyntaxError by using precomputed week_options from app.py. Ensured compatibility with macros.html (version 1.2.5), base.html (version 1.2.11), script.js (version 1.2.22), style.css (version 1.2.7), and app.py (version 1.2.32). No changes to core functionality (scoreboard, voting, feedback submission). #}

{% extends "base.html" %}
{% import "macros.html" as macros %}
{% block content %}
<div class="container">
    {% for message in get_flashed_messages(with_categories=true) %}
        <div class="alert alert-{{ message[0] }} alert-dismissible fade show" role="alert">
            {{ message[1] }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endfor %}
    <h1>A1 Rent-It Incentive Program</h1>

    {% if not is_admin %}
        <p><a href="{{ url_for('admin') }}">Admin Login</a></p>
    {% else %}
        {% if not voting_active %}
            <p><a href="{{ url_for('start_voting') }}" class="btn btn-primary">Start Voting Session</a></p>
        {% endif %}
    {% endif %}
    <h2>Scoreboard (Total Pot: ${{ '%.2f' % (pot_info.driver_pot + pot_info.laborer_pot + pot_info.supervisor_pot + pot_info['warehouse labor_pot'] + pot_info.warehouse_pot) }})</h2>
    <table id="scoreboard" class="table table-striped">
        <thead>
            <tr>
                <th>Employee ID</th>
                <th>Name</th>
                <th>Score</th>
                <th>Role</th>
                <th>Payout</th>
            </tr>
        </thead>
        <tbody>
            {% for employee in scoreboard %}
                <tr class="{{ get_score_class(employee.score) }}">
                    <td>{{ employee.employee_id }}</td>
                    <td>{{ employee.name }}</td>
                    <td>{{ employee.score }}</td>
                    <td>{{ employee.role|capitalize }}</td>
                    <td>${{ '%.2f' % (employee.score * pot_info[employee.role.lower().replace(' ', '_') + '_point_value'] if employee.score >= 50 else 0) }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
    <h2>Quick Adjust Points</h2>
    <div class="rules-container">
        <div class="rules-column">
            <h3>Positive Rules</h3>
            <ul>
                {% for rule in rules if rule.points > 0 %}
                    <li><a class="quick-adjust-link" href="#" data-points="{{ rule.points }}" data-reason="{{ rule.description }}">{{ rule.description }} (+{{ rule.points }})</a></li>
                {% endfor %}
            </ul>
        </div>
        <div class="rules-column">
            <h3>Negative Rules</h3>
            <ul>
                {% for rule in rules if rule.points < 0 %}
                    <li><a class="quick-adjust-link" href="#" data-points="{{ rule.points }}" data-reason="{{ rule.description }}">{{ rule.description }} ({{ rule.points }})</a></li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <div class="pot-container">
        {% set role_key_map = {
            'Driver': 'driver',
            'Laborer': 'laborer',
            'Supervisor': 'supervisor',
            'Warehouse Labor': 'warehouse labor',
            'Warehouse': 'warehouse'
        } %}
        {% for role in roles %}
            {% set key_prefix = role_key_map[role.role_name] %}
            <div class="pot-column">
                <h3>{{ role.role_name }} Pot</h3>
                <p id="{{ key_prefix }}_pot">{{ role.role_name }} Pot: ${{ '%.2f' % pot_info[key_prefix + '_pot'] }}</p>
                <p id="{{ key_prefix }}_point_value">{{ role.role_name }} Point Value: ${{ '%.2f' % pot_info[key_prefix + '_point_value'] }}</p>
            </div>
        {% endfor %}
    </div>

    {% if voting_active %}
        <h2>Vote</h2>
        <form id="voteInitialsForm">
            <div class="mb-3">
                {{ macros.render_field(name='voterInitials', id='voterInitials', label_text='Enter Your Initials', class='form-control') }}
                <button type="button" id="checkInitialsBtn" class="btn btn-primary">Submit Initials</button>
            </div>
        </form>
        <form id="voteForm" style="display: none;">
            <input type="hidden" name="initials" id="hiddenInitials">
            <table id="voteTable" class="table table-striped">
                <thead>
                    <tr>
                        <th>Employee</th>
                        <th>Role</th>
                        <th>Score</th>
                        <th>-1</th>
                        <th>0</th>
                        <th>+1</th>
                    </tr>
                </thead>
                <tbody id="voteTableBody">
                    {% for employee in scoreboard %}
                        <tr>
                            <td>{{ employee.name }}</td>
                            <td>{{ employee.role|capitalize }}</td>
                            <td>{{ employee.score }}</td>
                            <td><input type="radio" name="vote_{{ employee.employee_id }}" value="-1"></td>
                            <td><input type="radio" name="vote_{{ employee.employee_id }}" value="0" checked></td>
                            <td><input type="radio" name="vote_{{ employee.employee_id }}" value="1"></td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            {{ macros.render_submit_button('Cast Vote') }}
        </form>
    {% endif %}
    <h2>Voting Results for {{ current_month }}</h2>
    <form id="weekSelectForm">
        <div class="mb-3">
            {{ macros.render_select_field(name='week', id='week', label_text='Select Week', options=week_options, selected_value=selected_week) }}
        </div>
    </form>
    <table id="votingResults" class="table table-striped">
        <thead>
            <tr>
                <th>Week</th>
                <th>Employee</th>
                <th>Plus Votes</th>
                <th>Minus Votes</th>
                <th>Points</th>
            </tr>
        </thead>
        <tbody>
            {% for result in voting_results %}
                <tr>
                    <td>{{ result.week_number }}</td>
                    <td>{{ result.recipient_name }}</td>
                    <td>{{ result.plus_votes }}</td>
                    <td>{{ result.minus_votes }}</td>
                    <td>{{ result.points }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
    {% if is_admin and unread_feedback > 0 %}
        <h2>Feedback</h2>
        <p><a href="{{ url_for('admin') }}">Unread Feedback: {{ unread_feedback }}</a></p>
    {% endif %}
    <h2>Submit Feedback</h2>
    <form id="feedbackForm" method="POST" action="{{ url_for('submit_feedback') }}">
        {% if not is_admin %}
            <div class="mb-3">
                {{ macros.render_field(name='initials', id='feedback_initials', label_text='Your Initials', class='form-control') }}
            </div>
        {% endif %}
        <div class="mb-3">
            {{ macros.render_field(name='comment', id='feedback_comment', label_text='Feedback Comment', class='form-control', type='textarea') }}
        </div>
        {{ macros.render_submit_button('Submit Feedback') }}
    </form>

    <!-- Quick Adjust Modal -->
    <div class="modal fade" id="quickAdjustModal" tabindex="-1" aria-labelledby="quickAdjustModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="quickAdjustModalLabel">Quick Adjust Points</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="quickAdjustForm" method="POST" action="{{ url_for('admin_quick_adjust_points') }}">
                        {% if not is_admin %}
                            <div class="mb-3">
                                {{ macros.render_field(name='username', id='quick_adjust_username', label_text='Admin Username', class='form-control', required=True) }}
                            </div>
                            <div class="mb-3">
                                {{ macros.render_field(name='password', id='quick_adjust_password', label_text='Admin Password', class='form-control', type='password', required=True) }}
                            </div>
                        {% endif %}
                        <div class="mb-3">
                            {{ macros.render_select_field(name='employee_id', id='quick_adjust_employee_id', label_text='Employee', options=employee_options) }}
                        </div>
                        <div class="mb-3">
                            {{ macros.render_field(name='points', id='quick_adjust_points', label_text='Points (positive or negative)', class='form-control', type='number', required=True) }}
                        </div>
                        <div class="mb-3">
                            {{ macros.render_field(name='reason', id='quick_adjust_reason', label_text='Reason', class='form-control', required=True) }}
                        </div>
                        <div class="mb-3">
                            {{ macros.render_field(name='notes', id='quick_adjust_notes', label_text='Notes (Optional)', class='form-control') }}
                        </div>
                        {{ macros.render_submit_button('Adjust Points') }}
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/script.js?v={{ import_time }}"></script>
</div>
{% endblock %}