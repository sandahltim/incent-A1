{% extends "base.html" %}
{% block content %}

<h1>Inventory by Category</h1>

<form method="GET" class="mb-3 row g-2">
  <div class="col-12 col-md-2">
    <input type="text" class="form-control" name="common_name" placeholder="Filter Common Name" value="{{ filter_common_name }}" />
  </div>
  <div class="col-12 col-md-2">
    <input type="text" class="form-control" name="tag_id" placeholder="Filter Tag ID" value="{{ filter_tag_id }}" />
  </div>
  <div class="col-12 col-md-2">
    <input type="text" class="form-control" name="bin_location" placeholder="Filter Bin Location" value="{{ filter_bin_location }}" />
  </div>
  <div class="col-12 col-md-2">
    <input type="text" class="form-control" name="last_contract_num" placeholder="Filter Last Contract" value="{{ filter_last_contract }}" />
  </div>
  <div class="col-12 col-md-2">
    <input type="text" class="form-control" name="status" placeholder="Filter Status" value="{{ filter_status }}" />
  </div>
  <div class="col-12 col-md-2">
    <button type="submit" class="btn btn-primary">Apply Filters</button>
  </div>
</form>

<div class="table-container">
  <table class="table table-striped table-bordered" id="parentTable">
    <thead>
      <tr>
        <th style="width: 50px;"></th>
        <th class="sortable" data-col-name="category">Category</th>
        <th class="sortable" data-col-name="total">Total Items</th>
        <th class="sortable" data-col-name="available">Items Available</th>
        <th class="sortable" data-col-name="on_rent">Items On Rent</th>
        <th class="sortable" data-col-name="service">Service</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="parentTableBody">
      {% for parent in parent_data %}
      {% set cat_key = parent.category|lower|replace(' ', '_') %}
      <tr class="table-active" data-client-name="{{ parent.client_name }}" data-scan-date="{{ parent.scan_date }}">
        <td><span class="expand-toggle" data-bs-toggle="collapse" data-bs-target="#child-{{ cat_key }}">+</span></td>
        <td>{{ parent.category }}</td>
        <td>{{ parent.total }}</td>
        <td>{{ parent.available }}</td>
        <td>{{ parent.on_rent }}</td>
        <td>{{ parent.service }}</td>
        <td><button class="btn btn-sm btn-primary print-btn" data-level="parent" data-category="{{ parent.category }}">Print</button></td>
      </tr>
      <tr>
        <td colspan="7" class="p-0">
          <div id="child-{{ cat_key }}" class="collapse child" data-category="{{ parent.category }}" {% if expand_category == parent.category %}data-auto-expand="true"{% endif %}>
            <div class="mb-2 mx-2">
              <select class="form-select subcategory-dropdown" data-category="{{ parent.category }}">
                {% for subcat in sub_map[parent.category].subcategories.keys() %}
                <option value="{{ subcat }}">{{ subcat }}</option>
                {% endfor %}
              </select>
            </div>
            <div id="loading-{{ cat_key }}" class="text-center my-2" style="display: none;">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
            <nav aria-label="Common Name navigation" class="mb-2 mx-2" id="pagination-{{ cat_key }}">
              <ul class="pagination pagination-sm justify-content-center flex-wrap"></ul>
            </nav>
            <div class="common-table-container">
              <table class="table mb-0 common-table" id="commonTable-{{ cat_key }}">
                <thead>
                  <tr>
                    <th style="width: 50px;"></th>
                    <th class="sortable" data-col-name="common_name">Common Name</th>
                    <th class="sortable" data-col-name="total">Total Items</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="commonTbody-{{ cat_key }}"></tbody>
              </table>
            </div>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
function sortTable(tableEl, colName, forceAsc = false) {
  let tbody = tableEl.querySelector("tbody");
  if (!tbody) return;

  let asc = forceAsc || (tableEl.getAttribute("data-sort-col") === colName 
            ? tableEl.getAttribute("data-sort-dir") !== "asc" 
            : true);
  tableEl.setAttribute("data-sort-col", colName);
  tableEl.setAttribute("data-sort-dir", asc ? "asc" : "desc");

  let headers = Array.from(tableEl.querySelectorAll("th"));
  let colIndex = headers.findIndex(th => th.getAttribute("data-col-name") === colName);
  let isNumeric = ['total'].includes(colName);

  let rows = Array.from(tbody.children);
  if (tableEl.id === "parentTable") {
    let pairs = [];
    for (let i = 0; i < rows.length; i += 2) {
      let parentRow = rows[i];
      let childRow = rows[i + 1] || null;
      if (parentRow && parentRow.classList.contains("table-active")) {
        pairs.push({ parent: parentRow, child: childRow });
      }
    }
    pairs.sort((a, b) => {
      let cellA = a.parent.cells[colIndex]?.innerText.trim() || "";
      let cellB = b.parent.cells[colIndex]?.innerText.trim() || "";
      if (isNumeric) {
        let numA = parseFloat(cellA) || 0;
        let numB = parseFloat(cellB) || 0;
        return asc ? numA - numB : numB - numA;
      }
      return asc ? cellA.localeCompare(cellB, undefined, { sensitivity: 'base' }) : 
                  cellB.localeCompare(cellA, undefined, { sensitivity: 'base' });
    });
    tbody.innerHTML = "";
    pairs.forEach(pair => {
      tbody.appendChild(pair.parent);
      if (pair.child) tbody.appendChild(pair.child);
    });
  } else {
    rows.sort((a, b) => {
      let cellA = a.cells[colIndex]?.innerText.trim() || "";
      let cellB = b.cells[colIndex]?.innerText.trim() || "";
      if (isNumeric) {
        let numA = parseFloat(cellA) || 0;
        let numB = parseFloat(cellB) || 0;
        return asc ? numA - numB : numB - numA;
      }
      return asc ? cellA.localeCompare(cellB, undefined, { sensitivity: 'base' }) : 
                  cellB.localeCompare(cellA, undefined, { sensitivity: 'base' });
    });
    tbody.innerHTML = "";
    rows.forEach(row => tbody.appendChild(row));
  }
}

function loadSubcatData(category, subcat, page, catKey) {
  console.log(`Loading: Category: ${category}, Subcat: ${subcat}, Page: ${page}, CatKey: ${catKey}`);
  const loading = document.getElementById(`loading-${catKey}`);
  loading.style.display = 'block';

  const urlParams = new URLSearchParams(window.location.search);
  const params = {
    category: category,
    subcat: subcat,
    page: page,
    common_name: urlParams.get('common_name') || '',
    tag_id: urlParams.get('tag_id') || '',
    bin_location: urlParams.get('bin_location') || '',
    last_contract_num: urlParams.get('last_contract_num') || '',
    status: urlParams.get('status') || ''
  };
  const url = `/tab2/subcat_data?${new URLSearchParams(params).toString()}`;
  console.log(`Fetching URL: ${url}`);

  fetch(url)
    .then(response => {
      console.log(`Response Status: ${response.status}`);
      if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
      return response.json();
    })
    .then(data => {
      console.log('AJAX Response:', data);
      const tbody = document.getElementById(`commonTbody-${catKey}`);
      if (!tbody) {
        console.error(`Tbody not found for CatKey: ${catKey}`);
        alert("Error: Table body not found!");
        return;
      }
      tbody.innerHTML = '';
      data.common_names.forEach(cn => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><span class="expand-toggle" data-bs-toggle="collapse" data-bs-target="#items-${catKey}-${cn.common_name.replace(/[^a-zA-Z0-9]/g, '_')}">+</span></td>
          <td>${cn.common_name}</td>
          <td>${cn.total}</td>
          <td><button class="btn btn-sm btn-primary print-btn" data-level="common" data-category="${category}" data-subcat="${subcat}" data-common-name="${cn.common_name}">Print</button></td>
        `;
        const itemRow = document.createElement('tr');
        itemRow.innerHTML = `
          <td colspan="4" class="p-0">
            <div id="items-${catKey}-${cn.common_name.replace(/[^a-zA-Z0-9]/g, '_')}" class="collapse items" data-category="${category}" data-subcat="${subcat}" data-common-name="${cn.common_name}">
              <div id="items-loading-${catKey}-${cn.common_name.replace(/[^a-zA-Z0-9]/g, '_')}" class="text-center my-2" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </div>
              <nav aria-label="Item navigation" class="mb-2 mx-2" id="items-pagination-${catKey}-${cn.common_name.replace(/[^a-zA-Z0-9]/g, '_')}">
                <ul class="pagination pagination-sm justify-content-center flex-wrap"></ul>
              </nav>
              <div class="item-table-container">
                <table class="table mb-0 item-table" id="itemTable-${catKey}-${cn.common_name.replace(/[^a-zA-Z0-9]/g, '_')}">
                  <thead>
                    <tr>
                      <th class="sortable" data-col-name="tag_id">Tag ID</th>
                      <th class="sortable" data-col-name="common_name">Common Name</th>
                      <th class="sortable" data-col-name="status">Status</th>
                      <th class="sortable" data-col-name="bin_location">Bin Location</th>
                      <th class="sortable" data-col-name="quality">Quality</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="itemTbody-${catKey}-${cn.common_name.replace(/[^a-zA-Z0-9]/g, '_')}"></tbody>
                </table>
              </div>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
        tbody.appendChild(itemRow);
      });

      const pagination = document.getElementById(`pagination-${catKey}`).querySelector('.pagination');
      pagination.innerHTML = '';
      if (data.total_pages > 1) {
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${data.current_page === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" data-page="${data.current_page - 1}" aria-label="Previous"><span aria-hidden="true">« Prev</span></a>`;
        pagination.appendChild(prevLi);

        for (let p = 1; p <= data.total_pages; p++) {
          const li = document.createElement('li');
          li.className = `page-item ${p === data.current_page ? 'active' : ''}`;
          li.innerHTML = `<a class="page-link" href="#" data-page="${p}">${p}</a>`;
          pagination.appendChild(li);
        }

        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${data.current_page === data.total_pages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" data-page="${data.current_page + 1}" aria-label="Next"><span aria-hidden="true">Next »</span></a>`;
        pagination.appendChild(nextLi);

        pagination.querySelectorAll('.page-link').forEach(link => {
          link.addEventListener('click', (e) => {
            e.preventDefault();
            const newPage = parseInt(link.getAttribute('data-page'));
            if (!isNaN(newPage)) {
              loadSubcatData(category, subcat, newPage, catKey);
            }
          });
        });
      }
      loading.style.display = 'none';

      document.querySelectorAll(`#commonTable-${catKey} .expand-toggle`).forEach(toggle => {
        toggle.addEventListener('click', () => {
          const targetId = toggle.getAttribute('data-bs-target');
          const target = document.querySelector(targetId);
          if (target.classList.contains('show')) {
            toggle.textContent = '+';
          } else {
            toggle.textContent = '-';
            const commonName = target.getAttribute('data-common-name');
            loadItemData(category, subcat, commonName, 1, catKey);
          }
        });
      });

      const commonTable = document.getElementById(`commonTable-${catKey}`);
      if (commonTable) {
        sortTable(commonTable, 'common_name', true);
      }
    })
    .catch(error => {
      console.error('Error loading subcat data:', error);
      alert('Failed to load subcategory data: ' + error.message);
      loading.style.display = 'none';
    });
}

function loadItemData(category, subcat, commonName, page, catKey) {
  console.log(`Loading Items: Category: ${category}, Subcat: ${subcat}, Common Name: ${commonName}, Page: ${page}, CatKey: ${catKey}`);
  const loading = document.getElementById(`items-loading-${catKey}-${commonName.replace(/[^a-zA-Z0-9]/g, '_')}`);
  loading.style.display = 'block';

  const urlParams = new URLSearchParams(window.location.search);
  const params = {
    category: category,
    subcat: subcat,
    common_name: commonName,
    page: page,
    tag_id: urlParams.get('tag_id') || '',
    bin_location: urlParams.get('bin_location') || '',
    last_contract_num: urlParams.get('last_contract_num') || '',
    status: urlParams.get('status') || ''
  };
  const url = `/tab2/item_data?${new URLSearchParams(params).toString()}`;
  console.log(`Fetching URL: ${url}`);

  fetch(url)
    .then(response => {
      console.log(`Response Status: ${response.status}`);
      if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
      return response.json();
    })
    .then(data => {
      console.log('Item AJAX Response:', data);
      const tbody = document.getElementById(`itemTbody-${catKey}-${commonName.replace(/[^a-zA-Z0-9]/g, '_')}`);
      if (!tbody) {
        console.error(`Item Tbody not found for CatKey: ${catKey}, Common Name: ${commonName}`);
        alert("Error: Item table body not found!");
        return;
      }
      tbody.innerHTML = '';
      data.items.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.tag_id}</td>
          <td>${item.common_name}</td>
          <td>${item.status}</td>
          <td>${item.bin_location}</td>
          <td>${item.quality}</td>
          <td><button class="btn btn-sm btn-primary print-btn" data-level="child" data-category="${category}" data-subcat="${subcat}" data-tag-id="${item.tag_id}" data-common-name="${commonName}">Print</button></td>
        `;
        tbody.appendChild(tr);
      });

      const pagination = document.getElementById(`items-pagination-${catKey}-${commonName.replace(/[^a-zA-Z0-9]/g, '_')}`).querySelector('.pagination');
      pagination.innerHTML = '';
      if (data.total_pages > 1) {
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${data.current_page === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" data-page="${data.current_page - 1}" aria-label="Previous"><span aria-hidden="true">« Prev</span></a>`;
        pagination.appendChild(prevLi);

        for (let p = 1; p <= data.total_pages; p++) {
          const li = document.createElement('li');
          li.className = `page-item ${p === data.current_page ? 'active' : ''}`;
          li.innerHTML = `<a class="page-link" href="#" data-page="${p}">${p}</a>`;
          pagination.appendChild(li);
        }

        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${data.current_page === data.total_pages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" data-page="${data.current_page + 1}" aria-label="Next"><span aria-hidden="true">Next »</span></a>`;
        pagination.appendChild(nextLi);

        pagination.querySelectorAll('.page-link').forEach(link => {
          link.addEventListener('click', (e) => {
            e.preventDefault();
            const newPage = parseInt(link.getAttribute('data-page'));
            if (!isNaN(newPage)) {
              loadItemData(category, subcat, commonName, newPage, catKey);
            }
          });
        });
      }
      loading.style.display = 'none';
    })
    .catch(error => {
      console.error('Error loading item data:', error);
      alert('Failed to load item data: ' + error.message);
      loading.style.display = 'none';
    });
}

function updateWithNewData(newData) {
  console.log("Updating Tab 2 with new data:", newData);
  const urlParams = new URLSearchParams(window.location.search);
  const filters = {
    common_name: urlParams.get('common_name')?.toLowerCase() || '',
    tag_id: urlParams.get('tag_id')?.toLowerCase() || '',
    bin_location: urlParams.get('bin_location')?.toLowerCase() || '',
    last_contract_num: urlParams.get('last_contract_num')?.toLowerCase() || '',
    status: urlParams.get('status')?.toLowerCase() || ''
  };

  // Update parent table
  const parentRows = document.querySelectorAll('#parentTableBody tr.table-active');
  const categoryTotals = {};
  newData.items.forEach(item => {
    const cat = categorize_item(item.rental_class_num);
    if (!categoryTotals[cat]) categoryTotals[cat] = { total: 0, available: 0, on_rent: 0, service: 0 };
    categoryTotals[cat].total++;
    if (item.status === "Ready to Rent") categoryTotals[cat].available++;
    else if (["On Rent", "Delivered"].includes(item.status)) categoryTotals[cat].on_rent++;
    else categoryTotals[cat].service++;
  });

  parentRows.forEach(row => {
    const category = row.cells[1].innerText;
    if (categoryTotals[category]) {
      const totals = categoryTotals[category];
      row.cells[2].innerText = parseInt(row.cells[2].innerText) + totals.total; // Total
      row.cells[3].innerText = parseInt(row.cells[3].innerText) + totals.available; // Available
      row.cells[4].innerText = parseInt(row.cells[4].innerText) + totals.on_rent; // On Rent
      row.cells[5].innerText = parseInt(row.cells[5].innerText) + totals.service; // Service
    }
  });

  // Update open subcats and items
  document.querySelectorAll('.collapse.show').forEach(collapse => {
    if (collapse.classList.contains('child')) {
      const category = collapse.getAttribute("data-category");
      const catKey = category.toLowerCase().replace(/ /g, '_');
      const select = collapse.querySelector(".subcategory-dropdown");
      const subcat = select.value;
      const filteredItems = newData.items.filter(item => 
        categorize_item(item.rental_class_num) === category &&
        subcategorize_item(category, item.rental_class_num) === subcat &&
        (!filters.common_name || item.common_name.toLowerCase().includes(filters.common_name)) &&
        (!filters.tag_id || item.tag_id.toLowerCase().includes(filters.tag_id)) &&
        (!filters.bin_location || (item.bin_location || '').toLowerCase().includes(filters.bin_location)) &&
        (!filters.last_contract_num || (item.last_contract_num || '').toLowerCase().includes(filters.last_contract_num)) &&
        (!filters.status || (item.status || '').toLowerCase().includes(filters.status))
      );

      if (filteredItems.length > 0) {
        const tbody = document.getElementById(`commonTbody-${catKey}`);
        filteredItems.forEach(item => {
          const commonName = item.common_name;
          let row = Array.from(tbody.children).find(tr => tr.cells[1].innerText === commonName);
          if (!row) {
            row = document.createElement('tr');
            row.innerHTML = `
              <td><span class="expand-toggle" data-bs-toggle="collapse" data-bs-target="#items-${catKey}-${commonName.replace(/[^a-zA-Z0-9]/g, '_')}">+</span></td>
              <td>${commonName}</td>
              <td>0</td>
              <td><button class="btn btn-sm btn-primary print-btn" data-level="common" data-category="${category}" data-subcat="${subcat}" data-common-name="${commonName}">Print</button></td>
            `;
            const itemRow = document.createElement('tr');
            itemRow.innerHTML = `
              <td colspan="4" class="p-0">
                <div id="items-${catKey}-${commonName.replace(/[^a-zA-Z0-9]/g, '_')}" class="collapse items" data-category="${category}" data-subcat="${subcat}" data-common-name="${commonName}">
                  <div id="items-loading-${catKey}-${commonName.replace(/[^a-zA-Z0-9]/g, '_')}" class="text-center my-2" style="display: none;">
                    <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
                  </div>
                  <nav aria-label="Item navigation" class="mb-2 mx-2" id="items-pagination-${catKey}-${commonName.replace(/[^a-zA-Z0-9]/g, '_')}">
                    <ul class="pagination pagination-sm justify-content-center flex-wrap"></ul>
                  </nav>
                  <div class="item-table-container">
                    <table class="table mb-0 item-table" id="itemTable-${catKey}-${commonName.replace(/[^a-zA-Z0-9]/g, '_')}">
                      <thead>
                        <tr>
                          <th class="sortable" data-col-name="tag_id">Tag ID</th>
                          <th class="sortable" data-col-name="common_name">Common Name</th>
                          <th class="sortable" data-col-name="status">Status</th>
                          <th class="sortable" data-col-name="bin_location">Bin Location</th>
                          <th class="sortable" data-col-name="quality">Quality</th>
                          <th>Actions</th>
                        </tr>
                      </thead>
                      <tbody id="itemTbody-${catKey}-${commonName.replace(/[^a-zA-Z0-9]/g, '_')}"></tbody>
                    </table>
                  </div>
                </div>
              </td>
            `;
            tbody.appendChild(row);
            tbody.appendChild(itemRow);
            document.querySelector(`#commonTable-${catKey} .expand-toggle[data-bs-target="#items-${catKey}-${commonName.replace(/[^a-zA-Z0-9]/g, '_')}"]`).addEventListener('click', () => {
              const target = document.querySelector(`#items-${catKey}-${commonName.replace(/[^a-zA-Z0-9]/g, '_')}`);
              if (target.classList.contains('show')) {
                target.previousElementSibling.textContent = '+';
              } else {
                target.previousElementSibling.textContent = '-';
                loadItemData(category, subcat, commonName, 1, catKey);
              }
            });
          }
          const totalCell = row.cells[2];
          totalCell.innerText = parseInt(totalCell.innerText) + 1;
        });
        sortTable(document.getElementById(`commonTable-${catKey}`), 'common_name', true);
      }
    } else if (collapse.classList.contains('items')) {
      const category = collapse.getAttribute("data-category");
      const subcat = collapse.getAttribute("data-subcat");
      const commonName = collapse.getAttribute("data-common-name");
      const catKey = category.toLowerCase().replace(/ /g, '_');
      const filteredItems = newData.items.filter(item => 
        categorize_item(item.rental_class_num) === category &&
        subcategorize_item(category, item.rental_class_num) === subcat &&
        item.common_name === commonName &&
        (!filters.common_name || item.common_name.toLowerCase().includes(filters.common_name)) &&
        (!filters.tag_id || item.tag_id.toLowerCase().includes(filters.tag_id)) &&
        (!filters.bin_location || (item.bin_location || '').toLowerCase().includes(filters.bin_location)) &&
        (!filters.last_contract_num || (item.last_contract_num || '').toLowerCase().includes(filters.last_contract_num)) &&
        (!filters.status || (item.status || '').toLowerCase().includes(filters.status))
      );

      if (filteredItems.length > 0) {
        const tbody = document.getElementById(`itemTbody-${catKey}-${commonName.replace(/[^a-zA-Z0-9]/g, '_')}`);
        filteredItems.forEach(item => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${item.tag_id}</td>
            <td>${item.common_name}</td>
            <td>${item.status}</td>
            <td>${item.bin_location || 'N/A'}</td>
            <td>${item.quality || 'N/A'}</td>
            <td><button class="btn btn-sm btn-primary print-btn" data-level="child" data-category="${category}" data-subcat="${subcat}" data-tag-id="${item.tag_id}" data-common-name="${commonName}">Print</button></td>
          `;
          tbody.appendChild(tr);
        });
      }
    }
  });
}

function printTable(level, category, subcat, tagId) {
  if (level === 'parent') {
    const parentRow = Array.from(document.querySelectorAll('#parentTable tbody tr.table-active'))
      .find(row => row.cells[1].innerText === category);
    if (!parentRow) {
      console.error(`Parent row not found for category: ${category}`);
      return;
    }
    const clientName = parentRow.getAttribute('data-client-name') || 'N/A';
    const firstScanDate = parentRow.getAttribute('data-scan-date') || 'N/A';
    let html = `
      <html>
      <head>
        <title>Category ${category} Print</title>
        <style>
          @page { size: A4; margin: 20mm; }
          body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
          .header { display: flex; justify-content: space-between; margin-bottom: 20px; }
          .title { font-size: 18px; }
          .company { font-size: 14px; text-align: right; }
          table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
          th, td { border: 1px solid black; padding: 8px; text-align: left; }
          th { background-color: #f2f2f2; }
          .signature { margin-top: 40px; }
          .signature-line { width: 300px; border-bottom: 1px solid black; margin-bottom: 10px; }
        </style>
      </head>
      <body>
        <div class="header">
          <div class="title">Category: ${category}<br>Client Name: ${clientName}<br>Last Scan Date: ${firstScanDate}</div>
          <div class="company">Broadway Tent and Event</div>
        </div>
        <table>
          <thead>
            <tr>
              <th>Subcategory</th>
              <th>Total Items</th>
            </tr>
          </thead>
          <tbody>
    `;
    const subcategories = Object.keys(childMap[category].subcategories);
    subcategories.forEach(subcat => {
      const total = Object.values(childMap[category].subcategories[subcat].common_names).reduce((sum, cn) => sum + cn.total, 0);
      html += `
        <tr>
          <td>${subcat}</td>
          <td>${total}</td>
        </tr>
      `;
    });
    html += `
          </tbody>
        </table>
        <div class="signature">
          <div class="signature-line"></div>
          <p>Signature</p>
          <div class="signature-line"></div>
          <p>Date</p>
        </div>
      </body>
      </html>
    `;
    const printWindow = window.open('', '_blank');
    printWindow.document.write(html);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
  } else if (level === 'common') {
    const commonName = event.target.getAttribute('data-common-name');
    const parentRow = Array.from(document.querySelectorAll('#parentTable tbody tr.table-active'))
      .find(row => row.cells[1].innerText === category);
    if (!parentRow) {
      console.error(`Parent row not found for category: ${category}`);
      return;
    }
    const clientName = parentRow.getAttribute('data-client-name') || 'N/A';
    const catKey = category.toLowerCase().replace(/ /g, '_');
    const urlParams = new URLSearchParams(window.location.search);
    const params = {
      category: category,
      subcat: subcat,
      common_name: commonName,
      page: 1,
      tag_id: urlParams.get('tag_id') || '',
      bin_location: urlParams.get('bin_location') || '',
      last_contract_num: urlParams.get('last_contract_num') || '',
      status: urlParams.get('status') || ''
    };
    const url = `/tab2/item_data?${new URLSearchParams(params).toString()}`;
    fetch(url)
      .then(response => {
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        return response.json();
      })
      .then(data => {
        console.log('Print Item Data:', data);
        let html = `
          <html>
          <head>
            <title>${category} - ${subcat} - ${commonName} Print</title>
            <style>
              @page { size: A4; margin: 20mm; }
              body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
              .header { display: flex; justify-content: space-between; margin-bottom: 20px; }
              .title { font-size: 18px; }
              .company { font-size: 14px; text-align: right; }
              table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
              th, td { border: 1px solid black; padding: 8px; text-align: left; }
              th { background-color: #f2f2f2; }
              .signature { margin-top: 40px; }
              .signature-line { width: 300px; border-bottom: 1px solid black; margin-bottom: 10px; }
            </style>
          </head>
          <body>
            <div class="header">
              <div class="title">Category: ${category}<br>Subcategory: ${subcat}<br>Common Name: ${commonName}<br>Client Name: ${clientName}</div>
              <div class="company">Broadway Tent and Event</div>
            </div>
            <table>
              <thead>
                <tr>
                  <th>Tag ID</th>
                  <th>Common Name</th>
                  <th>Status</th>
                  <th>Bin Location</th>
                  <th>Quality</th>
                  <th>Last Contract Num</th>
                  <th>Date Last Scanned</th>
                  <th>Last Scanned By</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody>
        `;
        data.items.forEach(item => {
          html += `
            <tr>
              <td>${item.tag_id}</td>
              <td>${item.common_name}</td>
              <td>${item.status}</td>
              <td>${item.bin_location}</td>
              <td>${item.quality}</td>
              <td>${item.last_contract_num}</td>
              <td>${item.date_last_scanned}</td>
              <td>${item.last_scanned_by}</td>
              <td>${item.notes}</td>
            </tr>
          `;
        });
        html += `
              </tbody>
            </table>
            <div class="signature">
              <div class="signature-line"></div>
              <p>Signature</p>
              <div class="signature-line"></div>
              <p>Date</p>
            </div>
          </body>
          </html>
        `;
        const printWindow = window.open('', '_blank');
        printWindow.document.write(html);
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
      })
      .catch(error => console.error('Error fetching print data:', error));
  } else if (level === 'child') {
    const commonName = event.target.getAttribute('data-common-name');
    const parentRow = Array.from(document.querySelectorAll('#parentTable tbody tr.table-active'))
      .find(row => row.cells[1].innerText === category);
    if (!parentRow) {
      console.error(`Parent row not found for category: ${category}`);
      return;
    }
    const clientName = parentRow.getAttribute('data-client-name') || 'N/A';
    const catKey = category.toLowerCase().replace(/ /g, '_');
    const tbodyId = `itemTbody-${catKey}-${commonName.replace(/[^a-zA-Z0-9]/g, '_')}`;
    const tbody = document.getElementById(tbodyId);
    let items = [];

    if (!tbody || tbody.children.length === 0 || (tagId && !Array.from(tbody.children).some(row => row.cells[0].innerText === tagId))) {
      console.warn(`No item data for ${tbodyId} or tag ${tagId}, fetching synchronously...`);
      const urlParams = new URLSearchParams(window.location.search);
      const params = {
        category: category,
        subcat: subcat,
        common_name: commonName,
        page: 1,
        tag_id: urlParams.get('tag_id') || '',
        bin_location: urlParams.get('bin_location') || '',
        last_contract_num: urlParams.get('last_contract_num') || '',
        status: urlParams.get('status') || ''
      };
      const url = `/tab2/item_data?${new URLSearchParams(params).toString()}`;
      fetch(url)
        .then(response => {
          if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
          return response.json();
        })
        .then(data => {
          console.log('Child print data:', data);
          items = data.items.map(item => ({
            tag_id: item.tag_id,
            common_name: item.common_name,
            status: item.status,
            bin_location: item.bin_location,
            quality: item.quality,
            last_contract_num: item.last_contract_num,
            date_last_scanned: item.date_last_scanned,
            last_scanned_by: item.last_scanned_by,
            notes: item.notes
          }));
          if (tagId) items = items.filter(item => item.tag_id === tagId);
          printChildItems(category, subcat, clientName, items);
        })
        .catch(error => console.error('Error fetching child data for print:', error));
    } else {
      items = Array.from(tbody.children).map(row => ({
        tag_id: row.cells[0].innerText,
        common_name: row.cells[1].innerText,
        status: row.cells[2].innerText,
        bin_location: row.cells[3].innerText,
        quality: row.cells[4].innerText,
        last_contract_num: 'N/A',
        date_last_scanned: 'N/A',
        last_scanned_by: 'N/A',
        notes: 'N/A'
      }));
      if (tagId) items = items.filter(item => item.tag_id === tagId);
      printChildItems(category, subcat, clientName, items);
    }
  }
}

function printChildItems(category, subcat, clientName, items) {
  let html = `
    <html>
    <head>
      <title>${category} - ${subcat} Items</title>
      <style>
        @page { size: A4; margin: 20mm; }
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
        .header { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .title { font-size: 18px; }
        .company { font-size: 14px; text-align: right; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid black; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .signature { margin-top: 40px; }
        .signature-line { width: 300px; border-bottom: 1px solid black; margin-bottom: 10px; }
      </style>
    </head>
    <body>
      <div class="header">
        <div class="title">Category: ${category}<br>Subcategory: ${subcat}<br>Client Name: ${clientName}</div>
        <div class="company">Broadway Tent and Event</div>
      </div>
      <table>
        <thead>
          <tr>
            <th>Tag ID</th>
            <th>Common Name</th>
            <th>Status</th>
            <th>Bin Location</th>
            <th>Quality</th>
            <th>Last Contract Num</th>
            <th>Date Last Scanned</th>
            <th>Last Scanned By</th>
            <th>Notes</th>
          </tr>
        </thead>
        <tbody>
  `;
  items.forEach(item => {
    html += `
      <tr>
        <td>${item.tag_id}</td>
        <td>${item.common_name}</td>
        <td>${item.status}</td>
        <td>${item.bin_location}</td>
        <td>${item.quality}</td>
        <td>${item.last_contract_num}</td>
        <td>${item.date_last_scanned}</td>
        <td>${item.last_scanned_by}</td>
        <td>${item.notes}</td>
      </tr>
    `;
  });
  html += `
        </tbody>
      </table>
      <div class="signature">
        <div class="signature-line"></div>
        <p>Signature</p>
        <div class="signature-line"></div>
        <p>Date</p>
      </div>
    </body>
    </html>
  `;
  const printWindow = window.open('', '_blank');
  printWindow.document.write(html);
  printWindow.document.close();
  printWindow.focus();
  printWindow.print();
}

function refreshTable() {
  console.log("Auto-refreshing table at " + new Date().toLocaleTimeString());
  const expandedIds = Array.from(document.querySelectorAll('.collapse.show')).map(el => el.id);
  const urlParams = new URLSearchParams(window.location.search);
  const url = `/tab2/?${urlParams.toString()}`;

  fetch(url)
    .then(response => {
      if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
      return response.text();
    })
    .then(html => {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const newRows = doc.querySelectorAll('#parentTableBody tr.table-active');
      newRows.forEach(newRow => {
        const category = newRow.cells[1].innerText;
        const existingRow = Array.from(document.querySelectorAll('#parentTableBody tr.table-active'))
          .find(row => row.cells[1].innerText === category);
        if (existingRow) {
          existingRow.cells[2].innerText = newRow.cells[2].innerText; // Total
          existingRow.cells[3].innerText = newRow.cells[3].innerText; // Available
          existingRow.cells[4].innerText = newRow.cells[4].innerText; // On Rent
          existingRow.cells[5].innerText = newRow.cells[5].innerText; // Service
        }
      });

      expandedIds.forEach(id => {
        const element = document.getElementById(id);
        if (!element) return;
        const catKey = id.split('-')[1];
        if (element.classList.contains('child')) {
          const category = element.getAttribute("data-category");
          const select = element.querySelector(".subcategory-dropdown");
          const subcat = select.value;
          loadSubcatData(category, subcat, 1, catKey);
        } else if (element.classList.contains('items')) {
          const category = element.getAttribute("data-category");
          const subcat = element.getAttribute("data-subcat");
          const commonName = element.getAttribute("data-common-name");
          loadItemData(category, subcat, commonName, 1, catKey);
        }
      });
    })
    .catch(error => console.error('Error auto-refreshing table:', error));
}

const childMap = {{ sub_map|tojson }};
function categorize_item(rental_class_num) { return CATEGORY_MAP[parseInt(rental_class_num || 0)] || 'Other'; }
function subcategorize_item(category, rental_class_num) {
  const rid = parseInt(rental_class_num || 0);
  if (['Tent Tops', 'Tables and Chairs', 'Round Linen', 'Rectangle Linen', 'Concession Equipment', 'AV Equipment', 'Runners and Drapes', 'Other', 'Resale'].includes(category)) {
    return SUBCATEGORY_MAP[rid] || 'Unspecified Subcategory';
  }
  return 'Unspecified Subcategory';
}

document.addEventListener("DOMContentLoaded", () => {
  console.log("DOM Content Loaded");

  document.querySelectorAll(".expand-toggle").forEach(toggle => {
    let target = document.querySelector(toggle.getAttribute("data-bs-target"));
    target.addEventListener("show.bs.collapse", () => {
      console.log(`Expanding: ${target.getAttribute("data-category") || target.getAttribute("data-common-name")}`);
      toggle.textContent = "-";
      if (target.classList.contains('child')) {
        const category = target.getAttribute("data-category");
        const catKey = category.toLowerCase().replace(/ /g, '_');
        const select = target.querySelector(".subcategory-dropdown");
        const subcat = select.value;
        const subcatCount = select.options.length;
        if (subcatCount === 1) {
          loadSubcatData(category, subcat, 1, catKey);
        }
      }
    });
    target.addEventListener("hide.bs.collapse", () => {
      toggle.textContent = "+";
    });
  });

  document.querySelectorAll(".subcategory-dropdown").forEach(select => {
    select.addEventListener("change", () => {
      const category = select.getAttribute("data-category");
      const subcat = select.value;
      const catKey = category.toLowerCase().replace(/ /g, '_');
      console.log(`Dropdown changed: ${category} -> ${subcat}`);
      loadSubcatData(category, subcat, 1, catKey);
    });
  });

  document.getElementById("parentTable").addEventListener("click", function(event) {
    const target = event.target;
    if (target.classList.contains("sortable")) {
      const table = target.closest("table");
      const colName = target.getAttribute("data-col-name");
      sortTable(table, colName);
    }
    if (target.classList.contains("print-btn")) {
      const level = target.getAttribute("data-level");
      const category = target.getAttribute("data-category");
      const subcat = target.getAttribute("data-subcat");
      const tagId = target.getAttribute("data-tag-id");
      if (level === "parent") {
        printTable("parent", category);
      } else if (level === "common") {
        printTable("common", category, subcat);
      } else if (level === "child") {
        printTable("child", category, subcat, tagId);
      }
    }
  });

  document.addEventListener('newData', (e) => {
    updateWithNewData(e.detail);
  });

  let expandCat = "{{ expand_category | default('') }}";
  if (expandCat) {
    let collapse = document.querySelector(`#child-${expandCat.toLowerCase().replace(/ /g, '_')}`);
    if (collapse) {
      collapse.classList.add("show");
      let toggle = collapse.previousElementSibling.querySelector(".expand-toggle");
      if (toggle) toggle.textContent = "-";
      const category = expandCat;
      const catKey = category.toLowerCase().replace(/ /g, '_');
      const select = collapse.querySelector(".subcategory-dropdown");
      const subcat = select.value;
      const subcatCount = select.options.length;
      console.log(`Initial expand: ${category} -> ${subcat}`);
      if (subcatCount === 1) {
        loadSubcatData(category, subcat, 1, catKey);
      }
    }
  }

  document.querySelectorAll(".collapse").forEach(collapse => {
    if (!collapse.getAttribute("data-auto-expand")) {
      collapse.classList.remove("show");
    }
  });

  setInterval(refreshTable, 60000);
});
</script>

<style>
  body, html { height: 100%; overflow: auto; margin: 0; padding: 0; }
  .table-container { width: 100%; overflow-y: auto; }
  .table-container table { width: 100%; table-layout: auto; }
  .common-table-container { width: 100%; overflow-y: auto; }
  .common-table-container table { width: 100%; table-layout: auto; }
  .item-table-container { width: 100%; overflow-y: auto; }
  .item-table-container table { width: 100%; table-layout: auto; }
  .collapse { width: 100%; }
  @media (max-width: 768px) { .pagination .page-link { padding: 0.25rem 0.5rem; font-size: 0.9rem; } }
</style>

{% endblock %}